# 聊天功能前后端架构图

```mermaid
graph TB
    subgraph Client[客户端]
        Web(Web端):::client
        Mini(小程序端):::client
    end

    subgraph Gateway[Nginx / LB]
        Route(WS/HTTP路由):::infra
    end

    subgraph WS[WebSocket集群]
        Handler(WebSocketHandler):::backend
        Session(连接会话管理):::backend
    end

    subgraph Service[业务服务层]
        Auth(用户鉴权 & 频控):::backend
        MsgSvc(消息Service):::backend
        ChatSvc(会话Service):::backend
        LimitSvc(聊天限制Service):::backend
    end

    subgraph Storage[数据与缓存]
        Redis[(Redis: 在线状态/Session/消息队列)]:::storage
        MySQL[(MySQL: t_message / t_chat / t_chat_limit)]:::storage
        OSS[(OSS/COS: 图片&文件存储)]:::storage
    end

    subgraph Monitor[监控与告警]
        Metrics(连接/消息量监控):::infra
        Alert(异常告警):::infra
    end

    Web -->|HTTPS + JWT| Gateway -->|WS升级| WS --> Service
    Mini -->|HTTPS + JWT| Gateway
    Service --> Redis
    Service --> MySQL
    Service --> OSS
    WS --> Redis
    Monitor -.-> WS
    Monitor -.-> Service

    classDef client fill:#EFF6FF,stroke:#3B82F6,color:#1F2937;
    classDef backend fill:#FEF3C7,stroke:#F59E0B,color:#78350F;
    classDef storage fill:#DCFCE7,stroke:#10B981,color:#064E3B;
    classDef infra fill:#F3F4F6,stroke:#9CA3AF,color:#111827;
```

> **说明**：客户端通过 HTTPS 完成鉴权后升级为 WebSocket 长连接。WebSocket 层负责会话管理与消息路由，业务层执行消息校验、存储与限制控制，Redis/MySQL/OSS 分别承担在线状态、持久化与文件存储职责，配套监控体系保障运行稳定。

# 消息流转流程图

```mermaid
sequenceDiagram
    participant A as 用户A客户端
    participant WS as WebSocket服务器
    participant Biz as 业务Service
    participant Redis as Redis
    participant DB as MySQL
    participant B as 用户B客户端

    A->>WS: 1. WS连接 + JWT校验
    WS->>Redis: 2. 记录在线状态/Session
    A->>WS: 3. SEND_MESSAGE(content, chatId)
    WS->>Biz: 4. 分发消息 & 权限/频控校验
    Biz->>DB: 5. 落库存储(t_message)
    Biz->>DB: 6. 更新会话(t_chat未读/最后消息)
    Biz->>Redis: 7. 查询用户B在线状态
    alt 用户B在线
        WS->>B: 8a. 实时推送RECEIVE_MESSAGE
        Biz->>Redis: 9a. 同步消息状态(delivered/read)
    else 用户B离线
        Biz->>Redis: 8b. 写入离线队列/缓存
    end
    B->>WS: 10. READ回执
    WS->>Biz: 11. 更新消息已读
    Biz->>DB: 12. 更新read_status
```

> **补充**：
> - 心跳：客户端每30秒发送 `HEARTBEAT`，服务器若超时则清理连接并同步 Redis。
> - 聊天限制：Biz 层依据 `t_chat_limit` 判断是否允许发送，必要时返回限制提示。
> - 防骚扰：频控 + 敏感词过滤在步骤4完成，违规消息直接拒绝并记录。

