# 碰碰小程序前后端接口文档

## 文档信息
- **生成时间**：2025-11-01 22:00
- **接口数量**：18个
- **Base URL**：`http://localhost:8080`
- **认证方式**：Bearer Token（JWT）

---

## 接口目录

### 认证相关
1. [微信登录](#1-微信登录)

### 用户资料
2. [完善/更新资料](#2-完善更新资料)
3. [更新资料](#3-更新资料)
4. [查看我的资料](#4-查看我的资料)
5. [查看他人资料](#5-查看他人资料)
6. [查看资料完善状态](#6-查看资料完善状态)
7. [获取用户统计数据](#7-获取用户统计数据)

### 相册管理
8. [上传照片](#8-上传照片)
9. [删除照片](#9-删除照片)
10. [设置封面照片](#10-设置封面照片)

### 标签管理
11. [获取标签库](#11-获取标签库)
12. [设置我的标签](#12-设置我的标签)

### 隐私设置
13. [更新隐私设置](#13-更新隐私设置)
14. [获取隐私设置](#14-获取隐私设置)

### 黑名单管理
15. [拉黑用户](#15-拉黑用户)
16. [移除黑名单](#16-移除黑名单)

### 匹配偏好
17. [设置匹配偏好](#17-设置匹配偏好)
18. [获取匹配偏好](#18-获取匹配偏好)

---

## 1. 微信登录

### 基本信息
- **接口路径**：`POST /api/auth/wx/login`
- **接口说明**：微信小程序登录，返回用户信息和状态标识
- **是否需要认证**：否

### 请求参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| code | String | 是 | 微信登录code |

### 请求示例

**curl命令**：
```bash
curl -X POST http://localhost:8080/api/auth/wx/login \
  -H "Content-Type: application/json" \
  -d "{\"code\": \"test_code_12345\"}"
```

**请求Body**：
```json
{
  "code": "test_code_12345"
}
```

### 响应示例

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiJ9.eyJ1c2VySWQiOjEwMDF9...",
    "userId": 1001,
    "isNewUser": false,
    "nickname": "测试用户",
    "avatar": "https://example.com/avatar.jpg",
    "vipLevel": 0,
    "profileComplete": 0,
    "matchPreferenceSet": 0
  }
}
```

### 响应字段说明

| 字段名 | 类型 | 说明 |
|--------|------|------|
| token | String | JWT访问令牌 |
| userId | Long | 用户ID |
| isNewUser | Boolean | 是否新用户 |
| nickname | String | 用户昵称 |
| avatar | String | 用户头像 |
| vipLevel | Integer | 会员等级（0-普通，1-VIP，2-SVIP） |
| **profileComplete** | **Integer** | **资料是否完善（0-否，1-是）** |
| **matchPreferenceSet** | **Integer** | **匹配偏好是否设置（0-未设置，1-已设置）** |

### 业务说明

登录后根据两个标志位引导用户：

1. **profileComplete = 0**：引导用户完善资料
2. **profileComplete = 1 且 matchPreferenceSet = 0**：引导用户设置匹配偏好
3. **两者都为1**：进入主页，开始匹配

---

## 2. 完善资料

**说明**：此接口用于**首次完善资料**或后续更新资料，支持一次性提交所有字段。

### 基本信息
- **接口路径**：`POST /api/user/profile`
- **接口说明**：完善或更新用户资料（支持一次性提交所有必填字段）
- **是否需要认证**：是

### 请求头

```
Authorization: Bearer {token}
Content-Type: application/json
```

### 请求参数

#### 必填字段（完善资料时必须提供）

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| nickname | String | 是 | 昵称（最多50字） |
| avatar | String | 是 | 头像URL（最多255字） |
| gender | Integer | 是 | 性别（0-未知，1-男，2-女） |
| birthday | String | 是 | 生日（格式：YYYY-MM-DD） |
| tagIds | Array | 是 | 兴趣标签ID列表（最多10个） |

#### 可选字段（编辑资料时可补充）

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| height | Integer | 否 | 身高（cm，范围100-250） |
| weight | Integer | 否 | 体重（kg，范围30-200） |
| occupation | String | 否 | 职业（最多50字） |
| education | String | 否 | 学历（最多20字） |
| income | String | 否 | 收入（最多20字） |
| hometown | String | 否 | 家乡（最多50字） |
| currentCity | String | 否 | 现居城市（最多50字） |
| bio | String | 否 | 个人简介（最多200字） |
| maritalStatus | String | 否 | 婚姻状况（最多20字） |

### 请求示例

**curl命令**：
```bash
curl -X POST http://localhost:8080/api/user/profile \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{
    "nickname": "测试用户小雨",
    "avatar": "https://example.com/avatar.jpg",
    "gender": 2,
    "birthday": "1998-05-20",
    "tagIds": [1, 5, 8],
    "height": 165,
    "occupation": "UI设计师",
    "education": "本科",
    "currentCity": "北京市朝阳区",
    "bio": "热爱生活，喜欢摄影和旅行。"
  }'
```

**请求Body**：
```json
{
  "nickname": "测试用户小雨",
  "avatar": "https://example.com/avatar.jpg",
  "gender": 2,
  "birthday": "1998-05-20",
  "tagIds": [1, 5, 8],
  "height": 165,
  "occupation": "UI设计师",
  "education": "本科",
  "currentCity": "北京市朝阳区",
  "bio": "热爱生活，喜欢摄影和旅行。希望能找到志同道合的朋友。"
}
```

### 响应示例

```json
{
  "code": 200,
  "message": "资料保存成功",
  "data": true
}
```

### 业务说明

1. **自动更新WxUser表**：昵称、头像、性别、生日、年龄
2. **自动设置标签**：保存到`t_user_tag`表
3. **自动检查完善状态**：如果5个必填字段都填写，自动更新`profile_complete=1`
4. **性别为0（未知）不算完善**：必须选择1或2

---

## 3. 更新资料

### 基本信息
- **接口路径**：`POST /api/user/profile/update`
- **接口说明**：更新用户资料（与完善资料使用同一个service方法，参数相同）
- **是否需要认证**：是

### 请求头

```
Authorization: Bearer {token}
Content-Type: application/json
```

### 请求参数

参数与"完善资料"接口完全相同，支持部分更新。

### 请求示例

**curl命令**：
```bash
curl -X POST http://localhost:8080/api/user/profile/update \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{
    "bio": "更新后的个人简介",
    "currentCity": "深圳市南山区"
  }'
```

### 响应示例

```json
{
  "code": 200,
  "message": "资料更新成功",
  "data": true
}
```

---

## 4. 查看我的资料

### 基本信息
- **接口路径**：`GET /api/user/profile`
- **接口说明**：查看当前登录用户的完整资料
- **是否需要认证**：是

### 请求头

```
Authorization: Bearer {token}
```

### 请求示例

**curl命令**：
```bash
curl -X GET http://localhost:8080/api/user/profile \
  -H "Authorization: Bearer YOUR_TOKEN"
```

### 响应示例

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "userId": 1001,
    "nickname": "测试用户小雨",
    "avatar": "https://example.com/avatar.jpg",
    "gender": 2,
    "age": 27,
    "height": 165,
    "occupation": "UI设计师",
    "education": "本科",
    "income": null,
    "hometown": null,
    "currentCity": "北京市朝阳区",
    "bio": "热爱生活，喜欢摄影和旅行。",
    "voiceIntroUrl": null,
    "isVerified": 0,
    "verifyStatus": 0,
    "photos": [],
    "tags": [
      {
        "tagId": 1,
        "tagName": "旅游",
        "icon": "🏖️"
      },
      {
        "tagId": 5,
        "tagName": "电影",
        "icon": "🎬"
      },
      {
        "tagId": 8,
        "tagName": "读书",
        "icon": "📚"
      }
    ],
    "profileComplete": 1,
    "onlineStatus": 1,
    "lastLoginTime": "2025-11-01T21:15:00",
    "createdAt": "2025-10-28T10:00:00",
    "updatedAt": "2025-11-01T21:15:30"
  }
}
```

---

## 5. 查看他人资料

### 基本信息
- **接口路径**：`GET /api/user/profile/{userId}`
- **接口说明**：查看其他用户的资料（会根据隐私设置过滤部分信息）
- **是否需要认证**：是

### 请求头

```
Authorization: Bearer {token}
```

### 路径参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| userId | Long | 是 | 要查看的用户ID |

### 请求示例

**curl命令**：
```bash
curl -X GET http://localhost:8080/api/user/profile/1002 \
  -H "Authorization: Bearer YOUR_TOKEN"
```

### 响应示例

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "userId": 1002,
    "nickname": "李四",
    "avatar": "https://example.com/avatar2.jpg",
    "gender": 1,
    "age": 28,
    "height": 180,
    "occupation": "产品经理",
    "education": "硕士",
    "currentCity": "北京市海淀区",
    "bio": "喜欢运动和读书",
    "isVerified": 1,
    "vipLevel": 1,
    "photos": [
      {
        "id": 1,
        "photoUrl": "https://example.com/photo1.jpg",
        "isCover": 1,
        "auditStatus": 1,
        "sortOrder": 0
      }
    ],
    "tags": [
      {
        "id": 2,
        "tagName": "健身",
        "category": "运动",
        "icon": "icon-fitness"
      }
    ],
    "onlineStatus": 1,
    "lastLoginTime": "2025-11-01T20:00:00"
  }
}
```

### 业务说明

1. **隐私过滤**：根据被查看用户的隐私设置，某些信息可能不可见
2. **黑名单判断**：如果在对方黑名单中，可能返回受限信息
3. **距离显示**：根据对方的隐私设置决定是否显示距离

---

## 6. 查看资料完善状态

### 基本信息
- **接口路径**：`GET /api/user/profile/status`
- **接口说明**：查看当前用户的资料完善状态和缺失字段
- **是否需要认证**：是

### 请求头

```
Authorization: Bearer {token}
```

### 请求示例

**curl命令**：
```bash
curl -X GET http://localhost:8080/api/user/profile/status \
  -H "Authorization: Bearer YOUR_TOKEN"
```

### 响应示例

**资料未完善时**：
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "profileComplete": false,
    "completionRate": 60,
    "completedFields": 3,
    "totalFields": 5,
    "missingFields": [
      "性别",
      "兴趣标签"
    ],
    "suggestions": [
      "设置您的性别信息",
      "选择至少1个兴趣标签，让别人更了解你",
      "💡 建议：绑定手机号提高信任度",
      "💡 建议：填写身高信息"
    ]
  }
}
```

**资料已完善时**：
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "profileComplete": true,
    "completionRate": 100,
    "completedFields": 5,
    "totalFields": 5,
    "missingFields": [],
    "suggestions": [
      "💡 建议：绑定手机号提高信任度",
      "💡 建议：填写身高信息",
      "💡 建议：填写学历信息"
    ]
  }
}
```

### 响应字段说明

| 字段名 | 类型 | 说明 |
|--------|------|------|
| profileComplete | Boolean | 资料是否完善 |
| completionRate | Integer | 完善度百分比（0-100） |
| completedFields | Integer | 已完善的必填字段数量 |
| totalFields | Integer | 总必填字段数量（固定为5） |
| missingFields | Array | 缺失的必填字段列表 |
| suggestions | Array | 改进建议（包括必填和可选字段提示） |

### 必填字段说明

1. 昵称
2. 头像
3. 性别（1或2，0不算完善）
4. 年龄/生日
5. 兴趣标签（至少1个）

---

## 7. 获取用户统计数据

### 基本信息
- **接口路径**：`GET /api/user/stats`
- **接口说明**：获取用户的统计数据（关注、粉丝、匹配等）
- **是否需要认证**：是

### 请求头

```
Authorization: Bearer {token}
```

### 请求示例

**curl命令**：
```bash
curl -X GET http://localhost:8080/api/user/stats \
  -H "Authorization: Bearer YOUR_TOKEN"
```

### 响应示例

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "followingCount": 0,
    "followersCount": 0,
    "buddyMatchCount": 0,
    "activityJoinCount": 0,
    "momentCount": 0,
    "likedMeCount": 0,
    "myFavoritesCount": 0
  }
}
```

### 响应字段说明

| 字段名 | 类型 | 说明 |
|--------|------|------|
| followingCount | Integer | 关注数量 |
| followersCount | Integer | 粉丝数量 |
| buddyMatchCount | Integer | 搭子匹配数量 |
| activityJoinCount | Integer | 活动参与数量 |
| momentCount | Integer | 动态数量 |
| likedMeCount | Integer | 喜欢我的人数 |
| myFavoritesCount | Integer | 我收藏的人数 |

**注意**：当前版本暂时返回0，等相关模块开发完成后会返回真实数据。

---

## 8. 上传照片

### 基本信息
- **接口路径**：`POST /api/user/album/upload`
- **接口说明**：上传用户相册照片
- **是否需要认证**：是

### 请求头

```
Authorization: Bearer {token}
Content-Type: application/json
```

### 请求参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| photoUrl | String | 是 | 照片URL（最多255字） |
| isCover | Boolean | 否 | 是否设为封面（默认false） |

### 请求示例

**curl命令**：
```bash
curl -X POST http://localhost:8080/api/user/album/upload \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{
    "photoUrl": "https://example.com/my-photo.jpg",
    "isCover": false
  }'
```

**请求Body**：
```json
{
  "photoUrl": "https://example.com/my-photo.jpg",
  "isCover": false
}
```

### 响应示例

```json
{
  "code": 200,
  "message": "照片上传成功",
  "data": 123
}
```

### 响应字段说明

| 字段名 | 类型 | 说明 |
|--------|------|------|
| data | Long | 上传成功后的照片ID |

### 业务说明

1. **照片数量限制**：最多9张照片
2. **自动审核状态**：上传后状态为待审核（auditStatus=0）
3. **封面设置**：如果isCover=true，会自动设为封面照片
4. **排序规则**：按上传时间自动排序

---

## 9. 删除照片

### 基本信息
- **接口路径**：`DELETE /api/user/album/{photoId}`
- **接口说明**：删除指定的相册照片
- **是否需要认证**：是

### 请求头

```
Authorization: Bearer {token}
```

### 路径参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| photoId | Long | 是 | 照片ID |

### 请求示例

**curl命令**：
```bash
curl -X DELETE http://localhost:8080/api/user/album/123 \
  -H "Authorization: Bearer YOUR_TOKEN"
```

### 响应示例

```json
{
  "code": 200,
  "message": "照片删除成功",
  "data": true
}
```

### 业务说明

1. **权限验证**：只能删除自己的照片
2. **封面处理**：如果删除的是封面照片，系统会自动将第一张照片设为封面
3. **物理删除**：从数据库中物理删除记录

---

## 10. 设置封面照片

### 基本信息
- **接口路径**：`POST /api/user/album/cover/{photoId}`
- **接口说明**：将指定照片设置为封面
- **是否需要认证**：是

### 请求头

```
Authorization: Bearer {token}
```

### 路径参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| photoId | Long | 是 | 照片ID |

### 请求示例

**curl命令**：
```bash
curl -X POST http://localhost:8080/api/user/album/cover/123 \
  -H "Authorization: Bearer YOUR_TOKEN"
```

### 响应示例

```json
{
  "code": 200,
  "message": "封面设置成功",
  "data": true
}
```

### 业务说明

1. **自动取消旧封面**：设置新封面时，旧封面的isCover会自动设为0
2. **权限验证**：只能设置自己的照片
3. **状态检查**：只有审核通过的照片才能设为封面

---

## 11. 获取标签库

### 基本信息
- **接口路径**：`GET /api/user/tags`
- **接口说明**：获取系统标签库（所有可选标签）
- **是否需要认证**：否

### 请求示例

**curl命令**：
```bash
curl -X GET http://localhost:8080/api/user/tags
```

### 响应示例

```json
{
  "code": 200,
  "message": "success",
  "data": [
    {
      "id": 1,
      "tagName": "旅行",
      "category": "兴趣爱好",
      "icon": "icon-travel"
    },
    {
      "id": 2,
      "tagName": "健身",
      "category": "运动",
      "icon": "icon-fitness"
    },
    {
      "id": 3,
      "tagName": "美食",
      "category": "生活",
      "icon": "icon-food"
    },
    {
      "id": 4,
      "tagName": "音乐",
      "category": "艺术",
      "icon": "icon-music"
    },
    {
      "id": 5,
      "tagName": "电影",
      "category": "娱乐",
      "icon": "icon-movie"
    }
  ]
}
```

### 响应字段说明

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | Long | 标签ID |
| tagName | String | 标签名称 |
| category | String | 标签分类 |
| icon | String | 标签图标 |

---

## 12. 设置我的标签

### 基本信息
- **接口路径**：`POST /api/user/tags`
- **接口说明**：设置/更新当前用户的兴趣标签
- **是否需要认证**：是

### 请求头

```
Authorization: Bearer {token}
Content-Type: application/json
```

### 请求参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| tagIds | Array | 是 | 标签ID列表（最多10个） |

### 请求示例

**curl命令**：
```bash
curl -X POST http://localhost:8080/api/user/tags \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{
    "tagIds": [1, 2, 3, 5, 8]
  }'
```

**请求Body**：
```json
{
  "tagIds": [1, 2, 3, 5, 8]
}
```

### 响应示例

```json
{
  "code": 200,
  "message": "标签设置成功",
  "data": true
}
```

### 业务说明

1. **覆盖式更新**：新标签会覆盖旧标签
2. **数量限制**：最多选择10个标签
3. **必填项检查**：至少需要1个标签
4. **自动更新完善度**：设置标签后会影响资料完善状态

---

## 13. 更新隐私设置

### 基本信息
- **接口路径**：`POST /api/user/privacy`
- **接口说明**：更新用户的隐私设置
- **是否需要认证**：是

### 请求头

```
Authorization: Bearer {token}
Content-Type: application/json
```

### 请求参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| whoCanSeeMe | Integer | 否 | 谁可以看我（1-所有人，2-仅匹配的人，3-关闭） |
| showDistance | Integer | 否 | 显示距离（0-否，1-是） |
| showOnlineStatus | Integer | 否 | 显示在线状态（0-否，1-是） |

### 请求示例

**curl命令**：
```bash
curl -X POST http://localhost:8080/api/user/privacy \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{
    "whoCanSeeMe": 2,
    "showDistance": 1,
    "showOnlineStatus": 0
  }'
```

**请求Body**：
```json
{
  "whoCanSeeMe": 2,
  "showDistance": 1,
  "showOnlineStatus": 0
}
```

### 响应示例

```json
{
  "code": 200,
  "message": "隐私设置成功",
  "data": true
}
```

### 业务说明

1. **部分更新**：只更新提供的字段
2. **默认值**：首次设置时，未提供的字段使用默认值（whoCanSeeMe=1, showDistance=1, showOnlineStatus=1）
3. **立即生效**：设置后立即影响其他用户查看你的资料

---

## 14. 获取隐私设置

### 基本信息
- **接口路径**：`GET /api/user/privacy`
- **接口说明**：获取当前用户的隐私设置
- **是否需要认证**：是

### 请求头

```
Authorization: Bearer {token}
```

### 请求示例

**curl命令**：
```bash
curl -X GET http://localhost:8080/api/user/privacy \
  -H "Authorization: Bearer YOUR_TOKEN"
```

### 响应示例

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "whoCanSeeMe": 2,
    "showDistance": 1,
    "showOnlineStatus": 0
  }
}
```

### 响应字段说明

| 字段名 | 类型 | 说明 |
|--------|------|------|
| whoCanSeeMe | Integer | 谁可以看我（1-所有人，2-仅匹配的人，3-关闭） |
| showDistance | Integer | 显示距离（0-否，1-是） |
| showOnlineStatus | Integer | 显示在线状态（0-否，1-是） |

---

## 15. 拉黑用户

### 基本信息
- **接口路径**：`POST /api/user/blacklist/{blockedUserId}`
- **接口说明**：将指定用户加入黑名单
- **是否需要认证**：是

### 请求头

```
Authorization: Bearer {token}
```

### 路径参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| blockedUserId | Long | 是 | 要拉黑的用户ID |

### 请求示例

**curl命令**：
```bash
curl -X POST http://localhost:8080/api/user/blacklist/1002 \
  -H "Authorization: Bearer YOUR_TOKEN"
```

### 响应示例

```json
{
  "code": 200,
  "message": "拉黑成功",
  "data": true
}
```

### 业务说明

1. **双向隔离**：拉黑后，双方都无法看到对方的动态和资料
2. **自动取消关注**：拉黑后自动取消关注和粉丝关系
3. **聊天限制**：拉黑后无法互相发送消息
4. **重复拉黑**：重复拉黑同一用户会返回成功（幂等操作）

---

## 16. 移除黑名单

### 基本信息
- **接口路径**：`DELETE /api/user/blacklist/{blockedUserId}`
- **接口说明**：将指定用户从黑名单移除
- **是否需要认证**：是

### 请求头

```
Authorization: Bearer {token}
```

### 路径参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| blockedUserId | Long | 是 | 要移除的用户ID |

### 请求示例

**curl命令**：
```bash
curl -X DELETE http://localhost:8080/api/user/blacklist/1002 \
  -H "Authorization: Bearer YOUR_TOKEN"
```

### 响应示例

```json
{
  "code": 200,
  "message": "移除成功",
  "data": true
}
```

### 业务说明

1. **恢复可见**：移除后，双方可以重新看到对方的资料
2. **不恢复关注**：移除黑名单不会自动恢复之前的关注关系
3. **重复移除**：重复移除同一用户会返回成功（幂等操作）

---

## 17. 设置匹配偏好

### 基本信息
- **接口路径**：`POST /api/matching/preference`
- **接口说明**：设置用户的匹配偏好条件
- **是否需要认证**：是

### 请求头

```
Authorization: Bearer {token}
Content-Type: application/json
```

### 请求参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| minAge | Integer | 否 | 期望最小年龄（范围18-100） |
| maxAge | Integer | 否 | 期望最大年龄（范围18-100） |
| minHeight | Integer | 否 | 期望最小身高（范围100-250） |
| maxHeight | Integer | 否 | 期望最大身高（范围100-250） |
| education | String | 否 | 期望学历（多个用逗号分隔） |
| incomeRange | String | 否 | 期望收入范围 |
| maxDistance | Integer | 否 | 最大距离（km，范围1-1000） |
| locationLatitude | BigDecimal | 否 | 用户纬度 |
| locationLongitude | BigDecimal | 否 | 用户经度 |

### 请求示例

**curl命令**：
```bash
curl -X POST http://localhost:8080/api/matching/preference \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{
    "minAge": 20,
    "maxAge": 35,
    "minHeight": 160,
    "maxHeight": 180,
    "education": "本科,硕士",
    "incomeRange": "10-20万",
    "maxDistance": 10,
    "locationLatitude": 39.908823,
    "locationLongitude": 116.397470
  }'
```

**请求Body**：
```json
{
  "minAge": 20,
  "maxAge": 35,
  "minHeight": 160,
  "maxHeight": 180,
  "education": "本科,硕士",
  "incomeRange": "10-20万",
  "maxDistance": 10,
  "locationLatitude": 39.908823,
  "locationLongitude": 116.397470
}
```

### 响应示例

```json
{
  "code": 200,
  "message": "匹配偏好设置成功",
  "data": true
}
```

### 业务说明

1. **自动更新标志位**：设置成功后，自动将`match_preference_set=1`
2. **支持部分更新**：所有参数都是可选的，只更新提供的字段
3. **覆盖式更新**：新的设置会覆盖旧的设置

---

## 18. 获取匹配偏好

### 基本信息
- **接口路径**：`GET /api/matching/preference`
- **接口说明**：获取当前用户的匹配偏好设置
- **是否需要认证**：是

### 请求头

```
Authorization: Bearer {token}
```

### 请求示例

**curl命令**：
```bash
curl -X GET http://localhost:8080/api/matching/preference \
  -H "Authorization: Bearer YOUR_TOKEN"
```

### 响应示例

**已设置偏好时**：
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "id": 1,
    "userId": 1001,
    "minAge": 20,
    "maxAge": 35,
    "minHeight": 160,
    "maxHeight": 180,
    "education": "本科,硕士",
    "incomeRange": "10-20万",
    "maxDistance": 10,
    "locationLatitude": 39.908823,
    "locationLongitude": 116.397470,
    "createdAt": "2025-11-01T21:20:00",
    "updatedAt": "2025-11-01T21:20:00"
  }
}
```

**未设置偏好时**：
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "userId": 1001,
    "minAge": null,
    "maxAge": null,
    "minHeight": null,
    "maxHeight": null,
    "education": null,
    "incomeRange": null,
    "maxDistance": null,
    "locationLatitude": null,
    "locationLongitude": null
  }
}
```

---

## 接口速查表

| 序号 | 接口路径 | 方法 | 说明 | 认证 |
|------|---------|------|------|------|
| 1 | `/api/auth/wx/login` | POST | 微信登录 | ❌ |
| 2 | `/api/user/profile` | POST | 完善资料 | ✅ |
| 3 | `/api/user/profile/update` | POST | 更新资料 | ✅ |
| 4 | `/api/user/profile` | GET | 查看我的资料 | ✅ |
| 5 | `/api/user/profile/{userId}` | GET | 查看他人资料 | ✅ |
| 6 | `/api/user/profile/status` | GET | 查看资料完善状态 | ✅ |
| 7 | `/api/user/stats` | GET | 获取用户统计数据 | ✅ |
| 8 | `/api/user/album/upload` | POST | 上传照片 | ✅ |
| 9 | `/api/user/album/{photoId}` | DELETE | 删除照片 | ✅ |
| 10 | `/api/user/album/cover/{photoId}` | POST | 设置封面照片 | ✅ |
| 11 | `/api/user/tags` | GET | 获取标签库 | ❌ |
| 12 | `/api/user/tags` | POST | 设置我的标签 | ✅ |
| 13 | `/api/user/privacy` | POST | 更新隐私设置 | ✅ |
| 14 | `/api/user/privacy` | GET | 获取隐私设置 | ✅ |
| 15 | `/api/user/blacklist/{blockedUserId}` | POST | 拉黑用户 | ✅ |
| 16 | `/api/user/blacklist/{blockedUserId}` | DELETE | 移除黑名单 | ✅ |
| 17 | `/api/matching/preference` | POST | 设置匹配偏好 | ✅ |
| 18 | `/api/matching/preference` | GET | 获取匹配偏好 | ✅ |

---

## 完整测试流程

### Step 1: 微信登录
```bash
curl -X POST http://localhost:8080/api/auth/wx/login \
  -H "Content-Type: application/json" \
  -d '{"code": "test_code_12345"}'
```

**获取token**：从响应中提取`data.token`

### Step 2: 完善资料
```bash
TOKEN="从上一步获取的token"

curl -X POST http://localhost:8080/api/user/profile \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $TOKEN" \
  -d '{
    "nickname": "测试用户",
    "avatar": "https://example.com/avatar.jpg",
    "gender": 2,
    "birthday": "1998-05-20",
    "tagIds": [1, 5, 8]
  }'
```

### Step 3: 检查资料状态
```bash
curl -X GET http://localhost:8080/api/user/profile/status \
  -H "Authorization: Bearer $TOKEN"
```

### Step 4: 设置匹配偏好
```bash
curl -X POST http://localhost:8080/api/matching/preference \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $TOKEN" \
  -d '{
    "minAge": 20,
    "maxAge": 35,
    "maxDistance": 10
  }'
```

### Step 5: 上传照片
```bash
curl -X POST http://localhost:8080/api/user/album/upload \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $TOKEN" \
  -d '{
    "photoUrl": "https://example.com/photo1.jpg",
    "isCover": true
  }'
```

### Step 6: 获取标签库并设置标签
```bash
# 获取标签库
curl -X GET http://localhost:8080/api/user/tags

# 设置我的标签
curl -X POST http://localhost:8080/api/user/tags \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $TOKEN" \
  -d '{
    "tagIds": [1, 2, 3, 5]
  }'
```

### Step 7: 设置隐私
```bash
curl -X POST http://localhost:8080/api/user/privacy \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $TOKEN" \
  -d '{
    "whoCanSeeMe": 2,
    "showDistance": 1,
    "showOnlineStatus": 0
  }'
```

### Step 8: 查看他人资料
```bash
curl -X GET http://localhost:8080/api/user/profile/1002 \
  -H "Authorization: Bearer $TOKEN"
```

### Step 9: 验证状态
```bash
# 再次登录，查看标志位
curl -X POST http://localhost:8080/api/auth/wx/login \
  -H "Content-Type: application/json" \
  -d '{"code": "test_code_12345"}'
```

**预期结果**：
```json
{
  "profileComplete": 1,
  "matchPreferenceSet": 1
}
```

---

## 错误码说明

| 错误码 | 说明 |
|--------|------|
| 200 | 成功 |
| 400 | 请求参数错误 |
| 401 | 未登录或token无效 |
| 404 | 用户不存在 |
| 40001 | 照片数量超限 |
| 40002 | 标签数量超限（最多10个） |
| 500 | 服务器内部错误 |

---

## 常见问题

### 1. 为什么我设置了资料，profileComplete还是0？

**可能原因**：
- 性别为0（未知）
- 缺少兴趣标签
- 昵称、头像、生日未填写

**解决方案**：调用`/api/user/profile/status`查看缺失字段

### 2. 可以只更新部分字段吗？

**可以！** 所有字段都是可选的，只更新提供的字段。

### 3. 标签最多可以选几个？

**最多10个**。完善资料时至少选1个，否则profileComplete不会变为1。

### 4. 性别可以设置为0（未知）吗？

**可以设置，但不算完善。** 资料完善判断时，性别必须是1或2。

### 5. 完善资料和更新资料有什么区别？

**没有本质区别**。两个接口都调用同一个service方法，只是路径和返回消息不同：
- `/api/user/profile` - 返回"资料保存成功"
- `/api/user/profile/update` - 返回"资料更新成功"

### 6. 照片最多可以上传几张？

**最多9张**。超过限制会返回错误码40001。

### 7. 如何查看他人资料？

使用 `GET /api/user/profile/{userId}`，会根据对方的隐私设置返回相应信息。

### 8. 拉黑用户后会有什么影响？

- 双方无法看到对方的动态和资料
- 自动取消关注和粉丝关系
- 无法互相发送消息

### 9. 隐私设置中"谁可以看我"的选项说明？

- **1-所有人**：任何用户都可以查看你的资料
- **2-仅匹配的人**：只有匹配成功的用户可以查看
- **3-关闭**：关闭资料展示，其他人无法查看

---

## 附录：前端集成示例

### 小程序登录引导逻辑

```javascript
// 登录
wx.request({
  url: 'http://localhost:8080/api/auth/wx/login',
  method: 'POST',
  data: { code: wxCode },
  success: (res) => {
    const { profileComplete, matchPreferenceSet, token } = res.data.data;
    
    // 保存token
    wx.setStorageSync('token', token);
    
    // 根据状态引导
    if (profileComplete === 0) {
      // 引导完善资料
      wx.navigateTo({ url: '/pages/profile-setup/index' });
    } else if (matchPreferenceSet === 0) {
      // 引导设置匹配偏好
      wx.navigateTo({ url: '/pages/matching-preference/index' });
    } else {
      // 进入主页
      wx.switchTab({ url: '/pages/home/index' });
    }
  }
});
```

### 提交完善资料

```javascript
wx.request({
  url: 'http://localhost:8080/api/user/profile',
  method: 'POST',
  header: {
    'Authorization': `Bearer ${wx.getStorageSync('token')}`
  },
  data: {
    nickname: '小雨',
    avatar: 'https://...',
    gender: 2,
    birthday: '1998-05-20',
    tagIds: [1, 5, 8]
  },
  success: (res) => {
    wx.showToast({ title: '资料保存成功' });
    // 引导设置匹配偏好
    wx.navigateTo({ url: '/pages/matching-preference/index' });
  }
});
```

### 上传照片

```javascript
// 1. 选择图片
wx.chooseImage({
  count: 1,
  success: (res) => {
    const tempFilePath = res.tempFilePaths[0];
    
    // 2. 上传到云存储（或自己的服务器）
    wx.cloud.uploadFile({
      cloudPath: `photos/${Date.now()}.jpg`,
      filePath: tempFilePath,
      success: (uploadRes) => {
        const photoUrl = uploadRes.fileID;
        
        // 3. 调用接口保存照片记录
        wx.request({
          url: 'http://localhost:8080/api/user/album/upload',
          method: 'POST',
          header: {
            'Authorization': `Bearer ${wx.getStorageSync('token')}`
          },
          data: {
            photoUrl: photoUrl,
            isCover: false
          },
          success: (res) => {
            wx.showToast({ title: '上传成功' });
          }
        });
      }
    });
  }
});
```

### 查看他人资料

```javascript
// 点击用户头像时
onUserClick(userId) {
  wx.request({
    url: `http://localhost:8080/api/user/profile/${userId}`,
    method: 'GET',
    header: {
      'Authorization': `Bearer ${wx.getStorageSync('token')}`
    },
    success: (res) => {
      const userProfile = res.data.data;
      // 跳转到用户详情页
      wx.navigateTo({
        url: `/pages/user-detail/index?userId=${userId}`,
        success: (res) => {
          // 通过eventChannel传递数据
          res.eventChannel.emit('userProfile', userProfile);
        }
      });
    }
  });
}
```

### 设置隐私

```javascript
wx.request({
  url: 'http://localhost:8080/api/user/privacy',
  method: 'POST',
  header: {
    'Authorization': `Bearer ${wx.getStorageSync('token')}`
  },
  data: {
    whoCanSeeMe: 2,        // 仅匹配的人
    showDistance: 1,       // 显示距离
    showOnlineStatus: 0    // 不显示在线状态
  },
  success: (res) => {
    wx.showToast({ title: '设置成功' });
  }
});
```

### 拉黑用户

```javascript
onBlockUser(userId) {
  wx.showModal({
    title: '确认拉黑',
    content: '拉黑后将无法看到对方的动态',
    success: (res) => {
      if (res.confirm) {
        wx.request({
          url: `http://localhost:8080/api/user/blacklist/${userId}`,
          method: 'POST',
          header: {
            'Authorization': `Bearer ${wx.getStorageSync('token')}`
          },
          success: (res) => {
            wx.showToast({ title: '拉黑成功' });
            // 返回上一页或刷新列表
            wx.navigateBack();
          }
        });
      }
    }
  });
}
```

### 获取并设置标签

```javascript
// 1. 获取标签库
wx.request({
  url: 'http://localhost:8080/api/user/tags',
  method: 'GET',
  success: (res) => {
    const tagLibrary = res.data.data;
    this.setData({ tagLibrary });
  }
});

// 2. 用户选择标签后保存
onTagsConfirm(selectedTagIds) {
  wx.request({
    url: 'http://localhost:8080/api/user/tags',
    method: 'POST',
    header: {
      'Authorization': `Bearer ${wx.getStorageSync('token')}`
    },
    data: {
      tagIds: selectedTagIds
    },
    success: (res) => {
      wx.showToast({ title: '标签设置成功' });
    }
  });
}
```

---

## 接口更新日志

### v1.1 (2025-11-01)
- ✨ 新增：更新资料接口 (POST /api/user/profile/update)
- ✨ 新增：查看他人资料接口 (GET /api/user/profile/{userId})
- ✨ 新增：相册管理接口（上传、删除、设置封面）
- ✨ 新增：标签管理接口（获取标签库、设置标签）
- ✨ 新增：隐私设置接口（更新、获取）
- ✨ 新增：黑名单管理接口（拉黑、移除）
- 📝 完善：补充了11个遗漏的接口文档
- 📝 优化：添加接口速查表和详细的业务说明
- 📝 优化：完善前端集成示例

### v1.0 (2025-11-01)
- 🎉 初始版本
- ✅ 微信登录
- ✅ 完善资料
- ✅ 查看我的资料
- ✅ 查看资料完善状态
- ✅ 获取用户统计数据
- ✅ 设置/获取匹配偏好

---

**文档结束**

