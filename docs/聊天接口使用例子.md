# 聊天功能 cURL 测试指南

## 环境准备

**服务器地址**: `http://localhost:8080`  
**认证方式**: Bearer Token (JWT)

---

## 1. 获取 Token（前置步骤）

### 1.1 微信小程序登录
```bash
curl -X POST http://localhost:8080/api/auth/wx/login \
  -H "Content-Type: application/json" \
  -d '{
    "code": "微信code",
    "nickname": "测试用户",
    "avatar": "https://example.com/avatar.jpg"
  }'
```

**响应示例**:
```json
{
  "code": 200,
  "msg": "success",
  "data": {
    "token": "eyJhbGciOiJIUzI1NiJ9...",
    "userId": "U1699123456789AB12CD",
    "isNewUser": false
  }
}
```

**⚠️ 重要**: 将返回的 `token` 保存到环境变量中：
```bash
# Windows PowerShell
$TOKEN="返回的token值"

# Linux/Mac
export TOKEN="返回的token值"
```

---

## 2. 聊天 REST API 测试

### 2.1 获取会话列表
```bash
curl -X GET "http://localhost:8080/api/chat/conversations?page=1&size=20" \
  -H "Authorization: Bearer $TOKEN"
```

### 2.2 创建或获取会话
```bash
curl -X POST http://localhost:8080/api/chat/conversations \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $TOKEN" \
  -d '{
    "otherUserId": "U1699123456789AB12XY"
  }'
```

**响应示例**:
```json
{
  "code": 200,
  "data": {
    "conversationId": "abc123def456",
    "type": 1,
    "otherUserId": "U1699123456789AB12XY",
    "otherUserNickname": "张三",
    "otherUserAvatar": "https://example.com/avatar.jpg",
    "unreadCount": 0
  }
}
```

### 2.3 发送消息
```bash
# 发送文本消息
curl -X POST http://localhost:8080/api/chat/messages \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $TOKEN" \
  -d '{
    "conversationId": "abc123def456",
    "toUserId": "U1699123456789AB12XY",
    "messageType": 1,
    "content": "你好，这是测试消息",
    "clientMsgId": "client_msg_001"
  }'

# 发送图片消息
curl -X POST http://localhost:8080/api/chat/messages \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $TOKEN" \
  -d '{
    "conversationId": "abc123def456",
    "toUserId": "U1699123456789AB12XY",
    "messageType": 2,
    "content": "{\"url\":\"https://example.com/image.jpg\"}",
    "mediaUrl": "https://example.com/image.jpg",
    "clientMsgId": "client_msg_002"
  }'

# 发送语音消息
curl -X POST http://localhost:8080/api/chat/messages \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $TOKEN" \
  -d '{
    "conversationId": "abc123def456",
    "toUserId": "U1699123456789AB12XY",
    "messageType": 3,
    "mediaUrl": "https://example.com/voice.mp3",
    "mediaDuration": 15,
    "clientMsgId": "client_msg_003"
  }'
```

**消息类型说明**:
- `1` - 文本消息
- `2` - 图片消息
- `3` - 语音消息
- `4` - 视频消息

### 2.4 获取消息历史
```bash
# 获取最新消息
curl -X GET "http://localhost:8080/api/chat/conversations/abc123def456/messages?size=20" \
  -H "Authorization: Bearer $TOKEN"

# 使用游标分页获取更早的消息
curl -X GET "http://localhost:8080/api/chat/conversations/abc123def456/messages?beforeMessageId=12345&size=20" \
  -H "Authorization: Bearer $TOKEN"
```

### 2.5 标记消息已读
```bash
curl -X POST http://localhost:8080/api/chat/conversations/abc123def456/read \
  -H "Authorization: Bearer $TOKEN"
```

### 2.6 撤回消息
```bash
curl -X POST http://localhost:8080/api/chat/messages/message_id_xxx/recall \
  -H "Authorization: Bearer $TOKEN"
```

**注意**: 只能撤回 2 分钟内的消息

### 2.7 获取未读消息总数
```bash
curl -X GET http://localhost:8080/api/chat/unread-count \
  -H "Authorization: Bearer $TOKEN"
```

### 2.8 删除会话
```bash
curl -X DELETE http://localhost:8080/api/chat/conversations/abc123def456 \
  -H "Authorization: Bearer $TOKEN"
```

---

## 3. WebSocket 测试

### 3.1 获取 WebSocket 连接信息
```bash
curl -X GET http://localhost:8080/api/websocket/info \
  -H "Authorization: Bearer $TOKEN"
```

### 3.2 使用 wscat 测试 WebSocket
首先安装 wscat:
```bash
npm install -g wscat
```

然后连接 WebSocket:
```bash
wscat -c "ws://localhost:8080/ws/chat?token=$TOKEN"
```

**WebSocket 消息格式**:
```json
{
  "type": "NEW_MESSAGE",
  "data": {
    "messageId": "msg_123",
    "conversationId": "conv_456",
    "fromUserId": "U1699123456789AB12CD",
    "content": "Hello",
    "messageType": 1,
    "sendTime": "2024-11-30T19:00:00"
  }
}
```

### 3.3 检查用户在线状态
```bash
curl -X GET http://localhost:8080/api/websocket/online/U1699123456789AB12XY \
  -H "Authorization: Bearer $TOKEN"
```

### 3.4 获取当前在线人数
```bash
curl -X GET http://localhost:8080/api/websocket/online-count \
  -H "Authorization: Bearer $TOKEN"
```

---

## 4. 完整测试流程示例

### 场景：用户A和用户B聊天

#### Step 1: 用户A登录
```bash
curl -X POST http://localhost:8080/api/auth/wx/login \
  -H "Content-Type: application/json" \
  -d '{"code":"mock_code_a","nickname":"用户A","avatar":"https://example.com/a.jpg"}' \
  | jq -r '.data.token' > token_a.txt

export TOKEN_A=$(cat token_a.txt)
```

#### Step 2: 用户B登录
```bash
curl -X POST http://localhost:8080/api/auth/wx/login \
  -H "Content-Type: application/json" \
  -d '{"code":"mock_code_b","nickname":"用户B","avatar":"https://example.com/b.jpg"}' \
  | jq -r '.data.token' > token_b.txt

export TOKEN_B=$(cat token_b.txt)
```

#### Step 3: 用户A创建与用户B的会话
```bash
curl -X POST http://localhost:8080/api/chat/conversations \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $TOKEN_A" \
  -d '{"otherUserId":"用户B的userId"}' \
  | jq -r '.data.conversationId' > conv_id.txt

export CONV_ID=$(cat conv_id.txt)
```

#### Step 4: 用户A发送消息给用户B
```bash
curl -X POST http://localhost:8080/api/chat/messages \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $TOKEN_A" \
  -d '{
    "conversationId":"'"$CONV_ID"'",
    "toUserId":"用户B的userId",
    "messageType":1,
    "content":"你好，我是用户A"
  }'
```

#### Step 5: 用户B查看消息
```bash
curl -X GET "http://localhost:8080/api/chat/conversations/$CONV_ID/messages?size=20" \
  -H "Authorization: Bearer $TOKEN_B"
```

#### Step 6: 用户B标记已读
```bash
curl -X POST "http://localhost:8080/api/chat/conversations/$CONV_ID/read" \
  -H "Authorization: Bearer $TOKEN_B"
```

#### Step 7: 用户B回复
```bash
curl -X POST http://localhost:8080/api/chat/messages \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $TOKEN_B" \
  -d '{
    "conversationId":"'"$CONV_ID"'",
    "toUserId":"用户A的userId",
    "messageType":1,
    "content":"你好，我是用户B"
  }'
```

---

## 5. 常见测试场景

### 5.1 测试消息撤回（2分钟内）
```bash
# 发送消息
MSG_ID=$(curl -X POST http://localhost:8080/api/chat/messages \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $TOKEN" \
  -d '{...}' | jq -r '.data.messageId')

# 立即撤回
curl -X POST "http://localhost:8080/api/chat/messages/$MSG_ID/recall" \
  -H "Authorization: Bearer $TOKEN"
```

### 5.2 测试未读数统计
```bash
# 查看未读总数
curl -X GET http://localhost:8080/api/chat/unread-count \
  -H "Authorization: Bearer $TOKEN"

# 标记某个会话已读后再查看
curl -X POST "http://localhost:8080/api/chat/conversations/$CONV_ID/read" \
  -H "Authorization: Bearer $TOKEN"

curl -X GET http://localhost:8080/api/chat/unread-count \
  -H "Authorization: Bearer $TOKEN"
```

### 5.3 测试分页加载
```bash
# 加载第一页
curl -X GET "http://localhost:8080/api/chat/conversations?page=1&size=10" \
  -H "Authorization: Bearer $TOKEN"

# 加载第二页
curl -X GET "http://localhost:8080/api/chat/conversations?page=2&size=10" \
  -H "Authorization: Bearer $TOKEN"
```

### 5.4 测试游标分页（消息历史）
```bash
# 获取最新20条
curl -X GET "http://localhost:8080/api/chat/conversations/$CONV_ID/messages?size=20" \
  -H "Authorization: Bearer $TOKEN" \
  | jq '.data.records[-1].id' > last_msg_id.txt

# 获取更早的20条
LAST_ID=$(cat last_msg_id.txt)
curl -X GET "http://localhost:8080/api/chat/conversations/$CONV_ID/messages?beforeMessageId=$LAST_ID&size=20" \
  -H "Authorization: Bearer $TOKEN"
```

---

## 6. 错误场景测试

### 6.1 无效 Token
```bash
curl -X GET http://localhost:8080/api/chat/conversations \
  -H "Authorization: Bearer invalid_token"
# 预期: 401 Unauthorized
```

### 6.2 撤回超时消息
```bash
# 尝试撤回3分钟前的消息
curl -X POST "http://localhost:8080/api/chat/messages/old_message_id/recall" \
  -H "Authorization: Bearer $TOKEN"
# 预期: 400 "超过2分钟的消息无法撤回"
```

### 6.3 访问不存在的会话
```bash
curl -X GET "http://localhost:8080/api/chat/conversations/nonexistent/messages" \
  -H "Authorization: Bearer $TOKEN"
# 预期: 400 "会话不存在或无权限访问"
```

### 6.4 消息参数验证
```bash
# 缺少必填字段
curl -X POST http://localhost:8080/api/chat/messages \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer $TOKEN" \
  -d '{
    "conversationId":"abc123",
    "messageType":1
  }'
# 预期: 400 参数校验失败
```

---

## 7. 性能测试

### 7.1 并发发送消息
```bash
# 使用 GNU Parallel 进行并发测试
seq 1 100 | parallel -j 10 \
  "curl -X POST http://localhost:8080/api/chat/messages \
    -H 'Content-Type: application/json' \
    -H 'Authorization: Bearer $TOKEN' \
    -d '{\"conversationId\":\"$CONV_ID\",\"toUserId\":\"xxx\",\"messageType\":1,\"content\":\"Message {}\"}'"
```

### 7.2 压力测试（使用 Apache Bench）
```bash
# 安装 ab
# Windows: 随Apache安装
# Linux: sudo apt-get install apache2-utils
# Mac: brew install ab

# 测试获取会话列表接口
ab -n 1000 -c 10 -H "Authorization: Bearer $TOKEN" \
  http://localhost:8080/api/chat/conversations
```

---

## 8. 调试技巧

### 8.1 查看完整响应头
```bash
curl -v -X GET http://localhost:8080/api/chat/conversations \
  -H "Authorization: Bearer $TOKEN"
```

### 8.2 格式化 JSON 响应
```bash
curl -X GET http://localhost:8080/api/chat/conversations \
  -H "Authorization: Bearer $TOKEN" | jq '.'
```

### 8.3 保存响应到文件
```bash
curl -X GET http://localhost:8080/api/chat/conversations \
  -H "Authorization: Bearer $TOKEN" \
  -o conversations.json
```

### 8.4 测量响应时间
```bash
curl -X GET http://localhost:8080/api/chat/conversations \
  -H "Authorization: Bearer $TOKEN" \
  -w "\nTime: %{time_total}s\n"
```

---

## 9. Windows PowerShell 特别说明

在 PowerShell 中使用 cURL 的注意事项：

```powershell
# 设置 Token 变量
$TOKEN = "your_token_here"

# POST 请求示例（注意引号转义）
curl.exe -X POST http://localhost:8080/api/chat/messages `
  -H "Content-Type: application/json" `
  -H "Authorization: Bearer $TOKEN" `
  -d '{\"conversationId\":\"abc\",\"toUserId\":\"xyz\",\"messageType\":1,\"content\":\"Hello\"}'

# 或使用单引号避免转义
curl.exe -X POST http://localhost:8080/api/chat/messages `
  -H "Content-Type: application/json" `
  -H "Authorization: Bearer $TOKEN" `
  -d '{"conversationId":"abc","toUserId":"xyz","messageType":1,"content":"Hello"}'
```

---

## 10. 推荐的测试工具

除了 cURL，还可以使用以下工具：

1. **Postman** - 图形化界面，支持集合和环境变量
2. **Insomnia** - 轻量级 REST 客户端
3. **HTTPie** - 更友好的命令行工具
   ```bash
   http POST localhost:8080/api/chat/messages \
     Authorization:"Bearer $TOKEN" \
     conversationId=abc123 \
     toUserId=xyz \
     messageType:=1 \
     content="Hello"
   ```
4. **wscat** - WebSocket 测试
5. **websocat** - 更强大的 WebSocket 客户端

---

## 附录：完整的 API 端点清单

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | `/api/chat/conversations` | 获取会话列表 |
| POST | `/api/chat/conversations` | 创建或获取会话 |
| GET | `/api/chat/conversations/{id}/messages` | 获取消息历史 |
| POST | `/api/chat/messages` | 发送消息 |
| POST | `/api/chat/messages/{id}/recall` | 撤回消息 |
| POST | `/api/chat/conversations/{id}/read` | 标记已读 |
| GET | `/api/chat/unread-count` | 获取未读数 |
| DELETE | `/api/chat/conversations/{id}` | 删除会话 |
| GET | `/api/websocket/info` | WebSocket 信息 |
| GET | `/api/websocket/online/{userId}` | 检查在线状态 |
| GET | `/api/websocket/online-count` | 在线人数 |
| WS | `/ws/chat?token={token}` | WebSocket 连接 |
