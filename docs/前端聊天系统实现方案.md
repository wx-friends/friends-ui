# å‰ç«¯èŠå¤©ç³»ç»Ÿå®ç°æ–¹æ¡ˆ

## ğŸ“‹ ç›®å½•

1. [æ¦‚è¿°](#æ¦‚è¿°)
2. [æ¶æ„è®¾è®¡](#æ¶æ„è®¾è®¡)
3. [æ ¸å¿ƒæ¨¡å—è®¾è®¡](#æ ¸å¿ƒæ¨¡å—è®¾è®¡)
4. [WebSocket ç®¡ç†](#websocket-ç®¡ç†)
5. [æ•°æ®æµè®¾è®¡](#æ•°æ®æµè®¾è®¡)
6. [UI ç»„ä»¶è®¾è®¡](#ui-ç»„ä»¶è®¾è®¡)
7. [çŠ¶æ€ç®¡ç†](#çŠ¶æ€ç®¡ç†)
8. [æ€§èƒ½ä¼˜åŒ–](#æ€§èƒ½ä¼˜åŒ–)
9. [é”™è¯¯å¤„ç†ä¸å®¹é”™](#é”™è¯¯å¤„ç†ä¸å®¹é”™)
10. [å®ç°æ­¥éª¤](#å®ç°æ­¥éª¤)
11. [æŠ€æœ¯æ ˆä¸ä¾èµ–](#æŠ€æœ¯æ ˆä¸ä¾èµ–)

---

## æ¦‚è¿°

### åŠŸèƒ½èŒƒå›´

æœ¬æ–¹æ¡ˆæ¶µç›–å¾®ä¿¡å°ç¨‹åºå‰ç«¯èŠå¤©ç³»ç»Ÿçš„å®Œæ•´å®ç°ï¼ŒåŒ…æ‹¬ï¼š

- âœ… ä¼šè¯åˆ—è¡¨ç®¡ç†ï¼ˆè·å–ã€åˆ›å»ºã€åˆ é™¤ï¼‰
- âœ… æ¶ˆæ¯å‘é€ä¸æ¥æ”¶ï¼ˆæ–‡æœ¬ã€å›¾ç‰‡ã€è¯­éŸ³ã€è§†é¢‘ï¼‰
- âœ… å®æ—¶æ¶ˆæ¯æ¨é€ï¼ˆWebSocketï¼‰
- âœ… æ¶ˆæ¯å·²è¯»çŠ¶æ€ç®¡ç†
- âœ… æ¶ˆæ¯æ’¤å›åŠŸèƒ½ï¼ˆ2 åˆ†é’Ÿå†…ï¼‰
- âœ… æœªè¯»æ¶ˆæ¯ç»Ÿè®¡
- âœ… èŠå¤©å†å²è®°å½•ï¼ˆæ¸¸æ ‡åˆ†é¡µï¼‰
- âœ… åœ¨çº¿çŠ¶æ€æ˜¾ç¤º

### æŠ€æœ¯ç‰¹ç‚¹

- åŸºäºå¾®ä¿¡å°ç¨‹åºåŸç”Ÿæ¡†æ¶
- WebSocket å®æ—¶é€šä¿¡
- æœ¬åœ°æ¶ˆæ¯ç¼“å­˜ä¸åŒæ­¥
- æ–­çº¿é‡è¿æœºåˆ¶
- æ¶ˆæ¯å»é‡å¤„ç†
- è™šæ‹Ÿæ»šåŠ¨ä¼˜åŒ–ï¼ˆå¤§é‡æ¶ˆæ¯åœºæ™¯ï¼‰

---

## æ¶æ„è®¾è®¡

### æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     å¾®ä¿¡å°ç¨‹åºå‰ç«¯                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚   ä¼šè¯åˆ—è¡¨é¡µ   â”‚  â”‚   èŠå¤©è¯¦æƒ…é¡µ   â”‚  â”‚  å…¶ä»–ä¸šåŠ¡é¡µ    â”‚      â”‚
â”‚  â”‚  (message)   â”‚  â”‚ (chat-detail)â”‚  â”‚              â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚         â”‚                 â”‚                  â”‚              â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                           â”‚                                 â”‚
â”‚                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚                  â”‚   èŠå¤©ç®¡ç†æ¨¡å—    â”‚                        â”‚
â”‚                  â”‚ (ChatManager)   â”‚                        â”‚
â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚                           â”‚                                 â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚         â”‚                 â”‚                 â”‚              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚ WebSocket   â”‚  â”‚   REST API    â”‚  â”‚  æœ¬åœ°å­˜å‚¨   â”‚       â”‚
â”‚  â”‚   Manager   â”‚  â”‚   (chat.js)   â”‚  â”‚ (Storage)  â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜       â”‚
â”‚         â”‚                 â”‚                 â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                 â”‚                 â”‚
          â”‚                 â”‚                 â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     åç«¯æœåŠ¡                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  WebSocket   â”‚  â”‚  REST API    â”‚  â”‚    Redis     â”‚     â”‚
â”‚  â”‚   æœåŠ¡ç«¯      â”‚  â”‚   æœåŠ¡ç«¯      â”‚  â”‚   (ç¼“å­˜)      â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚         â”‚                 â”‚                 â”‚              â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                           â”‚                                â”‚
â”‚                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚                  â”‚    MySQL æ•°æ®åº“   â”‚                       â”‚
â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ¨¡å—åˆ’åˆ†

#### 1. **é¡µé¢å±‚**

- `pages/message/message` - ä¼šè¯åˆ—è¡¨é¡µ
- `pages/chat-detail/chat-detail` - èŠå¤©è¯¦æƒ…é¡µ

#### 2. **ä¸šåŠ¡å±‚**

- `utils/chat-manager.js` - èŠå¤©ç®¡ç†æ ¸å¿ƒæ¨¡å—ï¼ˆå•ä¾‹ï¼‰
- `api/chat.js` - REST API æ¥å£å°è£…ï¼ˆå·²å­˜åœ¨ï¼‰

#### 3. **é€šä¿¡å±‚**

- `utils/websocket-manager.js` - WebSocket è¿æ¥ç®¡ç†

#### 4. **æ•°æ®å±‚**

- æœ¬åœ°å­˜å‚¨ï¼ˆwx.storageï¼‰ - æ¶ˆæ¯ç¼“å­˜ã€ä¼šè¯ç¼“å­˜
- å†…å­˜ç¼“å­˜ - å½“å‰ä¼šè¯æ¶ˆæ¯åˆ—è¡¨

---

## æ ¸å¿ƒæ¨¡å—è®¾è®¡

### 1. ChatManagerï¼ˆèŠå¤©ç®¡ç†æ¨¡å—ï¼‰

**èŒè´£**ï¼š

- ç»Ÿä¸€ç®¡ç†æ‰€æœ‰èŠå¤©ç›¸å…³çš„ä¸šåŠ¡é€»è¾‘
- ç»´æŠ¤ä¼šè¯åˆ—è¡¨å’Œæ¶ˆæ¯åˆ—è¡¨çš„çŠ¶æ€
- åè°ƒ REST API å’Œ WebSocket
- å¤„ç†æ¶ˆæ¯å»é‡ã€æ’åºã€åˆ†é¡µ

**æ–‡ä»¶ä½ç½®**ï¼š`src/utils/chat-manager.js`

**æ ¸å¿ƒæ¥å£**ï¼š

```javascript
class ChatManager {
  // å•ä¾‹æ¨¡å¼
  static getInstance()

  // åˆå§‹åŒ–ï¼ˆåœ¨å°ç¨‹åº app.js ä¸­è°ƒç”¨ï¼‰
  init()

  // ä¼šè¯ç®¡ç†
  async loadConversations(page, size)
  async createConversation(otherUserId)
  async deleteConversation(conversationId)
  getConversation(conversationId)
  getConversations()

  // æ¶ˆæ¯ç®¡ç†
  async loadMessages(conversationId, beforeMessageId, size)
  async sendMessage(conversationId, toUserId, messageType, content, mediaUrl, mediaDuration)
  async recallMessage(messageId)
  async markAsRead(conversationId)

  // æœªè¯»æ•°
  async getUnreadCount()

  // äº‹ä»¶ç›‘å¬
  on(event, callback)
  off(event, callback)
  emit(event, data)

  // æ¸…ç†
  destroy()
}
```

**æ•°æ®å­˜å‚¨ç»“æ„**ï¼š

```javascript
{
  // ä¼šè¯åˆ—è¡¨ï¼ˆæŒ‰æ›´æ–°æ—¶é—´å€’åºï¼‰
  conversations: [
    {
      conversationId: "conv_abc123",
      type: 1,
      otherUserId: "U1699123456789AB12CD",
      otherUserNickname: "å¼ ä¸‰",
      otherUserAvatar: "https://example.com/avatar.jpg",
      otherUserOnline: true,
      lastMessage: {
        content: "ä½ å¥½",
        messageType: 1,
        sendTime: "2024-11-29T10:30:00"
      },
      unreadCount: 3,
      updateTime: "2024-11-29T10:30:00"
    }
  ],

  // æ¯ä¸ªä¼šè¯çš„æ¶ˆæ¯åˆ—è¡¨ï¼ˆæŒ‰æ—¶é—´æ­£åºï¼Œæœ€æ–°çš„åœ¨åï¼‰
  messages: {
    "conv_abc123": [
      {
        id: 12345,
        messageId: "msg_xyz789",
        conversationId: "conv_abc123",
        fromUserId: "U1699123456789AB12CD",
        fromUserNickname: "å¼ ä¸‰",
        fromUserAvatar: "https://example.com/avatar.jpg",
        toUserId: "U1699123456789AB12EF",
        messageType: 1, // 1-æ–‡æœ¬, 2-å›¾ç‰‡, 3-è¯­éŸ³, 4-è§†é¢‘
        content: "ä½ å¥½",
        mediaUrl: null,
        mediaDuration: null,
        status: 4, // 1-å‘é€ä¸­, 2-å·²å‘é€, 3-å·²é€è¾¾, 4-å·²è¯», 5-å¤±è´¥
        isRecalled: false,
        sendTime: "2024-11-29T10:30:00",
        readTime: "2024-11-29T10:31:00",
        isSelf: false
      }
    ]
  },

  // å½“å‰æ‰“å¼€çš„ä¼šè¯ID
  currentConversationId: null,

  // æœªè¯»æ¶ˆæ¯æ€»æ•°
  totalUnreadCount: 0
}
```

### 2. WebSocketManagerï¼ˆWebSocket ç®¡ç†æ¨¡å—ï¼‰

**èŒè´£**ï¼š

- ç®¡ç† WebSocket è¿æ¥ç”Ÿå‘½å‘¨æœŸ
- å¤„ç†å¿ƒè·³ä¿æŒè¿æ¥
- å®ç°æ–­çº¿é‡è¿æœºåˆ¶
- æ¶ˆæ¯è·¯ç”±ä¸åˆ†å‘

**æ–‡ä»¶ä½ç½®**ï¼š`src/utils/websocket-manager.js`

**æ ¸å¿ƒæ¥å£**ï¼š

```javascript
class WebSocketManager {
  // å•ä¾‹æ¨¡å¼
  static getInstance()

  // è¿æ¥ WebSocket
  connect(token)

  // æ–­å¼€è¿æ¥
  disconnect()

  // å‘é€æ¶ˆæ¯ï¼ˆç”¨äºå¿ƒè·³ç­‰ï¼‰
  send(data)

  // ç›‘å¬æ¶ˆæ¯
  onMessage(callback)

  // ç›‘å¬è¿æ¥çŠ¶æ€
  onOpen(callback)
  onClose(callback)
  onError(callback)

  // æ£€æŸ¥è¿æ¥çŠ¶æ€
  isConnected()

  // é‡è¿
  reconnect()
}
```

**WebSocket æ¶ˆæ¯ç±»å‹**ï¼š

```javascript
// æ–°æ¶ˆæ¯æ¨é€
{
  type: "new_message",
  data: {
    id: 12345,
    messageId: "msg_xyz789",
    conversationId: "conv_abc123",
    fromUserId: "U1699123456789AB12CD",
    fromUserNickname: "å¼ ä¸‰",
    fromUserAvatar: "https://example.com/avatar.jpg",
    toUserId: "U1699123456789AB12EF",
    messageType: 1,
    content: "ä½ å¥½",
    status: 2,
    sendTime: "2024-11-29T10:30:00",
    isSelf: false
  },
  timestamp: 1732856400000
}

// å·²è¯»å›æ‰§æ¨é€
{
  type: "message_read",
  conversationId: "conv_abc123",
  readByUserId: "U1699123456789AB12CD",
  timestamp: 1732856400000
}

// æ¶ˆæ¯æ’¤å›æ¨é€
{
  type: "message_recall",
  messageId: "msg_xyz789",
  conversationId: "conv_abc123",
  timestamp: 1732856400000
}

// å¿ƒè·³å“åº”
{
  type: "pong",
  timestamp: 1732856400000
}
```

---

## WebSocket ç®¡ç†

### è¿æ¥æµç¨‹

```mermaid
sequenceDiagram
    participant App as å°ç¨‹åºApp
    participant WS as WebSocketManager
    participant Server as WebSocketæœåŠ¡å™¨

    App->>WS: 1. init() åˆå§‹åŒ–
    App->>WS: 2. connect(token)
    WS->>Server: 3. å»ºç«‹è¿æ¥ ws://host/ws/chat?token=xxx
    Server->>WS: 4. è¿æ¥æˆåŠŸ (connectedäº‹ä»¶)
    WS->>App: 5. onOpenå›è°ƒ

    loop æ¯30ç§’
        WS->>Server: 6. å‘é€å¿ƒè·³ {type: "ping"}
        Server->>WS: 7. å¿ƒè·³å“åº” {type: "pong"}
    end

    Server->>WS: 8. æ–°æ¶ˆæ¯æ¨é€
    WS->>App: 9. è§¦å‘new_messageäº‹ä»¶
    App->>App: 10. æ›´æ–°UI
```

### æ–­çº¿é‡è¿ç­–ç•¥

```javascript
// é‡è¿ç­–ç•¥é…ç½®
{
  // åˆå§‹é‡è¿å»¶è¿Ÿï¼ˆæ¯«ç§’ï¼‰
  initialDelay: 1000,
  // æœ€å¤§é‡è¿å»¶è¿Ÿï¼ˆæ¯«ç§’ï¼‰
  maxDelay: 30000,
  // æœ€å¤§é‡è¿æ¬¡æ•°ï¼ˆ-1è¡¨ç¤ºæ— é™é‡è¿ï¼‰
  maxRetries: -1,
  // å»¶è¿Ÿå¢é•¿å€æ•°
  backoffFactor: 2,
  // è¿æ¥è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
  timeout: 10000
}

// é‡è¿æ—¶æœº
1. WebSocketè¿æ¥æ–­å¼€ï¼ˆoncloseäº‹ä»¶ï¼‰
2. è¿æ¥å¤±è´¥ï¼ˆonerroräº‹ä»¶ï¼‰
3. å¿ƒè·³è¶…æ—¶ï¼ˆè¿ç»­3æ¬¡æœªæ”¶åˆ°pongå“åº”ï¼‰

// é‡è¿æµç¨‹
1. æ£€æŸ¥æ˜¯å¦å·²è¾¾åˆ°æœ€å¤§é‡è¿æ¬¡æ•°
2. è®¡ç®—å»¶è¿Ÿæ—¶é—´ï¼ˆæŒ‡æ•°é€€é¿ï¼‰
3. å»¶è¿Ÿåé‡æ–°è¿æ¥
4. è¿æ¥æˆåŠŸåé‡ç½®é‡è¿è®¡æ•°
```

### å¿ƒè·³æœºåˆ¶

```javascript
// å¿ƒè·³é—´éš”ï¼š30ç§’
const HEARTBEAT_INTERVAL = 30000;

// å¿ƒè·³è¶…æ—¶ï¼šè¿ç»­3æ¬¡æœªæ”¶åˆ°å“åº”åˆ™é‡è¿
const HEARTBEAT_TIMEOUT_COUNT = 3;

// å¿ƒè·³å‘é€
setInterval(() => {
  if (ws.readyState === WebSocket.OPEN) {
    ws.send(
      JSON.stringify({
        type: "ping",
        timestamp: Date.now(),
      })
    );

    // è®°å½•å¿ƒè·³å‘é€æ—¶é—´
    lastPingTime = Date.now();

    // è®¾ç½®è¶…æ—¶æ£€æŸ¥
    setTimeout(() => {
      if (lastPongTime < lastPingTime) {
        // å¿ƒè·³è¶…æ—¶ï¼Œæ–­å¼€é‡è¿
        reconnect();
      }
    }, 5000); // 5ç§’å†…æœªæ”¶åˆ°å“åº”åˆ™è¶…æ—¶
  }
}, HEARTBEAT_INTERVAL);
```

---

## æ•°æ®æµè®¾è®¡

### 1. ä¼šè¯åˆ—è¡¨æ•°æ®æµ

```
é¡µé¢åŠ è½½
  â†“
è°ƒç”¨ ChatManager.loadConversations()
  â†“
å‘é€ REST API è¯·æ±‚ GET /api/chat/conversations
  â†“
æ”¶åˆ°å“åº”ï¼Œæ›´æ–° ChatManager.conversations
  â†“
è§¦å‘ 'conversations_updated' äº‹ä»¶
  â†“
é¡µé¢ç›‘å¬äº‹ä»¶ï¼Œæ›´æ–° UI
```

### 2. æ¶ˆæ¯å‘é€æ•°æ®æµ

```
ç”¨æˆ·è¾“å…¥æ¶ˆæ¯å¹¶ç‚¹å‡»å‘é€
  â†“
è°ƒç”¨ ChatManager.sendMessage()
  â†“
1. ç«‹å³æ·»åŠ ä¸´æ—¶æ¶ˆæ¯åˆ°æœ¬åœ°åˆ—è¡¨ï¼ˆçŠ¶æ€ï¼šå‘é€ä¸­ï¼‰
   â†“
   æ›´æ–° UIï¼ˆä¹è§‚æ›´æ–°ï¼‰
   â†“
2. å‘é€ REST API è¯·æ±‚ POST /api/chat/messages
   â†“
   æˆåŠŸï¼šæ›´æ–°æ¶ˆæ¯çŠ¶æ€ä¸º"å·²å‘é€"
   å¤±è´¥ï¼šæ›´æ–°æ¶ˆæ¯çŠ¶æ€ä¸º"å¤±è´¥"ï¼Œæ˜¾ç¤ºé”™è¯¯æç¤º
   â†“
3. å¦‚æœå¯¹æ–¹åœ¨çº¿ï¼ŒWebSocket ç«‹å³æ¨é€æ–°æ¶ˆæ¯
   å¦‚æœå¯¹æ–¹ç¦»çº¿ï¼Œæ¶ˆæ¯å­˜å…¥ç¦»çº¿é˜Ÿåˆ—
   â†“
4. æ”¶åˆ° WebSocket æ¨é€åï¼Œæ›´æ–°æ¶ˆæ¯çŠ¶æ€ä¸º"å·²é€è¾¾"
   â†“
   å¯¹æ–¹å·²è¯»åï¼Œæ”¶åˆ°"å·²è¯»"æ¨é€ï¼Œæ›´æ–°ä¸º"å·²è¯»"
```

### 3. æ¶ˆæ¯æ¥æ”¶æ•°æ®æµ

```
WebSocket æ”¶åˆ°æ–°æ¶ˆæ¯æ¨é€
  â†“
ChatManager å¤„ç†æ¶ˆæ¯
  â†“
1. æ£€æŸ¥æ¶ˆæ¯å»é‡ï¼ˆæ ¹æ® messageIdï¼‰
   â†“
2. æ·»åŠ åˆ°å¯¹åº”ä¼šè¯çš„æ¶ˆæ¯åˆ—è¡¨
   â†“
3. æ›´æ–°ä¼šè¯çš„æœ€åæ¶ˆæ¯å’Œæœªè¯»æ•°
   â†“
4. è§¦å‘ 'new_message' äº‹ä»¶
   â†“
5. å¦‚æœå½“å‰æ‰“å¼€çš„æ˜¯è¯¥ä¼šè¯ï¼š
     - è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
     - è‡ªåŠ¨æ ‡è®°å·²è¯»
     - æ’­æ”¾æç¤ºéŸ³ï¼ˆå¯é€‰ï¼‰
   â†“
6. å¦‚æœå½“å‰ä¸åœ¨è¯¥ä¼šè¯ï¼š
     - æ›´æ–°ä¼šè¯åˆ—è¡¨æœªè¯»æ ‡è¯†
     - æ˜¾ç¤ºé€šçŸ¥ï¼ˆå¯é€‰ï¼‰
```

### 4. æ¶ˆæ¯å·²è¯»æ•°æ®æµ

```
ç”¨æˆ·æ‰“å¼€èŠå¤©è¯¦æƒ…é¡µ
  â†“
è°ƒç”¨ ChatManager.markAsRead(conversationId)
  â†“
1. å‘é€ REST API è¯·æ±‚ POST /api/chat/conversations/{id}/read
   â†“
2. æ›´æ–°æœ¬åœ°æ¶ˆæ¯çŠ¶æ€ä¸º"å·²è¯»"
   â†“
3. æ¸…ç©ºæœªè¯»æ•°
   â†“
4. å¯¹æ–¹æ”¶åˆ° WebSocket æ¨é€ï¼ˆmessage_readï¼‰
   â†“
   å¯¹æ–¹æ›´æ–°å…¶æœ¬åœ°æ¶ˆæ¯çŠ¶æ€ä¸º"å·²è¯»"
```

---

## UI ç»„ä»¶è®¾è®¡

### 1. ä¼šè¯åˆ—è¡¨é¡µï¼ˆpages/message/messageï¼‰

**æ•°æ®ç»“æ„**ï¼š

```javascript
{
  conversations: [], // ä¼šè¯åˆ—è¡¨
  totalUnreadCount: 0, // æ€»æœªè¯»æ•°
  loading: false, // åŠ è½½çŠ¶æ€
  hasMore: true // æ˜¯å¦è¿˜æœ‰æ›´å¤šæ•°æ®
}
```

**åŠŸèƒ½ç‚¹**ï¼š

- âœ… ä¸‹æ‹‰åˆ·æ–°ä¼šè¯åˆ—è¡¨
- âœ… ä¸Šæ‹‰åŠ è½½æ›´å¤šï¼ˆåˆ†é¡µï¼‰
- âœ… ç‚¹å‡»ä¼šè¯è¿›å…¥èŠå¤©è¯¦æƒ…
- âœ… æ˜¾ç¤ºæœªè¯»æ¶ˆæ¯æ•°ï¼ˆçº¢ç‚¹ï¼‰
- âœ… æ˜¾ç¤ºåœ¨çº¿çŠ¶æ€ï¼ˆç»¿ç‚¹ï¼‰
- âœ… æ˜¾ç¤ºæœ€åæ¶ˆæ¯å’Œæ—¶é—´
- âœ… é•¿æŒ‰åˆ é™¤ä¼šè¯ï¼ˆå¯é€‰ï¼‰

**å…³é”®æ–¹æ³•**ï¼š

```javascript
// åŠ è½½ä¼šè¯åˆ—è¡¨
async loadConversations(refresh = false)

// åˆ·æ–°ä¼šè¯åˆ—è¡¨
onRefresh()

// åŠ è½½æ›´å¤š
onLoadMore()

// æ‰“å¼€èŠå¤©è¯¦æƒ…
openChat(conversation)

// åˆ é™¤ä¼šè¯
deleteConversation(conversationId)

// ç›‘å¬æ–°æ¶ˆæ¯
onNewMessage(message)

// ç›‘å¬ä¼šè¯æ›´æ–°
onConversationUpdate(conversation)
```

### 2. èŠå¤©è¯¦æƒ…é¡µï¼ˆpages/chat-detail/chat-detailï¼‰

**æ•°æ®ç»“æ„**ï¼š

```javascript
{
  conversationId: null, // å½“å‰ä¼šè¯ID
  chatUser: { // å¯¹æ–¹ç”¨æˆ·ä¿¡æ¯
    userId: "",
    nickname: "",
    avatar: "",
    isOnline: false
  },
  messages: [], // æ¶ˆæ¯åˆ—è¡¨ï¼ˆæŒ‰æ—¶é—´æ­£åºï¼‰
  inputText: "", // è¾“å…¥æ¡†å†…å®¹
  loading: false, // åŠ è½½çŠ¶æ€
  hasMore: true, // æ˜¯å¦è¿˜æœ‰æ›´å¤šå†å²æ¶ˆæ¯
  loadingMore: false, // åŠ è½½æ›´å¤šçŠ¶æ€
  scrollIntoView: "", // æ»šåŠ¨åˆ°æŒ‡å®šæ¶ˆæ¯
  isTyping: false // å¯¹æ–¹æ­£åœ¨è¾“å…¥ï¼ˆå¯é€‰åŠŸèƒ½ï¼‰
}
```

**åŠŸèƒ½ç‚¹**ï¼š

- âœ… æ˜¾ç¤ºèŠå¤©æ¶ˆæ¯ï¼ˆæ–‡æœ¬ã€å›¾ç‰‡ã€è¯­éŸ³ã€è§†é¢‘ï¼‰
- âœ… æ¶ˆæ¯æ—¶é—´åˆ†ç»„æ˜¾ç¤ºï¼ˆä»Šå¤©ã€æ˜¨å¤©ã€æ›´æ—©ï¼‰
- âœ… å‘é€æ¶ˆæ¯ï¼ˆæ–‡æœ¬ã€å›¾ç‰‡ã€è¯­éŸ³ã€è§†é¢‘ï¼‰
- âœ… æ¶ˆæ¯çŠ¶æ€æ˜¾ç¤ºï¼ˆå‘é€ä¸­ã€å·²å‘é€ã€å·²é€è¾¾ã€å·²è¯»ã€å¤±è´¥ï¼‰
- âœ… æ¶ˆæ¯æ’¤å›ï¼ˆé•¿æŒ‰æ¶ˆæ¯ï¼Œ2 åˆ†é’Ÿå†…ï¼‰
- âœ… ä¸Šæ‹‰åŠ è½½å†å²æ¶ˆæ¯ï¼ˆæ¸¸æ ‡åˆ†é¡µï¼‰
- âœ… è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨ï¼ˆæ–°æ¶ˆæ¯ï¼‰
- âœ… è‡ªåŠ¨æ ‡è®°å·²è¯»ï¼ˆè¿›å…¥é¡µé¢ã€æ”¶åˆ°æ¶ˆæ¯ï¼‰
- âœ… é¢„è§ˆå›¾ç‰‡ï¼ˆç‚¹å‡»å›¾ç‰‡ï¼‰
- âœ… æ’­æ”¾è¯­éŸ³ï¼ˆç‚¹å‡»è¯­éŸ³æ¶ˆæ¯ï¼‰
- âœ… æ’­æ”¾è§†é¢‘ï¼ˆç‚¹å‡»è§†é¢‘æ¶ˆæ¯ï¼‰
- âœ… æ˜¾ç¤ºåœ¨çº¿çŠ¶æ€

**å…³é”®æ–¹æ³•**ï¼š

```javascript
// åŠ è½½æ¶ˆæ¯å†å²
async loadMessages(beforeMessageId)

// å‘é€æ–‡æœ¬æ¶ˆæ¯
async sendTextMessage(text)

// å‘é€å›¾ç‰‡æ¶ˆæ¯
async sendImageMessage(imagePath)

// å‘é€è¯­éŸ³æ¶ˆæ¯
async sendVoiceMessage(voicePath, duration)

// æ’¤å›æ¶ˆæ¯
async recallMessage(messageId)

// æ ‡è®°å·²è¯»
async markAsRead()

// åŠ è½½æ›´å¤šå†å²æ¶ˆæ¯
async loadMoreMessages()

// æ»šåŠ¨åˆ°åº•éƒ¨
scrollToBottom()

// é¢„è§ˆå›¾ç‰‡
previewImage(imageUrl)

// ç›‘å¬æ–°æ¶ˆæ¯
onNewMessage(message)

// ç›‘å¬æ¶ˆæ¯å·²è¯»
onMessageRead(conversationId)

// ç›‘å¬æ¶ˆæ¯æ’¤å›
onMessageRecall(messageId)
```

### 3. æ¶ˆæ¯æ°”æ³¡ç»„ä»¶ï¼ˆå¯é€‰ï¼‰

å¦‚æœæ¶ˆæ¯ç±»å‹è¾ƒå¤šï¼Œå¯ä»¥æŠ½å–ä¸ºç‹¬ç«‹ç»„ä»¶ï¼š

```javascript
// components/message-bubble/message-bubble
{
  message: {}, // æ¶ˆæ¯å¯¹è±¡
  isSelf: false, // æ˜¯å¦è‡ªå·±å‘é€
  showTime: true // æ˜¯å¦æ˜¾ç¤ºæ—¶é—´
}
```

**æ”¯æŒçš„æ¶ˆæ¯ç±»å‹**ï¼š

- æ–‡æœ¬æ¶ˆæ¯ï¼šæ™®é€šæ–‡æœ¬æ˜¾ç¤º
- å›¾ç‰‡æ¶ˆæ¯ï¼šç¼©ç•¥å›¾ + ç‚¹å‡»é¢„è§ˆ
- è¯­éŸ³æ¶ˆæ¯ï¼šæ’­æ”¾æŒ‰é’® + æ—¶é•¿ + æ³¢å½¢å›¾ï¼ˆå¯é€‰ï¼‰
- è§†é¢‘æ¶ˆæ¯ï¼šç¼©ç•¥å›¾ + æ’­æ”¾æŒ‰é’® + æ—¶é•¿
- ç³»ç»Ÿæ¶ˆæ¯ï¼šå±…ä¸­æ˜¾ç¤ºï¼ˆå¦‚"æ¶ˆæ¯å·²æ’¤å›"ï¼‰

---

## çŠ¶æ€ç®¡ç†

### å…¨å±€çŠ¶æ€ï¼ˆApp.jsï¼‰

```javascript
// app.js
App({
  globalData: {
    chatManager: null, // ChatManager å®ä¾‹
    wsManager: null, // WebSocketManager å®ä¾‹
    currentConversationId: null, // å½“å‰æ‰“å¼€çš„ä¼šè¯ID
    totalUnreadCount: 0, // æ€»æœªè¯»æ•°
  },

  onLaunch() {
    // åˆå§‹åŒ–èŠå¤©ç®¡ç†
    const ChatManager = require("./utils/chat-manager.js");
    const WebSocketManager = require("./utils/websocket-manager.js");

    this.globalData.chatManager = ChatManager.getInstance();
    this.globalData.wsManager = WebSocketManager.getInstance();

    // åˆå§‹åŒ–
    this.globalData.chatManager.init();

    // è¿æ¥ WebSocket
    const token = wx.getStorageSync("token");
    if (token) {
      this.globalData.wsManager.connect(token);
    }
  },

  onHide() {
    // å°ç¨‹åºè¿›å…¥åå°æ—¶ä¿æŒ WebSocket è¿æ¥
    // å¾®ä¿¡å°ç¨‹åºæ”¯æŒåå°ä¿æŒè¿æ¥
  },

  onShow() {
    // å°ç¨‹åºå›åˆ°å‰å°æ—¶åˆ·æ–°ä¼šè¯åˆ—è¡¨
    if (this.globalData.chatManager) {
      this.globalData.chatManager.loadConversations(1, 20, true);
    }
  },
});
```

### é¡µé¢çŠ¶æ€åŒæ­¥

ä½¿ç”¨äº‹ä»¶æœºåˆ¶å®ç°é¡µé¢é—´çš„çŠ¶æ€åŒæ­¥ï¼š

```javascript
// ChatManager å‘å¸ƒäº‹ä»¶
chatManager.emit("new_message", message);
chatManager.emit("conversation_updated", conversation);
chatManager.emit("unread_count_changed", count);

// é¡µé¢ç›‘å¬äº‹ä»¶
chatManager.on("new_message", (message) => {
  // æ›´æ–°å½“å‰é¡µé¢çŠ¶æ€
  if (this.data.conversationId === message.conversationId) {
    this.appendMessage(message);
  }

  // æ›´æ–°ä¼šè¯åˆ—è¡¨
  this.updateConversationList();
});
```

---

## æ€§èƒ½ä¼˜åŒ–

### 1. æ¶ˆæ¯åˆ—è¡¨è™šæ‹Ÿæ»šåŠ¨

å½“æ¶ˆæ¯æ•°é‡è¶…è¿‡ 100 æ¡æ—¶ï¼Œä½¿ç”¨è™šæ‹Ÿæ»šåŠ¨ï¼š

```javascript
// åªæ¸²æŸ“å¯è§†åŒºåŸŸçš„æ¶ˆæ¯
// ä½¿ç”¨ scroll-view çš„ lazy-load ç‰¹æ€§
// æˆ–è€…åªæ¸²æŸ“æœ€è¿‘ 50 æ¡ + å‘ä¸Šæ»šåŠ¨æ—¶åŠ è½½æ›´å¤š
```

### 2. å›¾ç‰‡æ‡’åŠ è½½

```xml
<!-- ä½¿ç”¨å¾®ä¿¡å°ç¨‹åºçš„ lazy-load å±æ€§ -->
<image
  src="{{item.imageUrl}}"
  mode="aspectFill"
  lazy-load="{{true}}"
  binderror="onImageError"
></image>
```

### 3. æ¶ˆæ¯å»é‡

```javascript
// ä½¿ç”¨ messageId ä½œä¸ºå”¯ä¸€æ ‡è¯†
// æ”¶åˆ°æ–°æ¶ˆæ¯æ—¶æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
const messageMap = new Map(); // messageId -> message

function addMessage(message) {
  if (!messageMap.has(message.messageId)) {
    messageMap.set(message.messageId, message);
    messages.push(message);
  }
}
```

### 4. æœ¬åœ°ç¼“å­˜

```javascript
// ç¼“å­˜ä¼šè¯åˆ—è¡¨ï¼ˆ5åˆ†é’Ÿï¼‰
const CONVERSATION_CACHE_TTL = 5 * 60 * 1000;

// ç¼“å­˜æ¶ˆæ¯å†å²ï¼ˆæ¯ä¸ªä¼šè¯æœ€å¤šç¼“å­˜ 100 æ¡ï¼‰
const MAX_CACHED_MESSAGES = 100;

// ä½¿ç”¨ wx.setStorageSync æŒä¹…åŒ–
// ä½¿ç”¨å†…å­˜ Map å¿«é€Ÿè®¿é—®
```

### 5. é˜²æŠ–ä¸èŠ‚æµ

```javascript
// æ¶ˆæ¯å‘é€é˜²æŠ–ï¼ˆé¿å…å¿«é€Ÿç‚¹å‡»ï¼‰
const sendMessageDebounced = debounce(sendMessage, 300);

// æ»šåŠ¨äº‹ä»¶èŠ‚æµ
const onScrollThrottled = throttle(onScroll, 200);

// è¾“å…¥æ¡†å†…å®¹å˜åŒ–èŠ‚æµï¼ˆç”¨äº"æ­£åœ¨è¾“å…¥"æç¤ºï¼‰
const onInputThrottled = throttle(onInput, 1000);
```

### 6. ç½‘ç»œä¼˜åŒ–

```javascript
// åˆå¹¶å¤šä¸ª API è¯·æ±‚ï¼ˆå¦‚åŒæ—¶è·å–ä¼šè¯åˆ—è¡¨å’Œæœªè¯»æ•°ï¼‰
async function loadChatData() {
  const [conversations, unreadCount] = await Promise.all([
    getConversations(),
    getUnreadCount(),
  ]);
}

// è¯·æ±‚å¤±è´¥é‡è¯•ï¼ˆæœ€å¤š3æ¬¡ï¼‰
async function requestWithRetry(fn, maxRetries = 3) {
  for (let i = 0; i < maxRetries; i++) {
    try {
      return await fn();
    } catch (error) {
      if (i === maxRetries - 1) throw error;
      await sleep(1000 * (i + 1)); // æŒ‡æ•°é€€é¿
    }
  }
}
```

---

## é”™è¯¯å¤„ç†ä¸å®¹é”™

### 1. ç½‘ç»œé”™è¯¯å¤„ç†

```javascript
// å‘é€æ¶ˆæ¯å¤±è´¥
try {
  await chatManager.sendMessage(...);
} catch (error) {
  if (error.message.includes('ç½‘ç»œ')) {
    // ç½‘ç»œé”™è¯¯ï¼šä¿å­˜åˆ°æœ¬åœ°é˜Ÿåˆ—ï¼Œç¨åé‡è¯•
    saveMessageToQueue(message);
    wx.showToast({
      title: 'ç½‘ç»œå¼‚å¸¸ï¼Œæ¶ˆæ¯å·²ä¿å­˜',
      icon: 'none'
    });
  } else {
    // å…¶ä»–é”™è¯¯ï¼šæ˜¾ç¤ºé”™è¯¯æç¤º
    wx.showToast({
      title: error.message,
      icon: 'none'
    });
  }
}
```

### 2. WebSocket è¿æ¥å¤±è´¥é™çº§

```javascript
// å¦‚æœ WebSocket è¿æ¥å¤±è´¥ï¼Œé™çº§ä¸º HTTP è½®è¯¢
if (!wsManager.isConnected()) {
  // æ¯ 5 ç§’è½®è¯¢ä¸€æ¬¡æ–°æ¶ˆæ¯
  setInterval(() => {
    chatManager.loadConversations();
    chatManager.loadMessages(currentConversationId);
  }, 5000);
}
```

### 3. æ¶ˆæ¯å‘é€å¤±è´¥é‡è¯•

```javascript
// æ¶ˆæ¯å‘é€é˜Ÿåˆ—
const messageQueue = [];

// å‘é€å¤±è´¥çš„æ¶ˆæ¯åŠ å…¥é˜Ÿåˆ—
function addToQueue(message) {
  messageQueue.push({
    message,
    retryCount: 0,
    maxRetries: 3,
  });
}

// å®šæ—¶é‡è¯•
setInterval(async () => {
  if (messageQueue.length > 0 && wsManager.isConnected()) {
    const item = messageQueue[0];
    try {
      await chatManager.sendMessage(item.message);
      messageQueue.shift(); // æˆåŠŸåˆ™ç§»é™¤
    } catch (error) {
      item.retryCount++;
      if (item.retryCount >= item.maxRetries) {
        messageQueue.shift(); // è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°ï¼Œç§»é™¤å¹¶æ ‡è®°å¤±è´¥
        updateMessageStatus(item.message.messageId, "failed");
      }
    }
  }
}, 3000);
```

### 4. æ•°æ®ä¸€è‡´æ€§ä¿éšœ

```javascript
// å®šæœŸåŒæ­¥æœåŠ¡å™¨æ•°æ®ï¼ˆé˜²æ­¢æœ¬åœ°æ•°æ®ä¸ä¸€è‡´ï¼‰
setInterval(async () => {
  // åŒæ­¥ä¼šè¯åˆ—è¡¨
  await chatManager.loadConversations();

  // åŒæ­¥å½“å‰ä¼šè¯çš„æ¶ˆæ¯
  if (currentConversationId) {
    await chatManager.loadMessages(currentConversationId);
  }
}, 60000); // æ¯ 1 åˆ†é’ŸåŒæ­¥ä¸€æ¬¡
```

---

## å®ç°æ­¥éª¤

### Phase 1: åŸºç¡€è®¾æ–½æ­å»ºï¼ˆ1-2 å¤©ï¼‰

1. **åˆ›å»º WebSocketManager**

   - [ ] å®ç° WebSocket è¿æ¥ç®¡ç†
   - [ ] å®ç°å¿ƒè·³æœºåˆ¶
   - [ ] å®ç°æ–­çº¿é‡è¿
   - [ ] å®ç°æ¶ˆæ¯è·¯ç”±

2. **åˆ›å»º ChatManager**

   - [ ] å®ç°å•ä¾‹æ¨¡å¼
   - [ ] å®ç°äº‹ä»¶æœºåˆ¶
   - [ ] å®ç° REST API å°è£…è°ƒç”¨
   - [ ] å®ç°æœ¬åœ°ç¼“å­˜ç®¡ç†

3. **åœ¨ App.js ä¸­åˆå§‹åŒ–**
   - [ ] åˆå§‹åŒ– ChatManager
   - [ ] åˆå§‹åŒ– WebSocketManager
   - [ ] å¤„ç†ç”Ÿå‘½å‘¨æœŸäº‹ä»¶

### Phase 2: ä¼šè¯åˆ—è¡¨é¡µå®ç°ï¼ˆ2-3 å¤©ï¼‰

1. **æ”¹é€  pages/message/message.js**

   - [ ] æ¥å…¥ ChatManager
   - [ ] å®ç°åŠ è½½ä¼šè¯åˆ—è¡¨
   - [ ] å®ç°ä¸‹æ‹‰åˆ·æ–°
   - [ ] å®ç°ä¸Šæ‹‰åŠ è½½æ›´å¤š
   - [ ] å®ç°åˆ é™¤ä¼šè¯
   - [ ] ç›‘å¬æ–°æ¶ˆæ¯äº‹ä»¶

2. **ä¼˜åŒ– pages/message/message.wxml**

   - [ ] ä¼˜åŒ– UI å±•ç¤º
   - [ ] æ˜¾ç¤ºåœ¨çº¿çŠ¶æ€
   - [ ] æ˜¾ç¤ºæœªè¯»æ•°
   - [ ] æ˜¾ç¤ºæœ€åæ¶ˆæ¯

3. **æµ‹è¯•ä¼šè¯åˆ—è¡¨åŠŸèƒ½**
   - [ ] æµ‹è¯•åŠ è½½
   - [ ] æµ‹è¯•åˆ·æ–°
   - [ ] æµ‹è¯•åˆ é™¤
   - [ ] æµ‹è¯•æœªè¯»æ•°æ›´æ–°

### Phase 3: èŠå¤©è¯¦æƒ…é¡µå®ç°ï¼ˆ3-4 å¤©ï¼‰

1. **æ”¹é€  pages/chat-detail/chat-detail.js**

   - [ ] æ¥å…¥ ChatManager
   - [ ] å®ç°åŠ è½½æ¶ˆæ¯å†å²
   - [ ] å®ç°å‘é€æ–‡æœ¬æ¶ˆæ¯
   - [ ] å®ç°å‘é€å›¾ç‰‡æ¶ˆæ¯
   - [ ] å®ç°å‘é€è¯­éŸ³æ¶ˆæ¯ï¼ˆå¯é€‰ï¼‰
   - [ ] å®ç°å‘é€è§†é¢‘æ¶ˆæ¯ï¼ˆå¯é€‰ï¼‰
   - [ ] å®ç°æ¶ˆæ¯æ’¤å›
   - [ ] å®ç°æ ‡è®°å·²è¯»
   - [ ] å®ç°ä¸Šæ‹‰åŠ è½½æ›´å¤š
   - [ ] ç›‘å¬ WebSocket æ¶ˆæ¯

2. **ä¼˜åŒ– pages/chat-detail/chat-detail.wxml**

   - [ ] ä¼˜åŒ–æ¶ˆæ¯æ°”æ³¡æ ·å¼
   - [ ] æ”¯æŒä¸åŒç±»å‹æ¶ˆæ¯å±•ç¤º
   - [ ] å®ç°æ—¶é—´åˆ†ç»„æ˜¾ç¤º
   - [ ] å®ç°æ¶ˆæ¯çŠ¶æ€æ˜¾ç¤º
   - [ ] å®ç°å›¾ç‰‡é¢„è§ˆ
   - [ ] å®ç°è¯­éŸ³æ’­æ”¾ï¼ˆå¯é€‰ï¼‰

3. **æµ‹è¯•èŠå¤©è¯¦æƒ…åŠŸèƒ½**
   - [ ] æµ‹è¯•å‘é€æ¶ˆæ¯
   - [ ] æµ‹è¯•æ¥æ”¶æ¶ˆæ¯
   - [ ] æµ‹è¯•æ¶ˆæ¯æ’¤å›
   - [ ] æµ‹è¯•å·²è¯»çŠ¶æ€
   - [ ] æµ‹è¯•å†å²æ¶ˆæ¯åŠ è½½

### Phase 4: WebSocket å®æ—¶æ¨é€ï¼ˆ2-3 å¤©ï¼‰

1. **å®ç°æ¶ˆæ¯æ¨é€å¤„ç†**

   - [ ] å¤„ç†æ–°æ¶ˆæ¯æ¨é€
   - [ ] å¤„ç†å·²è¯»å›æ‰§æ¨é€
   - [ ] å¤„ç†æ¶ˆæ¯æ’¤å›æ¨é€
   - [ ] æ›´æ–° UI çŠ¶æ€

2. **å®ç°åœ¨çº¿çŠ¶æ€**

   - [ ] æ˜¾ç¤ºå¯¹æ–¹åœ¨çº¿çŠ¶æ€
   - [ ] å®æ—¶æ›´æ–°åœ¨çº¿çŠ¶æ€

3. **æµ‹è¯•å®æ—¶æ¨é€**
   - [ ] æµ‹è¯•æ–°æ¶ˆæ¯å®æ—¶æ¨é€
   - [ ] æµ‹è¯•å·²è¯»çŠ¶æ€å®æ—¶æ›´æ–°
   - [ ] æµ‹è¯•æ–­çº¿é‡è¿

### Phase 5: ä¼˜åŒ–ä¸å®Œå–„ï¼ˆ2-3 å¤©ï¼‰

1. **æ€§èƒ½ä¼˜åŒ–**

   - [ ] å®ç°æ¶ˆæ¯å»é‡
   - [ ] å®ç°æœ¬åœ°ç¼“å­˜
   - [ ] ä¼˜åŒ–å›¾ç‰‡åŠ è½½
   - [ ] ä¼˜åŒ–æ»šåŠ¨æ€§èƒ½

2. **é”™è¯¯å¤„ç†**

   - [ ] å®Œå–„é”™è¯¯æç¤º
   - [ ] å®ç°å¤±è´¥é‡è¯•
   - [ ] å®ç°é™çº§æ–¹æ¡ˆ

3. **ç”¨æˆ·ä½“éªŒä¼˜åŒ–**

   - [ ] ä¼˜åŒ–åŠ è½½çŠ¶æ€
   - [ ] ä¼˜åŒ–ç©ºçŠ¶æ€
   - [ ] ä¼˜åŒ–æç¤ºä¿¡æ¯
   - [ ] æ·»åŠ éŸ³æ•ˆæç¤ºï¼ˆå¯é€‰ï¼‰

4. **æµ‹è¯•ä¸ä¿®å¤**
   - [ ] å…¨é¢æµ‹è¯•æ‰€æœ‰åŠŸèƒ½
   - [ ] ä¿®å¤å‘ç°çš„ Bug
   - [ ] æ€§èƒ½æµ‹è¯•

---

## æŠ€æœ¯æ ˆä¸ä¾èµ–

### æ ¸å¿ƒä¾èµ–

- **å¾®ä¿¡å°ç¨‹åºåŸç”Ÿæ¡†æ¶** - æ— éœ€é¢å¤–ä¾èµ–
- **wx.request** - HTTP è¯·æ±‚
- **wx.connectSocket** - WebSocket è¿æ¥
- **wx.storage** - æœ¬åœ°å­˜å‚¨

### å¯é€‰ä¾èµ–

- **moment.js**ï¼ˆæˆ– dayjsï¼‰- æ—¶é—´æ ¼å¼åŒ–ï¼ˆå¦‚æœä¸æƒ³æ‰‹å†™ï¼‰

  ```javascript
  // ä½¿ç”¨ dayjsï¼ˆæ›´è½»é‡ï¼‰
  import dayjs from "dayjs";
  import relativeTime from "dayjs/plugin/relativeTime";
  dayjs.extend(relativeTime);

  // æ ¼å¼åŒ–æ—¶é—´
  dayjs(time).format("HH:mm");
  dayjs(time).fromNow(); // "2åˆ†é’Ÿå‰"
  ```

### ä»£ç ç»“æ„

```
src/
â”œâ”€â”€ api/
â”‚   â””â”€â”€ chat.js                    # REST API æ¥å£ï¼ˆå·²å­˜åœ¨ï¼‰
â”œâ”€â”€ utils/
â”‚   â”œâ”€â”€ chat-manager.js            # èŠå¤©ç®¡ç†æ ¸å¿ƒæ¨¡å—ï¼ˆæ–°å»ºï¼‰
â”‚   â””â”€â”€ websocket-manager.js       # WebSocket ç®¡ç†ï¼ˆæ–°å»ºï¼‰
â”œâ”€â”€ pages/
â”‚   â”œâ”€â”€ message/
â”‚   â”‚   â”œâ”€â”€ message.js            # ä¼šè¯åˆ—è¡¨é¡µï¼ˆæ”¹é€ ï¼‰
â”‚   â”‚   â”œâ”€â”€ message.wxml          # ä¼šè¯åˆ—è¡¨æ¨¡æ¿ï¼ˆä¼˜åŒ–ï¼‰
â”‚   â”‚   â””â”€â”€ message.scss          # ä¼šè¯åˆ—è¡¨æ ·å¼ï¼ˆä¼˜åŒ–ï¼‰
â”‚   â””â”€â”€ chat-detail/
â”‚       â”œâ”€â”€ chat-detail.js        # èŠå¤©è¯¦æƒ…é¡µï¼ˆæ”¹é€ ï¼‰
â”‚       â”œâ”€â”€ chat-detail.wxml      # èŠå¤©è¯¦æƒ…æ¨¡æ¿ï¼ˆä¼˜åŒ–ï¼‰
â”‚       â””â”€â”€ chat-detail.scss      # èŠå¤©è¯¦æƒ…æ ·å¼ï¼ˆä¼˜åŒ–ï¼‰
â””â”€â”€ app.js                         # å…¨å±€åˆå§‹åŒ–ï¼ˆæ”¹é€ ï¼‰
```

---

## å…³é”®ä»£ç ç¤ºä¾‹

### 1. WebSocketManager æ ¸å¿ƒä»£ç 

```javascript
// utils/websocket-manager.js
class WebSocketManager {
  constructor() {
    this.ws = null;
    this.url = "";
    this.token = "";
    this.reconnectTimer = null;
    this.heartbeatTimer = null;
    this.reconnectAttempts = 0;
    this.maxReconnectAttempts = -1; // -1 è¡¨ç¤ºæ— é™é‡è¿
    this.listeners = {
      open: [],
      close: [],
      error: [],
      message: [],
    };
    this.lastPingTime = 0;
    this.lastPongTime = 0;
    this.pingTimeoutCount = 0;
  }

  static getInstance() {
    if (!this.instance) {
      this.instance = new WebSocketManager();
    }
    return this.instance;
  }

  connect(token) {
    this.token = token;
    const baseUrl = "wss://friend.uicraft.com.cn"; // ç”Ÿäº§ç¯å¢ƒ
    // const baseUrl = 'ws://localhost:8080'; // å¼€å‘ç¯å¢ƒ
    this.url = `${baseUrl}/ws/chat?token=${token}`;

    this.ws = wx.connectSocket({
      url: this.url,
      success: () => {
        console.log("WebSocket è¿æ¥è¯·æ±‚å·²å‘é€");
      },
      fail: (err) => {
        console.error("WebSocket è¿æ¥å¤±è´¥", err);
        this.handleError(err);
      },
    });

    this.ws.onOpen(() => {
      console.log("WebSocket è¿æ¥æˆåŠŸ");
      this.reconnectAttempts = 0;
      this.pingTimeoutCount = 0;
      this.startHeartbeat();
      this.emit("open");
    });

    this.ws.onClose(() => {
      console.log("WebSocket è¿æ¥å…³é—­");
      this.stopHeartbeat();
      this.emit("close");
      this.reconnect();
    });

    this.ws.onError((err) => {
      console.error("WebSocket é”™è¯¯", err);
      this.handleError(err);
    });

    this.ws.onMessage((res) => {
      try {
        const data = JSON.parse(res.data);
        this.handleMessage(data);
      } catch (error) {
        console.error("è§£ææ¶ˆæ¯å¤±è´¥", error);
      }
    });
  }

  handleMessage(data) {
    if (data.type === "pong") {
      this.lastPongTime = Date.now();
      this.pingTimeoutCount = 0;
      return;
    }

    this.emit("message", data);
  }

  startHeartbeat() {
    this.heartbeatTimer = setInterval(() => {
      if (this.isConnected()) {
        this.lastPingTime = Date.now();
        this.send({
          type: "ping",
          timestamp: Date.now(),
        });

        // 5ç§’å†…æœªæ”¶åˆ° pongï¼Œåˆ™è®¤ä¸ºå¿ƒè·³è¶…æ—¶
        setTimeout(() => {
          if (this.lastPongTime < this.lastPingTime) {
            this.pingTimeoutCount++;
            if (this.pingTimeoutCount >= 3) {
              console.log("å¿ƒè·³è¶…æ—¶ï¼Œé‡è¿");
              this.reconnect();
            }
          }
        }, 5000);
      }
    }, 30000); // 30ç§’å¿ƒè·³
  }

  stopHeartbeat() {
    if (this.heartbeatTimer) {
      clearInterval(this.heartbeatTimer);
      this.heartbeatTimer = null;
    }
  }

  send(data) {
    if (this.isConnected()) {
      this.ws.send({
        data: JSON.stringify(data),
        success: () => {
          console.log("æ¶ˆæ¯å‘é€æˆåŠŸ", data);
        },
        fail: (err) => {
          console.error("æ¶ˆæ¯å‘é€å¤±è´¥", err);
        },
      });
    } else {
      console.warn("WebSocket æœªè¿æ¥ï¼Œæ¶ˆæ¯å‘é€å¤±è´¥");
    }
  }

  reconnect() {
    if (this.reconnectTimer) {
      clearTimeout(this.reconnectTimer);
    }

    if (
      this.maxReconnectAttempts > 0 &&
      this.reconnectAttempts >= this.maxReconnectAttempts
    ) {
      console.error("è¾¾åˆ°æœ€å¤§é‡è¿æ¬¡æ•°ï¼Œåœæ­¢é‡è¿");
      return;
    }

    this.reconnectAttempts++;
    const delay = Math.min(
      1000 * Math.pow(2, this.reconnectAttempts - 1),
      30000
    );

    console.log(`å°†åœ¨ ${delay}ms åé‡è¿ (${this.reconnectAttempts} æ¬¡)`);
    this.reconnectTimer = setTimeout(() => {
      this.connect(this.token);
    }, delay);
  }

  disconnect() {
    this.stopHeartbeat();
    if (this.reconnectTimer) {
      clearTimeout(this.reconnectTimer);
    }
    if (this.ws) {
      this.ws.close();
      this.ws = null;
    }
  }

  isConnected() {
    return this.ws && this.ws.readyState === 1; // OPEN
  }

  on(event, callback) {
    if (this.listeners[event]) {
      this.listeners[event].push(callback);
    }
  }

  off(event, callback) {
    if (this.listeners[event]) {
      const index = this.listeners[event].indexOf(callback);
      if (index > -1) {
        this.listeners[event].splice(index, 1);
      }
    }
  }

  emit(event, data) {
    if (this.listeners[event]) {
      this.listeners[event].forEach((callback) => {
        callback(data);
      });
    }
  }

  handleError(err) {
    this.emit("error", err);
  }
}

export default WebSocketManager;
```

### 2. ChatManager æ ¸å¿ƒä»£ç ç‰‡æ®µ

```javascript
// utils/chat-manager.js
import {
  getConversations,
  createOrGetConversation,
  getConversationMessages,
  sendMessage as apiSendMessage,
  recallMessage as apiRecallMessage,
  markConversationRead as apiMarkConversationRead,
  getUnreadCount as apiGetUnreadCount,
  deleteConversation as apiDeleteConversation,
} from "../api/chat.js";

class ChatManager {
  constructor() {
    this.conversations = [];
    this.messages = {}; // conversationId -> messages[]
    this.currentConversationId = null;
    this.totalUnreadCount = 0;
    this.listeners = {};
    this.messageMap = new Map(); // messageId -> message (ç”¨äºå»é‡)
  }

  static getInstance() {
    if (!this.instance) {
      this.instance = new ChatManager();
    }
    return this.instance;
  }

  async init() {
    // ä»æœ¬åœ°å­˜å‚¨åŠ è½½ç¼“å­˜
    this.loadFromCache();

    // ç›‘å¬ WebSocket æ¶ˆæ¯
    const wsManager = require("./websocket-manager.js").default.getInstance();
    wsManager.on("message", (data) => {
      this.handleWebSocketMessage(data);
    });
  }

  async loadConversations(page = 1, size = 20, force = false) {
    try {
      const result = await getConversations({ page, size });
      if (result && result.data) {
        this.conversations = result.data.records || [];
        this.totalUnreadCount = result.data.totalUnreadCount || 0;
        this.saveToCache();
        this.emit("conversations_updated", this.conversations);
        return this.conversations;
      }
    } catch (error) {
      console.error("åŠ è½½ä¼šè¯åˆ—è¡¨å¤±è´¥", error);
      throw error;
    }
  }

  async sendMessage(
    conversationId,
    toUserId,
    messageType,
    content,
    mediaUrl,
    mediaDuration
  ) {
    // ç”Ÿæˆå®¢æˆ·ç«¯æ¶ˆæ¯ID
    const clientMsgId = `client_${Date.now()}_${Math.random()
      .toString(36)
      .substr(2, 9)}`;

    // åˆ›å»ºä¸´æ—¶æ¶ˆæ¯ï¼ˆä¹è§‚æ›´æ–°ï¼‰
    const tempMessage = {
      messageId: clientMsgId,
      conversationId,
      fromUserId: wx.getStorageSync("userId"),
      toUserId,
      messageType,
      content,
      mediaUrl,
      mediaDuration,
      status: 1, // å‘é€ä¸­
      sendTime: new Date().toISOString(),
      isSelf: true,
    };

    // ç«‹å³æ·»åŠ åˆ°æœ¬åœ°åˆ—è¡¨
    this.addMessage(tempMessage);
    this.emit("new_message", tempMessage);

    try {
      // å‘é€ API è¯·æ±‚
      const result = await apiSendMessage({
        conversationId,
        toUserId,
        messageType,
        content,
        mediaUrl,
        mediaDuration,
        clientMsgId,
      });

      if (result && result.data) {
        // æ›´æ–°æ¶ˆæ¯çŠ¶æ€
        this.updateMessage(clientMsgId, {
          ...result.data,
          status: 2, // å·²å‘é€
        });

        return result.data;
      }
    } catch (error) {
      // å‘é€å¤±è´¥ï¼Œæ›´æ–°çŠ¶æ€
      this.updateMessage(clientMsgId, {
        status: 5, // å¤±è´¥
      });
      throw error;
    }
  }

  handleWebSocketMessage(data) {
    switch (data.type) {
      case "new_message":
        this.handleNewMessage(data.data);
        break;
      case "message_read":
        this.handleMessageRead(data.conversationId, data.readByUserId);
        break;
      case "message_recall":
        this.handleMessageRecall(data.messageId, data.conversationId);
        break;
    }
  }

  handleNewMessage(message) {
    // å»é‡æ£€æŸ¥
    if (this.messageMap.has(message.messageId)) {
      return;
    }

    // æ·»åŠ æ¶ˆæ¯
    this.addMessage(message);

    // æ›´æ–°ä¼šè¯
    const conversation = this.conversations.find(
      (c) => c.conversationId === message.conversationId
    );
    if (conversation) {
      conversation.lastMessage = {
        content: message.content,
        messageType: message.messageType,
        sendTime: message.sendTime,
      };
      conversation.updateTime = message.sendTime;

      // å¦‚æœä¸æ˜¯è‡ªå·±å‘é€çš„ï¼Œå¢åŠ æœªè¯»æ•°
      if (!message.isSelf) {
        conversation.unreadCount = (conversation.unreadCount || 0) + 1;
        this.totalUnreadCount++;
      }
    }

    this.emit("new_message", message);
    this.emit("conversations_updated", this.conversations);
  }

  addMessage(message) {
    const { conversationId, messageId } = message;

    // å»é‡
    if (this.messageMap.has(messageId)) {
      return;
    }

    // æ·»åŠ åˆ°æ¶ˆæ¯åˆ—è¡¨
    if (!this.messages[conversationId]) {
      this.messages[conversationId] = [];
    }

    this.messages[conversationId].push(message);
    this.messageMap.set(messageId, message);

    // æŒ‰æ—¶é—´æ’åº
    this.messages[conversationId].sort(
      (a, b) => new Date(a.sendTime) - new Date(b.sendTime)
    );
  }

  // ... å…¶ä»–æ–¹æ³•
}

export default ChatManager;
```

---

## æ€»ç»“

æœ¬æ–¹æ¡ˆæä¾›äº†å®Œæ•´çš„å¾®ä¿¡å°ç¨‹åºå‰ç«¯èŠå¤©ç³»ç»Ÿå®ç°æ–¹æ¡ˆï¼ŒåŒ…æ‹¬ï¼š

1. âœ… **æ¶æ„è®¾è®¡** - æ¸…æ™°çš„æ¨¡å—åˆ’åˆ†å’ŒèŒè´£å®šä¹‰
2. âœ… **æ ¸å¿ƒæ¨¡å—** - ChatManager å’Œ WebSocketManager çš„è¯¦ç»†è®¾è®¡
3. âœ… **æ•°æ®æµ** - å®Œæ•´çš„æ¶ˆæ¯æµè½¬æµç¨‹
4. âœ… **UI è®¾è®¡** - é¡µé¢å’Œç»„ä»¶çš„è®¾è®¡è¦ç‚¹
5. âœ… **æ€§èƒ½ä¼˜åŒ–** - å¤šæ–¹é¢çš„ä¼˜åŒ–ç­–ç•¥
6. âœ… **é”™è¯¯å¤„ç†** - å®Œå–„çš„å®¹é”™æœºåˆ¶
7. âœ… **å®ç°æ­¥éª¤** - åˆ†é˜¶æ®µçš„å®æ–½è®¡åˆ’

æŒ‰ç…§æœ¬æ–¹æ¡ˆå®æ–½ï¼Œé¢„è®¡å¯ä»¥åœ¨ **10-15 ä¸ªå·¥ä½œæ—¥**å†…å®Œæˆå®Œæ•´çš„èŠå¤©åŠŸèƒ½å¼€å‘ã€‚

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv1.0  
**æœ€åæ›´æ–°**ï¼š2024-11-30  
**ä½œè€…**ï¼šAI Assistant
