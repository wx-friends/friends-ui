# ç¢°ç¢°äº¤å‹ç¤¾äº¤åº”ç”¨ - Javaåç«¯ç³»ç»Ÿåˆ†ææ–‡æ¡£

> **é¡¹ç›®åŸºç¡€**: wxmini-friends  
> **æŠ€æœ¯æ ˆ**: Spring Boot 2.7.18 + MyBatis-Plus + MySQL + Redis + JWT + è…¾è®¯äº‘IM  
> **æ–‡æ¡£ç‰ˆæœ¬**: v1.1ï¼ˆèŠå¤©æ¨¡å—æ”¹ç”¨ç¬¬ä¸‰æ–¹IMï¼‰  
> **ç¼–å†™æ—¥æœŸ**: 2025-01-01  
> **æ›´æ–°æ—¥æœŸ**: 2025-11-01

---

## ğŸ“‹ ç›®å½•

1. [ç³»ç»Ÿæ¦‚è¿°](#1-ç³»ç»Ÿæ¦‚è¿°)
2. [ç°æœ‰åŸºç¡€åˆ†æ](#2-ç°æœ‰åŸºç¡€åˆ†æ)
3. [æ ¸å¿ƒæ¨¡å—è®¾è®¡](#3-æ ¸å¿ƒæ¨¡å—è®¾è®¡)
4. [æ•°æ®åº“è®¾è®¡](#4-æ•°æ®åº“è®¾è®¡)
5. [æ¥å£è®¾è®¡](#5-æ¥å£è®¾è®¡)
6. [ä¼šå‘˜åŠŸèƒ½å¼€å…³è®¾è®¡](#6-ä¼šå‘˜åŠŸèƒ½å¼€å…³è®¾è®¡)
7. [å…³é”®ä¸šåŠ¡æµç¨‹](#7-å…³é”®ä¸šåŠ¡æµç¨‹)
8. [æŠ€æœ¯å®ç°æ–¹æ¡ˆ](#8-æŠ€æœ¯å®ç°æ–¹æ¡ˆ)
9. [å¼€å‘è®¡åˆ’](#9-å¼€å‘è®¡åˆ’)

---

## 1. ç³»ç»Ÿæ¦‚è¿°

### 1.1 äº§å“å®šä½
- **äº§å“åç§°**: ç¢°ç¢°ï¼ˆå¾®ä¿¡å°ç¨‹åºï¼‰
- **æ ¸å¿ƒåŠŸèƒ½**: æ‹çˆ±äº¤å‹ + æ­å­å¹³å°
- **ç›®æ ‡ç”¨æˆ·**: 18-35å²å•èº«ç”¨æˆ·
- **æ ¸å¿ƒç†å¿µ**: åšä¸€ä¸ªæ‡‚ä½ çš„æœ‹å‹

### 1.2 æŠ€æœ¯æ¶æ„
```
å¾®ä¿¡å°ç¨‹åºå‰ç«¯
    â”œâ”€â”€ ä¸šåŠ¡é€»è¾‘ï¼ˆåŒ¹é…ã€åŠ¨æ€ã€æ­å­ï¼‰
    â””â”€â”€ èŠå¤©åŠŸèƒ½ï¼ˆè…¾è®¯äº‘IM SDKï¼‰
         â†“ HTTPS
Spring Boot åº”ç”¨å±‚
    â”œâ”€â”€ Controller (æ¥å£å±‚)
    â”œâ”€â”€ Service (ä¸šåŠ¡å±‚)
    â”œâ”€â”€ Mapper (æ•°æ®å±‚)
    â””â”€â”€ Utils (å·¥å…·å±‚)
    â†“
    â”œâ”€â”€ MySQL 8.0 + Redisï¼ˆä¸šåŠ¡æ•°æ®ï¼‰
    â””â”€â”€ è…¾è®¯äº‘IMï¼ˆèŠå¤©æ¶ˆæ¯ï¼‰
```

### 1.3 å·²æœ‰ä¾èµ–
- Spring Boot Starter Web
- MyBatis-Plus 3.5.3.1
- MySQL Connector 8.0.33
- Redis
- JWT (jjwt 0.11.5)
- Hutool 5.8.20
- FastJson 1.2.83
- Swagger 3.0

### 1.4 æ–°å¢ä¾èµ–ï¼ˆèŠå¤©æ¨¡å—ï¼‰
- **è…¾è®¯äº‘IMæœåŠ¡ç«¯SDK** (tencentcloud-sdk-java-im 3.1.800)
  - ç”¨äºç”ŸæˆUserSigã€åŒæ­¥ç”¨æˆ·èµ„æ–™ã€å¤„ç†IMå›è°ƒ
  - å‰æœŸå…è´¹ï¼ˆ100ä¸‡DAUä»¥ä¸‹ï¼‰
- **å¾®ä¿¡å°ç¨‹åºç«¯SDK** (tim-wx-sdk)
  - å‰ç«¯é›†æˆï¼Œå¤„ç†å³æ—¶é€šè®¯

---

## 2. ç°æœ‰åŸºç¡€åˆ†æ

### 2.1 å·²å®ç°åŠŸèƒ½

#### 2.1.1 ç”¨æˆ·è®¤è¯æ¨¡å—
**WxAuthController** - å¾®ä¿¡ç™»å½•è®¤è¯
```java
ç°æœ‰æ¥å£ï¼š
- POST /api/auth/wx/login        // å¾®ä¿¡ç™»å½•
- GET  /api/auth/user/info       // è·å–ç”¨æˆ·ä¿¡æ¯
- POST /api/auth/token/refresh   // åˆ·æ–°Token

å®ç°çŠ¶æ€ï¼šâœ… å·²å®Œæˆ
æ•°æ®è¡¨ï¼št_user, t_wx_user
```

#### 2.1.2 ç”¨æˆ·èµ„æ–™æ¨¡å—
**UserProfileController** - ç”¨æˆ·èµ„æ–™ç®¡ç†
```java
ç°æœ‰æ¥å£ï¼š
- POST /api/profile/complete     // å®Œå–„èµ„æ–™
- PUT  /api/profile/update       // æ›´æ–°èµ„æ–™
- GET  /api/profile/{userId}     // æŸ¥çœ‹èµ„æ–™
- POST /api/profile/tags         // ä¿å­˜æ ‡ç­¾
- GET  /api/tags/library         // è·å–æ ‡ç­¾åº“
- POST /api/profile/photos       // ä¸Šä¼ ç…§ç‰‡

å®ç°çŠ¶æ€ï¼šâœ… å·²å®Œæˆ
æ•°æ®è¡¨ï¼št_user_profile, t_user_tags, t_user_album, t_tag_library
```

#### 2.1.3 åŸºç¡€é…ç½®
- JWTè®¤è¯æ‹¦æˆªå™¨ï¼šå·²é…ç½®
- ç»Ÿä¸€å¼‚å¸¸å¤„ç†ï¼šå·²é…ç½®
- Redisç¼“å­˜ï¼šå·²é…ç½®
- Swaggeræ–‡æ¡£ï¼šå·²é…ç½®
- æ—¥å¿—è¿½è¸ªï¼ˆTraceIdï¼‰ï¼šå·²é…ç½®

### 2.2 å¾…å¼€å‘åŠŸèƒ½

#### æ ¸å¿ƒåŠŸèƒ½æ¨¡å—
1. âŒ æ™ºèƒ½åŒ¹é…ç³»ç»Ÿï¼ˆæ ¸å¿ƒï¼‰
2. âŒ èŠå¤©é€šè®¯æ¨¡å—
3. âŒ åŠ¨æ€å¹¿åœºæ¨¡å—
4. âŒ æ­å­å¹³å°æ¨¡å—
5. âŒ çº¿ä¸‹æ´»åŠ¨æ¨¡å—
6. âŒ ä¼šå‘˜ä¸æ”¯ä»˜æ¨¡å—
7. âŒ å®åè®¤è¯æ¨¡å—ï¼ˆä¸å«å­¦å†è®¤è¯ï¼‰

---

## 3. æ ¸å¿ƒæ¨¡å—è®¾è®¡

### 3.1 æ™ºèƒ½åŒ¹é…ç³»ç»Ÿ

#### 3.1.1 æ¨¡å—æ¦‚è¿°
**æ ¸å¿ƒä»·å€¼**: åº”ç”¨çš„æœ€æ ¸å¿ƒåŠŸèƒ½ï¼Œé€šè¿‡å¤šç»´åº¦ç®—æ³•ä¸ºç”¨æˆ·æ¨èåˆé€‚çš„å¯¹è±¡

**ä¸šåŠ¡æµç¨‹**:
```
ç”¨æˆ·è¿›å…¥ä¸»é¡µ â†’ è·å–æ¨èåˆ—è¡¨ â†’ æŸ¥çœ‹ç”¨æˆ·å¡ç‰‡ â†’ 
æ‰§è¡Œæ“ä½œï¼ˆå–œæ¬¢/è·³è¿‡/è¶…çº§å–œæ¬¢ï¼‰â†’ åŒ¹é…åˆ¤å®š â†’ 
æˆåŠŸåˆ™å¯ä»¥æ— é™åˆ¶èŠå¤©ï¼ˆç”±è…¾è®¯äº‘IMå¤„ç†ï¼‰
```

#### 3.1.2 æŠ€æœ¯å®ç°è®¾è®¡

**Controllerå±‚**: `MatchingController`
```java
@RestController
@RequestMapping("/api/matching")
public class MatchingController {
    
    // è·å–æ¨èç”¨æˆ·åˆ—è¡¨
    @GetMapping("/recommend")
    public Result<Page<UserCardDTO>> recommendUsers(
        @RequestParam(defaultValue = "1") Integer page,
        @RequestParam(defaultValue = "10") Integer size,
        HttpServletRequest request
    );
    
    // å–œæ¬¢æ“ä½œ
    @PostMapping("/like")
    public Result<MatchResultDTO> likeUser(
        @RequestBody @Validated LikeRequest request,
        HttpServletRequest httpRequest
    );
    
    // è¶…çº§å–œæ¬¢æ“ä½œ
    @PostMapping("/super-like")
    public Result<MatchResultDTO> superLikeUser(
        @RequestBody @Validated SuperLikeRequest request,
        HttpServletRequest httpRequest
    );
    
    // è·³è¿‡æ“ä½œ
    @PostMapping("/pass")
    public Result<Void> passUser(
        @RequestBody @Validated PassRequest request,
        HttpServletRequest httpRequest
    );
    
    // ä¿å­˜/æ›´æ–°åŒ¹é…åå¥½
    @PostMapping("/preference")
    public Result<Void> savePreference(
        @RequestBody @Validated MatchingPreferenceRequest request,
        HttpServletRequest httpRequest
    );
    
    // è·å–åŒ¹é…åå¥½
    @GetMapping("/preference")
    public Result<MatchingPreferenceDTO> getPreference(
        HttpServletRequest request
    );
    
    // æŸ¥çœ‹è°å–œæ¬¢æˆ‘
    @GetMapping("/liked-me")
    public Result<Page<UserCardDTO>> getLikedMe(
        @RequestParam(defaultValue = "1") Integer page,
        @RequestParam(defaultValue = "10") Integer size,
        HttpServletRequest request
    );
}
```

**Serviceå±‚**: `MatchingService`
```java
@Service
public interface MatchingService {
    
    /**
     * è·å–æ¨èç”¨æˆ·åˆ—è¡¨
     * @param userId å½“å‰ç”¨æˆ·ID
     * @param page é¡µç 
     * @param size æ¯é¡µæ•°é‡
     * @return æ¨èç”¨æˆ·åˆ—è¡¨
     */
    Page<UserCardDTO> recommendUsers(Long userId, int page, int size);
    
    /**
     * å–œæ¬¢æ“ä½œ
     * @param fromUserId å‘èµ·ç”¨æˆ·ID
     * @param toUserId ç›®æ ‡ç”¨æˆ·ID
     * @param matchType åŒ¹é…ç±»å‹ï¼š1-æ™®é€šå–œæ¬¢ï¼Œ2-è¶…çº§å–œæ¬¢
     * @return åŒ¹é…ç»“æœ
     */
    MatchResultDTO likeUser(Long fromUserId, Long toUserId, int matchType);
    
    /**
     * è·³è¿‡æ“ä½œ
     * @param fromUserId å‘èµ·ç”¨æˆ·ID
     * @param toUserId ç›®æ ‡ç”¨æˆ·ID
     */
    void passUser(Long fromUserId, Long toUserId);
    
    /**
     * æ£€æŸ¥åŒ¹é…é™åˆ¶
     * @param userId ç”¨æˆ·ID
     * @param matchType åŒ¹é…ç±»å‹
     * @return æ˜¯å¦å¯ä»¥ç»§ç»­åŒ¹é…
     */
    boolean checkMatchLimit(Long userId, int matchType);
    
    /**
     * è®¡ç®—åŒ¹é…åˆ†æ•°
     * @param currentUserId å½“å‰ç”¨æˆ·ID
     * @param targetUserId ç›®æ ‡ç”¨æˆ·ID
     * @return åŒ¹é…åˆ†æ•°ï¼ˆ0-100ï¼‰
     */
    double calculateMatchScore(Long currentUserId, Long targetUserId);
}
```

#### 3.1.3 åŒ¹é…ç®—æ³•è¯¦ç»†è®¾è®¡

**ç®—æ³•æƒé‡é…ç½®**ï¼ˆå¯é€šè¿‡é…ç½®è¡¨åŠ¨æ€è°ƒæ•´ï¼‰:
```java
åœ°ç†ä½ç½®åŒ¹é…ï¼š30%
å…´è¶£æ ‡ç­¾ç›¸ä¼¼åº¦ï¼š25%
å¹´é¾„åŒ¹é…åº¦ï¼š20%
åŸºæœ¬ä¿¡æ¯åŒ¹é…ï¼š15%ï¼ˆèº«é«˜ã€èŒä¸šã€å©šå§»çŠ¶å†µç­‰ï¼‰
æ´»è·ƒåº¦ï¼š10%
```

**æ ¸å¿ƒç®—æ³•å®ç°æ€è·¯**:
```java
public double calculateMatchScore(Long userId1, Long userId2) {
    double score = 0.0;
    
    // 1. åœ°ç†ä½ç½®å¾—åˆ†ï¼ˆ30%ï¼‰
    double locationScore = calculateLocationScore(userId1, userId2);
    score += locationScore * getWeight("location");  // 0.30
    
    // 2. å…´è¶£æ ‡ç­¾ç›¸ä¼¼åº¦ï¼ˆ25%ï¼‰
    double tagScore = calculateTagSimilarity(userId1, userId2);
    score += tagScore * getWeight("tag");  // 0.25
    
    // 3. å¹´é¾„åŒ¹é…åº¦ï¼ˆ20%ï¼‰
    double ageScore = calculateAgeScore(userId1, userId2);
    score += ageScore * getWeight("age");  // 0.20
    
    // 4. åŸºæœ¬ä¿¡æ¯åŒ¹é…ï¼ˆ15%ï¼‰
    double basicScore = calculateBasicInfoScore(userId1, userId2);
    score += basicScore * getWeight("basic");  // 0.15
    
    // 5. æ´»è·ƒåº¦å¾—åˆ†ï¼ˆ10%ï¼‰
    double activityScore = calculateActivityScore(userId2);
    score += activityScore * getWeight("activity");  // 0.10
    
    return score;
}

// åœ°ç†ä½ç½®å¾—åˆ†è®¡ç®—
private double calculateLocationScore(Long userId1, Long userId2) {
    // ä½¿ç”¨Haversineå…¬å¼è®¡ç®—è·ç¦»
    // è·ç¦»è¶Šè¿‘åˆ†æ•°è¶Šé«˜
    // è¿”å›0-100åˆ†
}

// å…´è¶£æ ‡ç­¾ç›¸ä¼¼åº¦è®¡ç®—ï¼ˆJaccardç›¸ä¼¼åº¦ï¼‰
private double calculateTagSimilarity(Long userId1, Long userId2) {
    Set<String> tags1 = getUserTags(userId1);
    Set<String> tags2 = getUserTags(userId2);
    
    // äº¤é›†
    Set<String> intersection = new HashSet<>(tags1);
    intersection.retainAll(tags2);
    
    // å¹¶é›†
    Set<String> union = new HashSet<>(tags1);
    union.addAll(tags2);
    
    if (union.isEmpty()) return 0;
    
    double similarity = (double) intersection.size() / union.size();
    return similarity * 100;
}
```

#### 3.1.4 åŒ¹é…é™åˆ¶é€»è¾‘

**ä¼šå‘˜åŠŸèƒ½å¼€å…³æ§åˆ¶**:
```java
@Service
public class MatchLimitService {
    
    public boolean checkMatchLimit(Long userId, int matchType) {
        // 1. è¯»å–ä¼šå‘˜åŠŸèƒ½å¼€å…³
        boolean vipEnabled = systemConfigService.getBoolean(
            "vip.feature.enabled", false
        );
        
        // 2. å¦‚æœä¼šå‘˜åŠŸèƒ½å…³é—­ï¼Œå…¨åŠŸèƒ½å…è´¹
        if (!vipEnabled) {
            return true;  // ä¸é™åˆ¶
        }
        
        // 3. ä¼šå‘˜åŠŸèƒ½å¼€å¯ï¼Œæ£€æŸ¥VIPçŠ¶æ€
        VipMember vip = vipService.getValidVip(userId);
        if (vip != null) {
            return true;  // VIPç”¨æˆ·ä¸é™åˆ¶
        }
        
        // 4. éVIPç”¨æˆ·æ£€æŸ¥æ¯æ—¥é™åˆ¶
        MatchLimit limit = getOrCreateTodayLimit(userId);
        
        if (matchType == 1) {
            // æ™®é€šå–œæ¬¢
            int freeLimit = systemConfigService.getInt(
                "vip.daily.free.match.count", 3
            );
            return limit.getFreeMatchCount() < freeLimit;
        } else if (matchType == 2) {
            // è¶…çº§å–œæ¬¢
            int superLikeLimit = systemConfigService.getInt(
                "vip.daily.free.super.like.count", 1
            );
            return limit.getSuperLikeCount() < superLikeLimit;
        }
        
        return false;
    }
    
    // è·å–æˆ–åˆ›å»ºä»Šæ—¥é™åˆ¶è®°å½•
    private MatchLimit getOrCreateTodayLimit(Long userId) {
        LocalDate today = LocalDate.now();
        MatchLimit limit = matchLimitMapper.selectOne(
            new LambdaQueryWrapper<MatchLimit>()
                .eq(MatchLimit::getUserId, userId)
                .eq(MatchLimit::getDate, today)
        );
        
        if (limit == null) {
            limit = new MatchLimit();
            limit.setUserId(userId);
            limit.setDate(today);
            limit.setFreeMatchCount(0);
            limit.setSuperLikeCount(0);
            matchLimitMapper.insert(limit);
        }
        
        return limit;
    }
}
```

---

### 3.2 èŠå¤©é€šè®¯æ¨¡å—

#### 3.2.1 æ¨¡å—æ¦‚è¿°
**æ ¸å¿ƒåŠŸèƒ½**: ç”¨æˆ·ä¹‹é—´çš„å³æ—¶é€šè®¯ï¼Œæ”¯æŒæ–‡å­—å’Œå›¾ç‰‡æ¶ˆæ¯

**é˜²éªšæ‰°æœºåˆ¶**: 
- æœªåŒ¹é…ç”¨æˆ·ï¼šåªèƒ½å‘é€1æ¡æ¶ˆæ¯ï¼Œå¯¹æ–¹å›å¤åè§£é™¤é™åˆ¶
- å·²åŒ¹é…ç”¨æˆ·ï¼šæ— é™åˆ¶æ­£å¸¸èŠå¤©

#### 3.2.2 æŠ€æœ¯æ–¹æ¡ˆé€‰å‹ï¼šç¬¬ä¸‰æ–¹IMæœåŠ¡ï¼ˆæ¨èï¼‰

**ğŸ’¡ ä¸ºä»€ä¹ˆä½¿ç”¨ç¬¬ä¸‰æ–¹IMæœåŠ¡ï¼Ÿ**

ä½¿ç”¨ç¬¬ä¸‰æ–¹IMæœåŠ¡ç›¸æ¯”è‡ªå»ºèŠå¤©ç³»ç»Ÿæœ‰ä»¥ä¸‹ä¼˜åŠ¿ï¼š

| å¯¹æ¯”é¡¹ | è‡ªå»ºç³»ç»Ÿ | ç¬¬ä¸‰æ–¹IM |
|-------|---------|----------|
| **å¼€å‘æˆæœ¬** | éœ€å¼€å‘WebSocketã€æ¶ˆæ¯å­˜å‚¨ã€æ¨é€ç³»ç»Ÿ | SDKé›†æˆï¼Œ2-3å¤©å®Œæˆ |
| **ç¨³å®šæ€§** | éœ€å¤„ç†å„ç§å¼‚å¸¸åœºæ™¯ | ç»è¿‡äº¿çº§ç”¨æˆ·éªŒè¯ |
| **åŠŸèƒ½** | åŸºç¡€èŠå¤©ï¼Œæ‰©å±•å›°éš¾ | æ¶ˆæ¯æ’¤å›ã€å¤šåª’ä½“ã€ç¾¤èŠç­‰å¼€ç®±å³ç”¨ |
| **è¿ç»´** | éœ€ä¸“äººç»´æŠ¤æœåŠ¡å™¨ã€ç›‘æ§ã€æ‰©å®¹ | å®˜æ–¹è¿ç»´ï¼ŒæŒ‰é‡ä»˜è´¹ |
| **å¤šç«¯åŒæ­¥** | éœ€è‡ªè¡Œå®ç° | åŸç”Ÿæ”¯æŒå¤šç«¯æ¶ˆæ¯åŒæ­¥ |
| **ç¦»çº¿æ¨é€** | éœ€å¯¹æ¥æ¨é€æœåŠ¡ | å†…ç½®ç¦»çº¿æ¨é€èƒ½åŠ› |

**âœ… æ¨èæ–¹æ¡ˆï¼šè…¾è®¯äº‘IMï¼ˆTencent Cloud IMï¼‰**

é€‰æ‹©ç†ç”±ï¼š
1. **å°ç¨‹åºå‹å¥½**ï¼šå®˜æ–¹æä¾›å¾®ä¿¡å°ç¨‹åºSDKï¼Œé›†æˆç®€å•
2. **åŠŸèƒ½ä¸°å¯Œ**ï¼šæ”¯æŒå•èŠã€ç¾¤èŠã€ç¦»çº¿æ¨é€ã€æ¶ˆæ¯æ’¤å›ã€å·²è¯»å›æ‰§
3. **æ€§ä»·æ¯”é«˜**ï¼šæä¾›å…è´¹é¢åº¦ï¼ˆ100ä¸‡DAUä»¥ä¸‹ï¼‰ï¼ŒæŒ‰é‡ä»˜è´¹
4. **æ–‡æ¡£å®Œå–„**ï¼šä¸­æ–‡æ–‡æ¡£é½å…¨ï¼Œç¤ºä¾‹ä»£ç ä¸°å¯Œ
5. **ç¨³å®šå¯é **ï¼šQQã€å¾®ä¿¡åŒæ¬¾åº•å±‚æŠ€æœ¯

**å¤‡é€‰æ–¹æ¡ˆ**ï¼š
- èäº‘ï¼ˆRongyunï¼‰ï¼šæ€§èƒ½ä¼˜ç§€ï¼Œä½†ä»·æ ¼åé«˜
- ç¯ä¿¡ï¼ˆEasemobï¼‰ï¼šåŠŸèƒ½å…¨é¢ï¼Œé€‚åˆå¤§å‹ä¼ä¸š

#### 3.2.3 åç«¯é›†æˆæ–¹æ¡ˆ

**ä¾èµ–æ·»åŠ ** (`pom.xml`)ï¼š
```xml
<!-- è…¾è®¯äº‘IMæœåŠ¡ç«¯SDK -->
<dependency>
    <groupId>com.tencentcloudapi</groupId>
    <artifactId>tencentcloud-sdk-java-im</artifactId>
    <version>3.1.800</version>
</dependency>
```

**é…ç½®æ–‡ä»¶** (`application.yml`)ï¼š
```yaml
tencent:
  im:
    sdk-app-id: ä½ çš„SDKAPPID
    secret-key: ä½ çš„å¯†é’¥
    admin-user-id: administrator  # ç®¡ç†å‘˜UserID
```

**é…ç½®ç±»**ï¼š
```java
@Configuration
@ConfigurationProperties(prefix = "tencent.im")
@Data
public class TencentImConfig {
    private Long sdkAppId;
    private String secretKey;
    private String adminUserId;
}
```

#### 3.2.4 æ ¸å¿ƒåŠŸèƒ½å®ç°

**Controllerå±‚**: `ChatController`
```java
@RestController
@RequestMapping("/api/chat")
@Api(tags = "èŠå¤©æ¨¡å—")
public class ChatController {
    
    @Autowired
    private TencentImService tencentImService;
    
    @Autowired
    private ChatPermissionService chatPermissionService;
    
    /**
     * ç”ŸæˆIMç”¨æˆ·ç­¾åï¼ˆUserSigï¼‰
     * å°ç¨‹åºç«¯éœ€è¦UserSigæ‰èƒ½ç™»å½•IM
     */
    @GetMapping("/user-sig")
    @ApiOperation("è·å–IMç™»å½•å‡­è¯")
    public Result<UserSigDTO> getUserSig(HttpServletRequest request) {
        Long userId = JwtUtils.getUserIdFromRequest(request);
        String userSig = tencentImService.generateUserSig(userId.toString());
        
        return Result.success(UserSigDTO.builder()
            .userId(userId.toString())
            .userSig(userSig)
            .sdkAppId(tencentImService.getSdkAppId())
            .build());
    }
    
    /**
     * æ£€æŸ¥å‘é€æƒé™ï¼ˆé˜²éªšæ‰°ï¼‰
     * åœ¨å°ç¨‹åºå‘é€æ¶ˆæ¯å‰å…ˆè°ƒç”¨æ­¤æ¥å£
     */
    @PostMapping("/check-permission")
    @ApiOperation("æ£€æŸ¥å‘é€æƒé™")
    public Result<ChatPermissionDTO> checkSendPermission(
        @RequestBody @Validated CheckPermissionRequest request,
        HttpServletRequest httpRequest
    ) {
        Long senderId = JwtUtils.getUserIdFromRequest(httpRequest);
        Long receiverId = request.getReceiverId();
        
        ChatPermissionDTO permission = chatPermissionService
            .checkPermission(senderId, receiverId);
        
        return Result.success(permission);
    }
    
    /**
     * æ¶ˆæ¯å‘é€å›è°ƒï¼ˆç”±è…¾è®¯äº‘IMå›è°ƒï¼‰
     * ç”¨äºè®°å½•æ¶ˆæ¯ã€æ›´æ–°é˜²éªšæ‰°è®¡æ•°
     */
    @PostMapping("/callback/after-send-msg")
    @ApiOperation("æ¶ˆæ¯å‘é€åå›è°ƒ")
    public CallbackResponse afterSendMsg(
        @RequestBody TencentImCallback callback
    ) {
        // è§£ææ¶ˆæ¯
        Long senderId = Long.parseLong(callback.getFromAccount());
        Long receiverId = Long.parseLong(callback.getToAccount());
        
        // æ›´æ–°é˜²éªšæ‰°è®°å½•
        chatPermissionService.recordMessage(senderId, receiverId);
        
        // è¿”å›æˆåŠŸï¼Œè®©æ¶ˆæ¯æ­£å¸¸å‘é€
        return CallbackResponse.success();
    }
    
    /**
     * åŒæ­¥ç”¨æˆ·èµ„æ–™åˆ°IMç³»ç»Ÿ
     */
    @PostMapping("/sync-profile")
    @ApiOperation("åŒæ­¥ç”¨æˆ·èµ„æ–™")
    public Result<Void> syncUserProfile(HttpServletRequest request) {
        Long userId = JwtUtils.getUserIdFromRequest(request);
        tencentImService.syncUserProfile(userId);
        return Result.success();
    }
}
```

**Serviceå±‚**: `TencentImService`
```java
@Service
@Slf4j
public class TencentImService {
    
    @Autowired
    private TencentImConfig config;
    
    @Autowired
    private UserProfileMapper userProfileMapper;
    
    /**
     * ç”ŸæˆUserSigï¼ˆç”¨æˆ·ç™»å½•IMçš„å‡­è¯ï¼‰
     */
    public String generateUserSig(String userId) {
        try {
            TLSSigAPIv2 api = new TLSSigAPIv2(
                config.getSdkAppId(), 
                config.getSecretKey()
            );
            // æœ‰æ•ˆæœŸ7å¤©
            return api.genUserSig(userId, 7 * 24 * 3600);
        } catch (Exception e) {
            log.error("ç”ŸæˆUserSigå¤±è´¥", e);
            throw new BusinessException("ç”ŸæˆIMç™»å½•å‡­è¯å¤±è´¥");
        }
    }
    
    /**
     * åŒæ­¥ç”¨æˆ·èµ„æ–™åˆ°IMç³»ç»Ÿ
     * åœ¨ç”¨æˆ·é¦–æ¬¡ç™»å½•æˆ–ä¿®æ”¹èµ„æ–™åè°ƒç”¨
     */
    public void syncUserProfile(Long userId) {
        UserProfile profile = userProfileMapper.selectById(userId);
        
        try {
            // æ„å»ºIMç”¨æˆ·èµ„æ–™
            PortraitSetRequest request = new PortraitSetRequest();
            request.setFromAccount(userId.toString());
            
            ProfileItem[] items = new ProfileItem[]{
                new ProfileItem("Tag_Profile_IM_Nick", profile.getNickname()),
                new ProfileItem("Tag_Profile_IM_Image", profile.getAvatarUrl()),
                new ProfileItem("Tag_Profile_IM_Gender", 
                    profile.getGender() == 1 ? "Gender_Type_Male" : "Gender_Type_Female")
            };
            request.setProfileItem(items);
            
            // è°ƒç”¨APIåŒæ­¥
            ImClient.getImService().portraitSet(request);
            
        } catch (Exception e) {
            log.error("åŒæ­¥ç”¨æˆ·èµ„æ–™å¤±è´¥", e);
            // ä¸æŠ›å¼‚å¸¸ï¼Œé¿å…å½±å“ä¸»æµç¨‹
        }
    }
    
    public Long getSdkAppId() {
        return config.getSdkAppId();
    }
}
```

#### 3.2.5 é˜²éªšæ‰°é€»è¾‘è®¾è®¡

**Serviceå±‚**: `ChatPermissionService`
```java
@Service
@Slf4j
public class ChatPermissionService {
    
    @Autowired
    private ChatLimitMapper chatLimitMapper;
    
    @Autowired
    private MatchRecordMapper matchRecordMapper;
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    /**
     * æ£€æŸ¥å‘é€æƒé™
     */
    public ChatPermissionDTO checkPermission(Long senderId, Long receiverId) {
        // 1. æ£€æŸ¥æ˜¯å¦å·²åŒ¹é…
        boolean isMatched = checkIfMatched(senderId, receiverId);
        
        if (isMatched) {
            return ChatPermissionDTO.builder()
                .canSend(true)
                .unlimited(true)
                .reason("å·²åŒ¹é…ç”¨æˆ·ï¼Œæ— é™åˆ¶èŠå¤©")
                .build();
        }
        
        // 2. æœªåŒ¹é…ç”¨æˆ·ï¼Œæ£€æŸ¥é˜²éªšæ‰°é™åˆ¶
        String cacheKey = String.format("chat:limit:%d:%d", senderId, receiverId);
        Integer sentCount = (Integer) redisTemplate.opsForValue().get(cacheKey);
        
        if (sentCount == null) {
            // ä»æ•°æ®åº“æŸ¥è¯¢
            ChatLimit limit = chatLimitMapper.selectOne(
                new LambdaQueryWrapper<ChatLimit>()
                    .eq(ChatLimit::getSenderId, senderId)
                    .eq(ChatLimit::getReceiverId, receiverId)
            );
            sentCount = (limit != null) ? limit.getUnrepliedCount() : 0;
        }
        
        boolean canSend = sentCount < 1;  // æœªåŒ¹é…æœ€å¤šå‘1æ¡
        
        return ChatPermissionDTO.builder()
            .canSend(canSend)
            .unlimited(false)
            .remainingCount(canSend ? (1 - sentCount) : 0)
            .reason(canSend ? "å¯ä»¥å‘é€" : "å¯¹æ–¹æœªå›å¤ï¼Œæš‚æ—¶æ— æ³•ç»§ç»­å‘é€")
            .build();
    }
    
    /**
     * è®°å½•æ¶ˆæ¯å‘é€ï¼ˆç”±IMå›è°ƒè§¦å‘ï¼‰
     */
    public void recordMessage(Long senderId, Long receiverId) {
        // 1. æ£€æŸ¥æ˜¯å¦å·²åŒ¹é…
        if (checkIfMatched(senderId, receiverId)) {
            return;  // å·²åŒ¹é…ç”¨æˆ·æ— éœ€è®°å½•
        }
        
        // 2. æ›´æ–°é™åˆ¶è®°å½•
        String cacheKey = String.format("chat:limit:%d:%d", senderId, receiverId);
        redisTemplate.opsForValue().increment(cacheKey);
        redisTemplate.expire(cacheKey, 7, TimeUnit.DAYS);
        
        // 3. å¼‚æ­¥æ›´æ–°æ•°æ®åº“
        CompletableFuture.runAsync(() -> {
            ChatLimit limit = chatLimitMapper.selectOne(
                new LambdaQueryWrapper<ChatLimit>()
                    .eq(ChatLimit::getSenderId, senderId)
                    .eq(ChatLimit::getReceiverId, receiverId)
            );
            
            if (limit == null) {
                limit = new ChatLimit();
                limit.setSenderId(senderId);
                limit.setReceiverId(receiverId);
                limit.setUnrepliedCount(1);
                chatLimitMapper.insert(limit);
            } else {
                limit.setUnrepliedCount(limit.getUnrepliedCount() + 1);
                chatLimitMapper.updateById(limit);
            }
        });
    }
    
    /**
     * æ¸…é™¤é™åˆ¶ï¼ˆå¯¹æ–¹å›å¤åï¼‰
     */
    public void clearLimit(Long senderId, Long receiverId) {
        String cacheKey = String.format("chat:limit:%d:%d", receiverId, senderId);
        redisTemplate.delete(cacheKey);
        
        // å¼‚æ­¥æ¸…é™¤æ•°æ®åº“è®°å½•
        CompletableFuture.runAsync(() -> {
            chatLimitMapper.delete(
                new LambdaQueryWrapper<ChatLimit>()
                    .eq(ChatLimit::getSenderId, receiverId)
                    .eq(ChatLimit::getReceiverId, senderId)
            );
        });
    }
    
    private boolean checkIfMatched(Long user1Id, Long user2Id) {
        Integer count = matchRecordMapper.selectCount(
            new LambdaQueryWrapper<MatchRecord>()
                .eq(MatchRecord::getMatchStatus, 2)  // å·²åŒ¹é…
                .and(w -> w
                    .and(w1 -> w1
                        .eq(MatchRecord::getUserId, user1Id)
                        .eq(MatchRecord::getTargetUserId, user2Id)
                    )
                    .or(w2 -> w2
                        .eq(MatchRecord::getUserId, user2Id)
                        .eq(MatchRecord::getTargetUserId, user1Id)
                    )
                )
        );
        return count > 0;
    }
}
```

#### 3.2.6 å°ç¨‹åºç«¯é›†æˆç¤ºä¾‹

**å®‰è£…IM SDK**ï¼š
```bash
npm install tim-wx-sdk --save
```

**åˆå§‹åŒ–IM**ï¼š
```javascript
// app.js
import TIM from 'tim-wx-sdk';

App({
  onLaunch() {
    // åˆå§‹åŒ–è…¾è®¯äº‘IM
    this.tim = TIM.create({
      SDKAppID: this.globalData.sdkAppId
    });
    
    // è®¾ç½®æ—¥å¿—çº§åˆ«
    this.tim.setLogLevel(0); // 0: æ™®é€šï¼Œ1: releaseï¼Œ2: warnï¼Œ3: error
  },
  
  async loginIM(userId, userSig) {
    try {
      await this.tim.login({
        userID: userId.toString(),
        userSig: userSig
      });
      console.log('IMç™»å½•æˆåŠŸ');
    } catch (error) {
      console.error('IMç™»å½•å¤±è´¥', error);
    }
  }
})
```

**å‘é€æ¶ˆæ¯å‰æ£€æŸ¥æƒé™**ï¼š
```javascript
// pages/chat/chat.js
async sendMessage(content) {
  // 1. å…ˆè°ƒç”¨åç«¯æ£€æŸ¥æƒé™
  const permissionRes = await wx.request({
    url: `${baseUrl}/api/chat/check-permission`,
    method: 'POST',
    data: {
      receiverId: this.data.receiverId
    },
    header: {
      'Authorization': `Bearer ${token}`
    }
  });
  
  if (!permissionRes.data.data.canSend) {
    wx.showToast({
      title: permissionRes.data.data.reason,
      icon: 'none'
    });
    return;
  }
  
  // 2. æƒé™é€šè¿‡ï¼Œä½¿ç”¨IM SDKå‘é€æ¶ˆæ¯
  const message = this.tim.createTextMessage({
    to: this.data.receiverId.toString(),
    conversationType: TIM.TYPES.CONV_C2C,
    payload: {
      text: content
    }
  });
  
  try {
    const res = await this.tim.sendMessage(message);
    console.log('æ¶ˆæ¯å‘é€æˆåŠŸ', res);
  } catch (error) {
    console.error('æ¶ˆæ¯å‘é€å¤±è´¥', error);
    wx.showToast({
      title: 'å‘é€å¤±è´¥',
      icon: 'none'
    });
  }
}
```

#### 3.2.7 æ•°æ®åº“è¡¨ç®€åŒ–è®¾è®¡

ä½¿ç”¨ç¬¬ä¸‰æ–¹IMåï¼Œåªéœ€ä¿ç•™**é˜²éªšæ‰°é™åˆ¶è¡¨**ï¼Œæ¶ˆæ¯å­˜å‚¨ç”±è…¾è®¯äº‘IMè´Ÿè´£ï¼š

```sql
-- èŠå¤©é™åˆ¶è¡¨ï¼ˆé˜²éªšæ‰°ï¼‰
CREATE TABLE `t_chat_limit` (
  `id` BIGINT PRIMARY KEY AUTO_INCREMENT,
  `sender_id` BIGINT NOT NULL COMMENT 'å‘é€è€…ID',
  `receiver_id` BIGINT NOT NULL COMMENT 'æ¥æ”¶è€…ID',
  `unreplied_count` INT DEFAULT 0 COMMENT 'æœªå›å¤æ¶ˆæ¯æ•°',
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP,
  `updated_at` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  UNIQUE KEY `uk_sender_receiver` (`sender_id`, `receiver_id`),
  KEY `idx_receiver` (`receiver_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='èŠå¤©é™åˆ¶è¡¨';
```

**å¯¹æ¯”åŸè®¾è®¡**ï¼š
- âœ… ä¸å†éœ€è¦ `t_chat_session` å’Œ `t_chat_message` è¡¨
- âœ… èŠ‚çœæ•°æ®åº“å­˜å‚¨å’Œç»´æŠ¤æˆæœ¬
- âœ… æ¶ˆæ¯å†å²ã€å·²è¯»çŠ¶æ€ç”±IM SDKå¤„ç†

#### 3.2.8 è…¾è®¯äº‘IMå›è°ƒé…ç½®

åœ¨è…¾è®¯äº‘IMæ§åˆ¶å°é…ç½®å›è°ƒåœ°å€ï¼š

**å›è°ƒåœ°å€**ï¼š`https://yourdomain.com/api/chat/callback/after-send-msg`

**å¯ç”¨çš„å›è°ƒ**ï¼š
- å•èŠæ¶ˆæ¯å‘é€åå›è°ƒï¼šç”¨äºé˜²éªšæ‰°è®¡æ•°
- å•èŠæ¶ˆæ¯å·²è¯»å›è°ƒï¼šç”¨äºæ¸…é™¤é™åˆ¶

**å›è°ƒé‰´æƒ**ï¼ˆå¯é€‰ï¼‰ï¼š
```java
@Component
public class TencentImCallbackValidator {
    
    @Autowired
    private TencentImConfig config;
    
    public boolean validate(HttpServletRequest request) {
        String timestamp = request.getHeader("X-TC-Timestamp");
        String signature = request.getHeader("X-TC-Signature");
        
        // éªŒè¯ç­¾åé€»è¾‘
        String expectedSig = generateSignature(timestamp, config.getSecretKey());
        return expectedSig.equals(signature);
    }
}
```

#### 3.2.9 è´¹ç”¨è¯´æ˜

**è…¾è®¯äº‘IMå…è´¹é¢åº¦**ï¼ˆè¶³å¤Ÿå‰æœŸä½¿ç”¨ï¼‰ï¼š
- DAUï¼ˆæ—¥æ´»ç”¨æˆ·æ•°ï¼‰ï¼š100ä¸‡ä»¥ä¸‹å…è´¹
- å³°å€¼åœ¨çº¿ï¼š100ä¸‡ä»¥ä¸‹å…è´¹
- ç¾¤ç»„æ•°é‡ï¼š10ä¸‡ä¸ªå…è´¹
- å†å²æ¶ˆæ¯å­˜å‚¨ï¼š7å¤©å…è´¹

**ä»˜è´¹æ–¹å¼**ï¼ˆåæœŸæ‰©å±•ï¼‰ï¼š
- æŒ‰DAUæ”¶è´¹ï¼š100ä¸‡-500ä¸‡DAUï¼Œçº¦ Â¥0.008/DAU/å¤©
- å†å²æ¶ˆæ¯å­˜å‚¨æ‰©å±•ï¼š30å¤©/90å¤©å¯é€‰

**ğŸ’° æˆæœ¬å¯¹æ¯”**ï¼š
- è‡ªå»ºç³»ç»Ÿï¼šæœåŠ¡å™¨ + å¼€å‘ + è¿ç»´ â‰ˆ Â¥5000+/æœˆ
- ç¬¬ä¸‰æ–¹IMï¼šå‰æœŸå…è´¹ï¼ŒåæœŸ â‰ˆ Â¥2000/æœˆï¼ˆ10ä¸‡DAUï¼‰

---

### 3.3 åŠ¨æ€å¹¿åœºæ¨¡å—

#### 3.3.1 æ¨¡å—æ¦‚è¿°
**æ ¸å¿ƒåŠŸèƒ½**: ç”¨æˆ·å‘å¸ƒå’Œæµè§ˆåŠ¨æ€ï¼Œè¿›è¡Œç¤¾äº¤äº’åŠ¨

**ä¸»è¦åŠŸèƒ½**:
- å‘å¸ƒåŠ¨æ€ï¼ˆæ–‡å­—+å›¾ç‰‡+ä½ç½®ï¼‰
- æµè§ˆé™„è¿‘åŠ¨æ€
- ç‚¹èµã€è¯„è®º
- åŠ¨æ€å®¡æ ¸

#### 3.3.2 æŠ€æœ¯å®ç°è®¾è®¡

**Controllerå±‚**: `MomentController`
```java
@RestController
@RequestMapping("/api/moments")
public class MomentController {
    
    // è·å–åŠ¨æ€åˆ—è¡¨
    @GetMapping("/list")
    public Result<Page<MomentDTO>> getMoments(
        @RequestParam(required = false) Double latitude,
        @RequestParam(required = false) Double longitude,
        @RequestParam(defaultValue = "1") Integer page,
        @RequestParam(defaultValue = "10") Integer size,
        HttpServletRequest request
    );
    
    // è·å–åŠ¨æ€è¯¦æƒ…
    @GetMapping("/{momentId}")
    public Result<MomentDetailDTO> getMomentDetail(
        @PathVariable Long momentId,
        HttpServletRequest request
    );
    
    // å‘å¸ƒåŠ¨æ€
    @PostMapping("/publish")
    public Result<MomentDTO> publishMoment(
        @RequestBody @Validated PublishMomentRequest request,
        HttpServletRequest httpRequest
    );
    
    // ç‚¹èµåŠ¨æ€
    @PostMapping("/like")
    public Result<Void> likeMoment(
        @RequestBody @Validated LikeMomentRequest request,
        HttpServletRequest httpRequest
    );
    
    // å–æ¶ˆç‚¹èµ
    @DeleteMapping("/unlike")
    public Result<Void> unlikeMoment(
        @RequestParam Long momentId,
        HttpServletRequest request
    );
    
    // è¯„è®ºåŠ¨æ€
    @PostMapping("/comment")
    public Result<CommentDTO> commentMoment(
        @RequestBody @Validated CommentRequest request,
        HttpServletRequest httpRequest
    );
    
    // è·å–è¯„è®ºåˆ—è¡¨
    @GetMapping("/{momentId}/comments")
    public Result<Page<CommentDTO>> getComments(
        @PathVariable Long momentId,
        @RequestParam(defaultValue = "1") Integer page,
        @RequestParam(defaultValue = "20") Integer size
    );
    
    // æ£€æŸ¥å‘å¸ƒé™åˆ¶
    @GetMapping("/check-limit")
    public Result<PublishLimitDTO> checkPublishLimit(
        HttpServletRequest request
    );
}
```

**Serviceå±‚**: `MomentService`
```java
@Service
public interface MomentService {
    
    /**
     * å‘å¸ƒåŠ¨æ€
     * @param userId ç”¨æˆ·ID
     * @param request å‘å¸ƒè¯·æ±‚
     * @return åŠ¨æ€ä¿¡æ¯
     */
    MomentDTO publishMoment(Long userId, PublishMomentRequest request);
    
    /**
     * è·å–åŠ¨æ€åˆ—è¡¨ï¼ˆæŒ‰è·ç¦»æ’åºï¼‰
     * @param userId å½“å‰ç”¨æˆ·ID
     * @param latitude çº¬åº¦
     * @param longitude ç»åº¦
     * @param page é¡µç 
     * @param size æ¯é¡µæ•°é‡
     * @return åŠ¨æ€åˆ—è¡¨
     */
    Page<MomentDTO> getMoments(Long userId, Double latitude, Double longitude, 
                               int page, int size);
    
    /**
     * æ£€æŸ¥å‘å¸ƒé™åˆ¶ï¼ˆæ¯æ—¥3æ¡ï¼‰
     * @param userId ç”¨æˆ·ID
     * @return ä»Šæ—¥è¿˜å¯å‘å¸ƒæ•°é‡
     */
    int checkPublishLimit(Long userId);
    
    /**
     * å†…å®¹å®¡æ ¸
     * @param content åŠ¨æ€å†…å®¹
     * @return å®¡æ ¸ç»“æœ
     */
    AuditResult auditContent(String content);
}
```

#### 3.3.3 å†…å®¹å®¡æ ¸æœºåˆ¶

```java
@Service
public class ContentAuditService {
    
    @Autowired
    private SensitiveWordFilter sensitiveWordFilter;
    
    public AuditResult auditContent(String content, List<String> imageUrls) {
        // 1. æ•æ„Ÿè¯è¿‡æ»¤
        if (sensitiveWordFilter.contains(content)) {
            return AuditResult.reject("å†…å®¹åŒ…å«æ•æ„Ÿè¯");
        }
        
        // 2. è°ƒç”¨ç¬¬ä¸‰æ–¹å†…å®¹å®¡æ ¸APIï¼ˆè…¾è®¯äº‘ã€é˜¿é‡Œäº‘ï¼‰
        // è¿™é‡Œä½¿ç”¨åŒæ­¥å®¡æ ¸ï¼Œå°ç¨‹åºåœºæ™¯å¯ä»¥æ¥å—
        try {
            // è°ƒç”¨å®¡æ ¸API
            ContentAuditResponse response = thirdPartyAuditService.audit(
                content, imageUrls
            );
            
            if (response.isPass()) {
                return AuditResult.pass();
            } else if (response.isReview()) {
                // ç–‘ä¼¼è¿è§„ï¼Œè¿›å…¥äººå·¥å®¡æ ¸é˜Ÿåˆ—
                return AuditResult.review();
            } else {
                return AuditResult.reject(response.getReason());
            }
        } catch (Exception e) {
            log.error("å†…å®¹å®¡æ ¸å¤±è´¥", e);
            // å®¡æ ¸å¤±è´¥é»˜è®¤é€šè¿‡ï¼Œé¿å…å½±å“ç”¨æˆ·ä½“éªŒ
            // å¯ä»¥å¼‚æ­¥è¿›è¡ŒäºŒæ¬¡å®¡æ ¸
            return AuditResult.pass();
        }
    }
}
```

---

### 3.4 æ­å­å¹³å°æ¨¡å—

#### 3.4.1 æ¨¡å—æ¦‚è¿°
**æ ¸å¿ƒåŠŸèƒ½**: ç”¨æˆ·å‘å¸ƒå’Œå‚ä¸æ­å­æ´»åŠ¨ï¼ˆè¿åŠ¨ã€å­¦ä¹ ã€æ—…æ¸¸ç­‰ï¼‰

**æ´»åŠ¨ç±»å‹**:
- è¿åŠ¨æ­å­ï¼ˆç¾½æ¯›çƒã€ç¯®çƒã€è·‘æ­¥ç­‰ï¼‰
- å­¦ä¹ æ­å­ï¼ˆå›¾ä¹¦é¦†ã€è‡ªä¹ å®¤ï¼‰
- æ—…æ¸¸æ­å­ï¼ˆå‘¨æœ«æ¸¸ã€é•¿é€”æ¸¸ï¼‰
- å¥èº«æ­å­ï¼ˆå¥èº«æˆ¿ã€ç‘œä¼½ï¼‰
- çˆ±å¥½æ­å­ï¼ˆæ‘„å½±ã€éŸ³ä¹ã€æ‰‹å·¥ç­‰ï¼‰

#### 3.4.2 æŠ€æœ¯å®ç°è®¾è®¡

**Controllerå±‚**: `BuddyController`
```java
@RestController
@RequestMapping("/api/buddy")
public class BuddyController {
    
    // è·å–æ­å­æ´»åŠ¨åˆ—è¡¨
    @GetMapping("/activities")
    public Result<Page<BuddyActivityDTO>> getActivities(
        @RequestParam(required = false) String type,  // all/sport/study/travelç­‰
        @RequestParam(required = false) Double latitude,
        @RequestParam(required = false) Double longitude,
        @RequestParam(defaultValue = "1") Integer page,
        @RequestParam(defaultValue = "10") Integer size,
        HttpServletRequest request
    );
    
    // è·å–æ´»åŠ¨è¯¦æƒ…
    @GetMapping("/activities/{activityId}")
    public Result<BuddyActivityDetailDTO> getActivityDetail(
        @PathVariable Long activityId,
        HttpServletRequest request
    );
    
    // å‘å¸ƒæ­å­æ´»åŠ¨
    @PostMapping("/publish")
    public Result<BuddyActivityDTO> publishActivity(
        @RequestBody @Validated PublishBuddyRequest request,
        HttpServletRequest httpRequest
    );
    
    // æŠ¥åæ´»åŠ¨
    @PostMapping("/register")
    public Result<Void> registerActivity(
        @RequestBody @Validated RegisterRequest request,
        HttpServletRequest httpRequest
    );
    
    // å–æ¶ˆæŠ¥å
    @PostMapping("/cancel")
    public Result<Void> cancelRegistration(
        @RequestParam Long activityId,
        HttpServletRequest request
    );
    
    // è·å–æˆ‘å‘å¸ƒçš„æ´»åŠ¨
    @GetMapping("/my-activities")
    public Result<Page<BuddyActivityDTO>> getMyActivities(
        @RequestParam(defaultValue = "1") Integer page,
        @RequestParam(defaultValue = "10") Integer size,
        HttpServletRequest request
    );
    
    // è·å–æˆ‘å‚ä¸çš„æ´»åŠ¨
    @GetMapping("/my-registrations")
    public Result<Page<BuddyActivityDTO>> getMyRegistrations(
        @RequestParam(defaultValue = "1") Integer page,
        @RequestParam(defaultValue = "10") Integer size,
        HttpServletRequest request
    );
}
```

**Serviceå±‚**: `BuddyService`
```java
@Service
public interface BuddyService {
    
    /**
     * å‘å¸ƒæ­å­æ´»åŠ¨
     * @param userId å‘èµ·äººID
     * @param request å‘å¸ƒè¯·æ±‚
     * @return æ´»åŠ¨ä¿¡æ¯
     */
    BuddyActivityDTO publishActivity(Long userId, PublishBuddyRequest request);
    
    /**
     * æŠ¥åæ´»åŠ¨
     * @param userId ç”¨æˆ·ID
     * @param activityId æ´»åŠ¨ID
     */
    void registerActivity(Long userId, Long activityId);
    
    /**
     * æ£€æŸ¥æŠ¥åæ¡ä»¶
     * @param userId ç”¨æˆ·ID
     * @param activityId æ´»åŠ¨ID
     * @return æ£€æŸ¥ç»“æœ
     */
    RegistrationCheckResult checkRegistration(Long userId, Long activityId);
}
```

#### 3.4.3 æ´»åŠ¨çŠ¶æ€ç®¡ç†

```java
æ´»åŠ¨çŠ¶æ€æšä¸¾ï¼š
1 - æ‹›å‹Ÿä¸­ï¼ˆæ­£å¸¸æ˜¾ç¤ºï¼‰
2 - å·²æ»¡å‘˜ï¼ˆæ˜¾ç¤ºä½†ä¸å¯æŠ¥åï¼‰
3 - å·²ç»“æŸï¼ˆä¸æ˜¾ç¤ºï¼‰
4 - å·²å–æ¶ˆï¼ˆä¸æ˜¾ç¤ºï¼‰

çŠ¶æ€è½¬æ¢é€»è¾‘ï¼š
- å‘å¸ƒæ—¶ï¼šçŠ¶æ€=1ï¼ˆæ‹›å‹Ÿä¸­ï¼‰
- äººæ•°æ»¡æ—¶ï¼šçŠ¶æ€=2ï¼ˆå·²æ»¡å‘˜ï¼‰
- æ´»åŠ¨æ—¶é—´è¿‡æœŸï¼šå®šæ—¶ä»»åŠ¡æ›´æ–°ä¸º3ï¼ˆå·²ç»“æŸï¼‰
- å‘èµ·äººå–æ¶ˆï¼šçŠ¶æ€=4ï¼ˆå·²å–æ¶ˆï¼‰
```

---

### 3.5 çº¿ä¸‹æ´»åŠ¨æ¨¡å—

#### 3.5.1 æ¨¡å—æ¦‚è¿°
**æ ¸å¿ƒåŠŸèƒ½**: å¹³å°å®˜æ–¹ç»„ç»‡çš„çº¿ä¸‹æ´»åŠ¨ï¼Œç”¨æˆ·ä»˜è´¹æŠ¥åå‚åŠ 

**æ´»åŠ¨ç±»å‹**:
- å•èº«æ´¾å¯¹
- å…´è¶£æ²™é¾™
- æˆ·å¤–æ‹“å±•
- è¯»ä¹¦åˆ†äº«ä¼š
ç­‰

#### 3.5.2 æŠ€æœ¯å®ç°è®¾è®¡

**Controllerå±‚**: `OfflineActivityController`
```java
@RestController
@RequestMapping("/api/activities")
public class OfflineActivityController {
    
    // è·å–å®˜æ–¹æ´»åŠ¨åˆ—è¡¨
    @GetMapping("/official")
    public Result<Page<OfficialActivityDTO>> getOfficialActivities(
        @RequestParam(defaultValue = "1") Integer page,
        @RequestParam(defaultValue = "10") Integer size
    );
    
    // è·å–æ´»åŠ¨è¯¦æƒ…
    @GetMapping("/{activityId}")
    public Result<OfficialActivityDetailDTO> getActivityDetail(
        @PathVariable Long activityId,
        HttpServletRequest request
    );
    
    // æŠ¥åæ´»åŠ¨
    @PostMapping("/register")
    public Result<ActivityRegistrationDTO> registerActivity(
        @RequestBody @Validated ActivityRegistrationRequest request,
        HttpServletRequest httpRequest
    );
    
    // è·å–æˆ‘çš„æ´»åŠ¨è®°å½•
    @GetMapping("/my-history")
    public Result<Page<ActivityRegistrationDTO>> getMyHistory(
        @RequestParam(defaultValue = "1") Integer page,
        @RequestParam(defaultValue = "10") Integer size,
        HttpServletRequest request
    );
}
```

---

### 3.6 ä¼šå‘˜ä¸æ”¯ä»˜æ¨¡å—

#### 3.6.1 ä¼šå‘˜åŠŸèƒ½å¼€å…³è®¾è®¡

**ç³»ç»Ÿé…ç½®è¡¨è®¾è®¡**:
```sql
CREATE TABLE `t_system_config` (
  `id` BIGINT PRIMARY KEY AUTO_INCREMENT,
  `config_key` VARCHAR(100) NOT NULL UNIQUE COMMENT 'é…ç½®é”®',
  `config_value` VARCHAR(500) COMMENT 'é…ç½®å€¼',
  `config_desc` VARCHAR(200) COMMENT 'é…ç½®æè¿°',
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP,
  `updated_at` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
) COMMENT='ç³»ç»Ÿé…ç½®è¡¨';

-- åˆå§‹åŒ–é…ç½®
INSERT INTO `t_system_config` VALUES
(1, 'vip.feature.enabled', 'false', 'ä¼šå‘˜åŠŸèƒ½å¼€å…³ï¼štrue-å¼€å¯ï¼Œfalse-å…³é—­'),
(2, 'vip.daily.free.match.count', '3', 'å…è´¹ç”¨æˆ·æ¯æ—¥åŒ¹é…æ¬¡æ•°'),
(3, 'vip.daily.free.super.like.count', '1', 'å…è´¹ç”¨æˆ·æ¯æ—¥è¶…çº§å–œæ¬¢æ¬¡æ•°');
```

**é…ç½®æœåŠ¡å®ç°**:
```java
@Service
public class SystemConfigService {
    
    @Autowired
    private SystemConfigMapper configMapper;
    
    @Autowired
    private RedisTemplate<String, String> redisTemplate;
    
    private static final String CONFIG_CACHE_KEY = "system:config:";
    
    /**
     * è·å–é…ç½®å€¼ï¼ˆå¸¦ç¼“å­˜ï¼‰
     * @param key é…ç½®é”®
     * @param defaultValue é»˜è®¤å€¼
     * @return é…ç½®å€¼
     */
    public String getString(String key, String defaultValue) {
        // å…ˆä»Redisç¼“å­˜è¯»å–
        String cacheKey = CONFIG_CACHE_KEY + key;
        String cachedValue = redisTemplate.opsForValue().get(cacheKey);
        
        if (cachedValue != null) {
            return cachedValue;
        }
        
        // ç¼“å­˜æœªå‘½ä¸­ï¼Œä»æ•°æ®åº“è¯»å–
        SystemConfig config = configMapper.selectOne(
            new LambdaQueryWrapper<SystemConfig>()
                .eq(SystemConfig::getConfigKey, key)
        );
        
        String value = config != null ? config.getConfigValue() : defaultValue;
        
        // å†™å…¥ç¼“å­˜ï¼ˆ10åˆ†é’Ÿè¿‡æœŸï¼‰
        redisTemplate.opsForValue().set(cacheKey, value, 10, TimeUnit.MINUTES);
        
        return value;
    }
    
    public Boolean getBoolean(String key, Boolean defaultValue) {
        String value = getString(key, String.valueOf(defaultValue));
        return Boolean.parseBoolean(value);
    }
    
    public Integer getInt(String key, Integer defaultValue) {
        String value = getString(key, String.valueOf(defaultValue));
        return Integer.parseInt(value);
    }
    
    /**
     * æ›´æ–°é…ç½®ï¼ˆæ¸…é™¤ç¼“å­˜ï¼‰
     * @param key é…ç½®é”®
     * @param value é…ç½®å€¼
     */
    public void updateConfig(String key, String value) {
        configMapper.update(
            new SystemConfig().setConfigValue(value),
            new LambdaUpdateWrapper<SystemConfig>()
                .eq(SystemConfig::getConfigKey, key)
        );
        
        // æ¸…é™¤ç¼“å­˜
        redisTemplate.delete(CONFIG_CACHE_KEY + key);
    }
}
```

**ä¼šå‘˜åŠŸèƒ½æ§åˆ¶**:
```java
@Service
public class VipFeatureService {
    
    @Autowired
    private SystemConfigService configService;
    
    @Autowired
    private VipService vipService;
    
    /**
     * æ£€æŸ¥æ˜¯å¦æœ‰æƒé™ä½¿ç”¨æŸåŠŸèƒ½
     * @param userId ç”¨æˆ·ID
     * @param feature åŠŸèƒ½åç§°
     * @return æ˜¯å¦æœ‰æƒé™
     */
    public boolean hasPermission(Long userId, String feature) {
        // 1. æ£€æŸ¥ä¼šå‘˜åŠŸèƒ½å¼€å…³
        boolean vipEnabled = configService.getBoolean("vip.feature.enabled", false);
        
        // 2. å¦‚æœä¼šå‘˜åŠŸèƒ½å…³é—­ï¼Œæ‰€æœ‰ç”¨æˆ·éƒ½æœ‰æƒé™
        if (!vipEnabled) {
            return true;
        }
        
        // 3. ä¼šå‘˜åŠŸèƒ½å¼€å¯ï¼Œæ£€æŸ¥ç”¨æˆ·VIPçŠ¶æ€
        VipMember vip = vipService.getValidVip(userId);
        if (vip != null) {
            return true;  // VIPç”¨æˆ·æœ‰æƒé™
        }
        
        // 4. éVIPç”¨æˆ·ï¼Œæ£€æŸ¥è¯¥åŠŸèƒ½æ˜¯å¦éœ€è¦VIP
        return !isVipOnlyFeature(feature);
    }
    
    private boolean isVipOnlyFeature(String feature) {
        Set<String> vipOnlyFeatures = Set.of(
            "unlimited_match",      // æ— é™åŒ¹é…
            "advanced_filter",      // é«˜çº§ç­›é€‰
            "see_who_liked_me",     // æŸ¥çœ‹è°å–œæ¬¢æˆ‘
            "priority_display"      // ä¼˜å…ˆå±•ç¤º
        );
        return vipOnlyFeatures.contains(feature);
    }
}
```

#### 3.6.2 æ”¯ä»˜æ¨¡å—è®¾è®¡

**Controllerå±‚**: `PaymentController`
```java
@RestController
@RequestMapping("/api/payment")
public class PaymentController {
    
    // åˆ›å»ºVIPè®¢å•
    @PostMapping("/vip/create-order")
    public Result<OrderDTO> createVipOrder(
        @RequestBody @Validated CreateVipOrderRequest request,
        HttpServletRequest httpRequest
    );
    
    // å¾®ä¿¡æ”¯ä»˜é¢„ä¸‹å•
    @PostMapping("/wx/prepay")
    public Result<WxPayParamsDTO> wxPrepay(
        @RequestParam String orderNo,
        HttpServletRequest request
    );
    
    // å¾®ä¿¡æ”¯ä»˜å›è°ƒ
    @PostMapping("/wx/callback")
    public String wxPayCallback(@RequestBody String requestBody);
    
    // æŸ¥è¯¢è®¢å•çŠ¶æ€
    @GetMapping("/order/{orderNo}")
    public Result<OrderDTO> getOrder(
        @PathVariable String orderNo,
        HttpServletRequest request
    );
}
```

**Serviceå±‚**: `PaymentService`
```java
@Service
public interface PaymentService {
    
    /**
     * åˆ›å»ºè®¢å•
     * @param userId ç”¨æˆ·ID
     * @param orderType è®¢å•ç±»å‹
     * @param amount é‡‘é¢
     * @return è®¢å•ä¿¡æ¯
     */
    OrderDTO createOrder(Long userId, int orderType, BigDecimal amount);
    
    /**
     * å¤„ç†æ”¯ä»˜æˆåŠŸå›è°ƒ
     * @param orderNo è®¢å•å·
     * @param transactionId ç¬¬ä¸‰æ–¹äº¤æ˜“å·
     */
    void handlePaymentSuccess(String orderNo, String transactionId);
    
    /**
     * å¼€é€šVIPä¼šå‘˜
     * @param userId ç”¨æˆ·ID
     * @param vipLevel ä¼šå‘˜ç­‰çº§
     */
    void activateVip(Long userId, int vipLevel);
}
```

---

### 3.7 å®åè®¤è¯æ¨¡å—ï¼ˆå»é™¤å­¦å†è®¤è¯ï¼‰

#### 3.7.1 æ¨¡å—æ¦‚è¿°
**æ ¸å¿ƒåŠŸèƒ½**: 
- âœ… æ‰‹æœºå·éªŒè¯
- âœ… å®åè®¤è¯ï¼ˆèº«ä»½è¯+äººè„¸è¯†åˆ«ï¼‰
- âŒ å­¦å†è®¤è¯ï¼ˆå·²ç§»é™¤ï¼‰

#### 3.7.2 æŠ€æœ¯å®ç°è®¾è®¡

**Controllerå±‚**: `VerificationController`
```java
@RestController
@RequestMapping("/api/verification")
public class VerificationController {
    
    // å‘é€æ‰‹æœºéªŒè¯ç 
    @PostMapping("/phone/send-code")
    public Result<Void> sendPhoneCode(
        @RequestBody @Validated SendCodeRequest request,
        HttpServletRequest httpRequest
    );
    
    // éªŒè¯æ‰‹æœºå·
    @PostMapping("/phone/verify")
    public Result<Void> verifyPhone(
        @RequestBody @Validated VerifyPhoneRequest request,
        HttpServletRequest httpRequest
    );
    
    // æäº¤å®åè®¤è¯
    @PostMapping("/idcard/submit")
    public Result<VerificationDTO> submitIdCard(
        @RequestBody @Validated IdCardVerificationRequest request,
        HttpServletRequest httpRequest
    );
    
    // è·å–äººè„¸è¯†åˆ«å‚æ•°
    @GetMapping("/face/params")
    public Result<FaceRecognitionParamsDTO> getFaceParams(
        @RequestParam Long verificationId,
        HttpServletRequest request
    );
    
    // æäº¤äººè„¸è¯†åˆ«ç»“æœ
    @PostMapping("/face/submit")
    public Result<Void> submitFaceResult(
        @RequestBody @Validated FaceResultRequest request,
        HttpServletRequest httpRequest
    );
    
    // è·å–è®¤è¯çŠ¶æ€
    @GetMapping("/status")
    public Result<VerificationStatusDTO> getStatus(
        HttpServletRequest request
    );
}
```

**Serviceå±‚**: `VerificationService`
```java
@Service
public interface VerificationService {
    
    /**
     * å‘é€æ‰‹æœºéªŒè¯ç 
     * @param phone æ‰‹æœºå·
     * @return æ˜¯å¦å‘é€æˆåŠŸ
     */
    boolean sendSmsCode(String phone);
    
    /**
     * éªŒè¯æ‰‹æœºå·
     * @param userId ç”¨æˆ·ID
     * @param phone æ‰‹æœºå·
     * @param code éªŒè¯ç 
     */
    void verifyPhone(Long userId, String phone, String code);
    
    /**
     * æäº¤å®åè®¤è¯
     * @param userId ç”¨æˆ·ID
     * @param realName çœŸå®å§“å
     * @param idCard èº«ä»½è¯å·
     * @return è®¤è¯ID
     */
    Long submitIdCardVerification(Long userId, String realName, String idCard);
    
    /**
     * å®Œæˆå®åè®¤è¯
     * @param verificationId è®¤è¯ID
     * @param faceToken äººè„¸è¯†åˆ«token
     */
    void completeVerification(Long verificationId, String faceToken);
}
```

---

## 4. æ•°æ®åº“è®¾è®¡

### 4.1 æ ¸å¿ƒè¡¨ç»“æ„

#### 4.1.1 ç”¨æˆ·ç›¸å…³è¡¨ï¼ˆå·²å­˜åœ¨ï¼‰
```sql
-- t_user: ç”¨æˆ·åŸºç¡€ä¿¡æ¯è¡¨
-- t_wx_user: å¾®ä¿¡ç”¨æˆ·ä¿¡æ¯è¡¨
-- t_user_profile: ç”¨æˆ·è¯¦ç»†èµ„æ–™è¡¨
-- t_user_album: ç”¨æˆ·ç›¸å†Œè¡¨
-- t_user_tags: ç”¨æˆ·æ ‡ç­¾å…³è”è¡¨
-- t_tag_library: æ ‡ç­¾åº“è¡¨
-- t_user_privacy: ç”¨æˆ·éšç§è®¾ç½®è¡¨
```

#### 4.1.2 åŒ¹é…ç›¸å…³è¡¨ï¼ˆå¾…åˆ›å»ºï¼‰
```sql
-- 1. ç”¨æˆ·åŒ¹é…åå¥½è¡¨
CREATE TABLE `t_matching_preference` (
  `id` BIGINT PRIMARY KEY AUTO_INCREMENT,
  `user_id` BIGINT NOT NULL COMMENT 'ç”¨æˆ·ID',
  `min_age` INT COMMENT 'æœŸæœ›æœ€å°å¹´é¾„',
  `max_age` INT COMMENT 'æœŸæœ›æœ€å¤§å¹´é¾„',
  `min_height` INT COMMENT 'æœŸæœ›æœ€å°èº«é«˜(cm)',
  `max_height` INT COMMENT 'æœŸæœ›æœ€å¤§èº«é«˜(cm)',
  `education` VARCHAR(50) COMMENT 'æœŸæœ›å­¦å†ï¼ˆå¤šä¸ªç”¨é€—å·åˆ†éš”ï¼‰',
  `income_range` VARCHAR(100) COMMENT 'æœŸæœ›æ”¶å…¥èŒƒå›´',
  `max_distance` INT DEFAULT 50 COMMENT 'æœ€å¤§è·ç¦»(km)',
  `location_latitude` DECIMAL(10,7) COMMENT 'ç”¨æˆ·çº¬åº¦',
  `location_longitude` DECIMAL(10,7) COMMENT 'ç”¨æˆ·ç»åº¦',
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP,
  `updated_at` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `deleted` TINYINT DEFAULT 0,
  UNIQUE KEY `uk_user_id` (`user_id`),
  KEY `idx_location` (`location_latitude`, `location_longitude`)
) COMMENT='ç”¨æˆ·åŒ¹é…åå¥½è¡¨';

-- 2. åŒ¹é…è®°å½•è¡¨
CREATE TABLE `t_match_record` (
  `id` BIGINT PRIMARY KEY AUTO_INCREMENT,
  `from_user_id` BIGINT NOT NULL COMMENT 'å‘èµ·åŒ¹é…çš„ç”¨æˆ·ID',
  `to_user_id` BIGINT NOT NULL COMMENT 'è¢«åŒ¹é…çš„ç”¨æˆ·ID',
  `match_type` TINYINT NOT NULL COMMENT 'åŒ¹é…ç±»å‹ï¼š1-æ™®é€šå–œæ¬¢ï¼Œ2-è¶…çº§å–œæ¬¢',
  `match_result` TINYINT DEFAULT 0 COMMENT 'åŒ¹é…ç»“æœï¼š0-æœªåŒ¹é…ï¼Œ1-å•å‘å–œæ¬¢ï¼Œ2-åŒå‘åŒ¹é…æˆåŠŸ',
  `matched_at` DATETIME COMMENT 'åŒ¹é…æˆåŠŸæ—¶é—´',
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP,
  `updated_at` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `deleted` TINYINT DEFAULT 0,
  UNIQUE KEY `uk_user_match` (`from_user_id`, `to_user_id`),
  KEY `idx_from_user` (`from_user_id`),
  KEY `idx_to_user` (`to_user_id`),
  KEY `idx_match_result` (`match_result`)
) COMMENT='åŒ¹é…è®°å½•è¡¨';

-- 3. åŒ¹é…é™åˆ¶è¡¨
CREATE TABLE `t_match_limit` (
  `id` BIGINT PRIMARY KEY AUTO_INCREMENT,
  `user_id` BIGINT NOT NULL COMMENT 'ç”¨æˆ·ID',
  `date` DATE NOT NULL COMMENT 'æ—¥æœŸ',
  `free_match_count` INT DEFAULT 0 COMMENT 'å…è´¹åŒ¹é…æ¬¡æ•°ï¼ˆå·²ä½¿ç”¨ï¼‰',
  `vip_match_count` INT DEFAULT 0 COMMENT 'VIPåŒ¹é…æ¬¡æ•°ï¼ˆå·²ä½¿ç”¨ï¼‰',
  `super_like_count` INT DEFAULT 0 COMMENT 'è¶…çº§å–œæ¬¢æ¬¡æ•°ï¼ˆå·²ä½¿ç”¨ï¼‰',
  `last_match_time` DATETIME COMMENT 'æœ€ååŒ¹é…æ—¶é—´',
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP,
  `updated_at` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  UNIQUE KEY `uk_user_date` (`user_id`, `date`),
  KEY `idx_date` (`date`)
) COMMENT='ç”¨æˆ·æ¯æ—¥åŒ¹é…é™åˆ¶è¡¨';
```

#### 4.1.3 èŠå¤©ç›¸å…³è¡¨ï¼ˆå¾…åˆ›å»ºï¼‰

**è¯´æ˜**ï¼šä½¿ç”¨è…¾è®¯äº‘IMç¬¬ä¸‰æ–¹æœåŠ¡ï¼Œæ¶ˆæ¯å­˜å‚¨ç”±IMç³»ç»Ÿè´Ÿè´£ï¼Œåç«¯åªéœ€ç»´æŠ¤é˜²éªšæ‰°é™åˆ¶è¡¨ã€‚

```sql
-- èŠå¤©é™åˆ¶è¡¨ï¼ˆé˜²éªšæ‰°ï¼‰
CREATE TABLE `t_chat_limit` (
  `id` BIGINT PRIMARY KEY AUTO_INCREMENT,
  `sender_id` BIGINT NOT NULL COMMENT 'å‘é€è€…ID',
  `receiver_id` BIGINT NOT NULL COMMENT 'æ¥æ”¶è€…ID',
  `unreplied_count` INT DEFAULT 0 COMMENT 'æœªå›å¤æ¶ˆæ¯æ•°',
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP,
  `updated_at` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  UNIQUE KEY `uk_sender_receiver` (`sender_id`, `receiver_id`),
  KEY `idx_receiver` (`receiver_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='èŠå¤©é™åˆ¶è¡¨';
```

**ä¼˜åŠ¿**ï¼š
- âœ… ç®€åŒ–æ•°æ®åº“è®¾è®¡ï¼Œæ— éœ€ç»´æŠ¤æ¶ˆæ¯è¡¨å’Œä¼šè¯è¡¨
- âœ… æ¶ˆæ¯å­˜å‚¨ã€å¤šç«¯åŒæ­¥ã€ç¦»çº¿æ¨é€ç”±è…¾è®¯äº‘IMè´Ÿè´£
- âœ… é™ä½æœåŠ¡å™¨å­˜å‚¨å’Œè¿ç»´æˆæœ¬
- âœ… æä¾›æ›´ç¨³å®šå¯é çš„èŠå¤©æœåŠ¡

#### 4.1.4 åŠ¨æ€ç›¸å…³è¡¨ï¼ˆå¾…åˆ›å»ºï¼‰
```sql
-- 1. åŠ¨æ€è¡¨
CREATE TABLE `t_moment` (
  `id` BIGINT PRIMARY KEY AUTO_INCREMENT,
  `user_id` BIGINT NOT NULL COMMENT 'å‘å¸ƒè€…ID',
  `content` VARCHAR(1000) COMMENT 'åŠ¨æ€å†…å®¹',
  `location` VARCHAR(200) COMMENT 'ä½ç½®ä¿¡æ¯',
  `latitude` DECIMAL(10,7) COMMENT 'çº¬åº¦',
  `longitude` DECIMAL(10,7) COMMENT 'ç»åº¦',
  `like_count` INT DEFAULT 0 COMMENT 'ç‚¹èµæ•°',
  `comment_count` INT DEFAULT 0 COMMENT 'è¯„è®ºæ•°',
  `view_count` INT DEFAULT 0 COMMENT 'æµè§ˆæ•°',
  `is_top` TINYINT DEFAULT 0 COMMENT 'æ˜¯å¦ç½®é¡¶ï¼š0-å¦ï¼Œ1-æ˜¯',
  `top_expire_time` DATETIME COMMENT 'ç½®é¡¶è¿‡æœŸæ—¶é—´',
  `audit_status` TINYINT DEFAULT 0 COMMENT 'å®¡æ ¸çŠ¶æ€ï¼š0-å¾…å®¡æ ¸ï¼Œ1-é€šè¿‡ï¼Œ2-æ‹’ç»',
  `audit_remark` VARCHAR(500) COMMENT 'å®¡æ ¸å¤‡æ³¨',
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP,
  `updated_at` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `deleted` TINYINT DEFAULT 0,
  KEY `idx_user_id` (`user_id`),
  KEY `idx_location` (`latitude`, `longitude`),
  KEY `idx_created` (`created_at`),
  KEY `idx_audit` (`audit_status`)
) COMMENT='åŠ¨æ€è¡¨';

-- 2. åŠ¨æ€å›¾ç‰‡è¡¨
CREATE TABLE `t_moment_photo` (
  `id` BIGINT PRIMARY KEY AUTO_INCREMENT,
  `moment_id` BIGINT NOT NULL COMMENT 'åŠ¨æ€ID',
  `photo_url` VARCHAR(500) NOT NULL COMMENT 'å›¾ç‰‡URL',
  `sort_order` INT DEFAULT 0 COMMENT 'æ’åº',
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP,
  KEY `idx_moment_id` (`moment_id`)
) COMMENT='åŠ¨æ€å›¾ç‰‡è¡¨';

-- 3. åŠ¨æ€ç‚¹èµè¡¨
CREATE TABLE `t_moment_like` (
  `id` BIGINT PRIMARY KEY AUTO_INCREMENT,
  `moment_id` BIGINT NOT NULL COMMENT 'åŠ¨æ€ID',
  `user_id` BIGINT NOT NULL COMMENT 'ç‚¹èµç”¨æˆ·ID',
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP,
  UNIQUE KEY `uk_moment_user` (`moment_id`, `user_id`),
  KEY `idx_user_id` (`user_id`)
) COMMENT='åŠ¨æ€ç‚¹èµè¡¨';

-- 4. åŠ¨æ€è¯„è®ºè¡¨
CREATE TABLE `t_moment_comment` (
  `id` BIGINT PRIMARY KEY AUTO_INCREMENT,
  `moment_id` BIGINT NOT NULL COMMENT 'åŠ¨æ€ID',
  `user_id` BIGINT NOT NULL COMMENT 'è¯„è®ºç”¨æˆ·ID',
  `content` VARCHAR(500) NOT NULL COMMENT 'è¯„è®ºå†…å®¹',
  `reply_to_user_id` BIGINT COMMENT 'å›å¤çš„ç”¨æˆ·ID',
  `reply_to_comment_id` BIGINT COMMENT 'å›å¤çš„è¯„è®ºID',
  `like_count` INT DEFAULT 0 COMMENT 'ç‚¹èµæ•°',
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP,
  `deleted` TINYINT DEFAULT 0,
  KEY `idx_moment_id` (`moment_id`),
  KEY `idx_user_id` (`user_id`)
) COMMENT='åŠ¨æ€è¯„è®ºè¡¨';
```

#### 4.1.5 æ­å­æ´»åŠ¨è¡¨ï¼ˆå¾…åˆ›å»ºï¼‰
```sql
-- 1. æ­å­æ´»åŠ¨è¡¨
CREATE TABLE `t_buddy_activity` (
  `id` BIGINT PRIMARY KEY AUTO_INCREMENT,
  `creator_id` BIGINT NOT NULL COMMENT 'å‘èµ·äººID',
  `type` VARCHAR(20) NOT NULL COMMENT 'æ´»åŠ¨ç±»å‹ï¼šsport/study/travel/workout/hobby',
  `title` VARCHAR(100) NOT NULL COMMENT 'æ´»åŠ¨æ ‡é¢˜',
  `description` VARCHAR(500) COMMENT 'æ´»åŠ¨è¯¦æƒ…',
  `activity_time` DATETIME NOT NULL COMMENT 'æ´»åŠ¨æ—¶é—´',
  `location` VARCHAR(200) NOT NULL COMMENT 'æ´»åŠ¨åœ°ç‚¹',
  `latitude` DECIMAL(10,7) COMMENT 'çº¬åº¦',
  `longitude` DECIMAL(10,7) COMMENT 'ç»åº¦',
  `max_participants` INT DEFAULT 5 COMMENT 'æœ€å¤§å‚ä¸äººæ•°',
  `current_participants` INT DEFAULT 1 COMMENT 'å½“å‰å‚ä¸äººæ•°',
  `status` TINYINT DEFAULT 1 COMMENT 'çŠ¶æ€ï¼š1-æ‹›å‹Ÿä¸­ï¼Œ2-å·²æ»¡å‘˜ï¼Œ3-å·²ç»“æŸï¼Œ4-å·²å–æ¶ˆ',
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP,
  `updated_at` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `deleted` TINYINT DEFAULT 0,
  KEY `idx_creator` (`creator_id`),
  KEY `idx_type` (`type`),
  KEY `idx_location` (`latitude`, `longitude`),
  KEY `idx_time` (`activity_time`),
  KEY `idx_status` (`status`)
) COMMENT='æ­å­æ´»åŠ¨è¡¨';

-- 2. æ­å­æ´»åŠ¨æŠ¥åè¡¨
CREATE TABLE `t_buddy_registration` (
  `id` BIGINT PRIMARY KEY AUTO_INCREMENT,
  `activity_id` BIGINT NOT NULL COMMENT 'æ´»åŠ¨ID',
  `user_id` BIGINT NOT NULL COMMENT 'æŠ¥åç”¨æˆ·ID',
  `status` TINYINT DEFAULT 1 COMMENT 'çŠ¶æ€ï¼š1-å·²æŠ¥åï¼Œ2-å·²å–æ¶ˆ',
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP,
  `updated_at` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `deleted` TINYINT DEFAULT 0,
  UNIQUE KEY `uk_activity_user` (`activity_id`, `user_id`),
  KEY `idx_user_id` (`user_id`)
) COMMENT='æ­å­æ´»åŠ¨æŠ¥åè¡¨';
```

#### 4.1.6 çº¿ä¸‹æ´»åŠ¨è¡¨ï¼ˆå¾…åˆ›å»ºï¼‰
```sql
-- 1. å®˜æ–¹æ´»åŠ¨è¡¨
CREATE TABLE `t_official_activity` (
  `id` BIGINT PRIMARY KEY AUTO_INCREMENT,
  `title` VARCHAR(100) NOT NULL COMMENT 'æ´»åŠ¨æ ‡é¢˜',
  `description` TEXT COMMENT 'æ´»åŠ¨è¯¦æƒ…',
  `poster_url` VARCHAR(500) COMMENT 'æ´»åŠ¨æµ·æŠ¥',
  `activity_time` DATETIME NOT NULL COMMENT 'æ´»åŠ¨æ—¶é—´',
  `location` VARCHAR(200) NOT NULL COMMENT 'æ´»åŠ¨åœ°ç‚¹',
  `latitude` DECIMAL(10,7) COMMENT 'çº¬åº¦',
  `longitude` DECIMAL(10,7) COMMENT 'ç»åº¦',
  `max_participants` INT DEFAULT 100 COMMENT 'æœ€å¤§å‚ä¸äººæ•°',
  `current_participants` INT DEFAULT 0 COMMENT 'å½“å‰å‚ä¸äººæ•°',
  `fee` DECIMAL(10,2) DEFAULT 0 COMMENT 'æ´»åŠ¨è´¹ç”¨ï¼ˆ0è¡¨ç¤ºå…è´¹ï¼‰',
  `status` TINYINT DEFAULT 1 COMMENT 'çŠ¶æ€ï¼š1-æŠ¥åä¸­ï¼Œ2-å·²æ»¡å‘˜ï¼Œ3-å·²ç»“æŸï¼Œ4-å·²å–æ¶ˆ',
  `is_featured` TINYINT DEFAULT 0 COMMENT 'æ˜¯å¦ç²¾é€‰',
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP,
  `updated_at` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `deleted` TINYINT DEFAULT 0,
  KEY `idx_time` (`activity_time`),
  KEY `idx_status` (`status`),
  KEY `idx_featured` (`is_featured`)
) COMMENT='å®˜æ–¹æ´»åŠ¨è¡¨';

-- 2. æ´»åŠ¨æŠ¥åè¡¨
CREATE TABLE `t_activity_registration` (
  `id` BIGINT PRIMARY KEY AUTO_INCREMENT,
  `activity_id` BIGINT NOT NULL COMMENT 'æ´»åŠ¨ID',
  `user_id` BIGINT NOT NULL COMMENT 'æŠ¥åç”¨æˆ·ID',
  `order_id` BIGINT COMMENT 'è®¢å•IDï¼ˆä»˜è´¹æ´»åŠ¨ï¼‰',
  `participant_name` VARCHAR(50) COMMENT 'å‚ä¸è€…å§“å',
  `phone` VARCHAR(20) COMMENT 'è”ç³»ç”µè¯',
  `emergency_contact` VARCHAR(100) COMMENT 'ç´§æ€¥è”ç³»äºº',
  `status` TINYINT DEFAULT 0 COMMENT 'çŠ¶æ€ï¼š0-å¾…æ”¯ä»˜ï¼Œ1-å·²æŠ¥åï¼Œ2-å·²å–æ¶ˆ',
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP,
  `updated_at` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `deleted` TINYINT DEFAULT 0,
  UNIQUE KEY `uk_activity_user` (`activity_id`, `user_id`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_order_id` (`order_id`)
) COMMENT='æ´»åŠ¨æŠ¥åè¡¨';
```

#### 4.1.7 ä¼šå‘˜ç›¸å…³è¡¨ï¼ˆå¾…åˆ›å»ºï¼‰
```sql
-- 1. ä¼šå‘˜ä¿¡æ¯è¡¨
CREATE TABLE `t_vip_member` (
  `id` BIGINT PRIMARY KEY AUTO_INCREMENT,
  `user_id` BIGINT NOT NULL COMMENT 'ç”¨æˆ·ID',
  `vip_level` TINYINT DEFAULT 1 COMMENT 'ä¼šå‘˜ç­‰çº§ï¼š1-æœˆåº¦ï¼Œ2-å­£åº¦ï¼Œ3-å¹´åº¦',
  `start_time` DATETIME NOT NULL COMMENT 'å¼€å§‹æ—¶é—´',
  `expire_time` DATETIME NOT NULL COMMENT 'åˆ°æœŸæ—¶é—´',
  `auto_renew` TINYINT DEFAULT 0 COMMENT 'æ˜¯å¦è‡ªåŠ¨ç»­è´¹ï¼š0-å¦ï¼Œ1-æ˜¯',
  `status` TINYINT DEFAULT 1 COMMENT 'çŠ¶æ€ï¼š0-å·²è¿‡æœŸï¼Œ1-æœ‰æ•ˆ',
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP,
  `updated_at` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  UNIQUE KEY `uk_user_id` (`user_id`),
  KEY `idx_expire_time` (`expire_time`)
) COMMENT='ä¼šå‘˜ä¿¡æ¯è¡¨';

-- 2. è®¢å•è¡¨
CREATE TABLE `t_order` (
  `id` BIGINT PRIMARY KEY AUTO_INCREMENT,
  `order_no` VARCHAR(64) NOT NULL COMMENT 'è®¢å•å·',
  `user_id` BIGINT NOT NULL COMMENT 'ç”¨æˆ·ID',
  `order_type` TINYINT NOT NULL COMMENT 'è®¢å•ç±»å‹ï¼š1-æœˆåº¦ä¼šå‘˜ï¼Œ2-å­£åº¦ä¼šå‘˜ï¼Œ3-å¹´åº¦ä¼šå‘˜ï¼Œ4-æŸ¥çœ‹å–œæ¬¢æˆ‘ï¼Œ5-è¶…çº§å–œæ¬¢ï¼Œ6-ç½®é¡¶åŠ¨æ€ï¼Œ7-æ´»åŠ¨æŠ¥å',
  `amount` DECIMAL(10,2) NOT NULL COMMENT 'é‡‘é¢',
  `pay_status` TINYINT DEFAULT 0 COMMENT 'æ”¯ä»˜çŠ¶æ€ï¼š0-å¾…æ”¯ä»˜ï¼Œ1-å·²æ”¯ä»˜ï¼Œ2-å·²é€€æ¬¾',
  `pay_method` VARCHAR(20) COMMENT 'æ”¯ä»˜æ–¹å¼ï¼šwxpay-å¾®ä¿¡æ”¯ä»˜',
  `transaction_id` VARCHAR(100) COMMENT 'ç¬¬ä¸‰æ–¹äº¤æ˜“å·',
  `paid_at` DATETIME COMMENT 'æ”¯ä»˜æ—¶é—´',
  `expire_at` DATETIME COMMENT 'è®¢å•è¿‡æœŸæ—¶é—´',
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP,
  `updated_at` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  UNIQUE KEY `uk_order_no` (`order_no`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_pay_status` (`pay_status`)
) COMMENT='è®¢å•è¡¨';

-- 3. ç³»ç»Ÿé…ç½®è¡¨
CREATE TABLE `t_system_config` (
  `id` BIGINT PRIMARY KEY AUTO_INCREMENT,
  `config_key` VARCHAR(100) NOT NULL COMMENT 'é…ç½®é”®',
  `config_value` VARCHAR(500) COMMENT 'é…ç½®å€¼',
  `config_desc` VARCHAR(200) COMMENT 'é…ç½®æè¿°',
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP,
  `updated_at` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  UNIQUE KEY `uk_config_key` (`config_key`)
) COMMENT='ç³»ç»Ÿé…ç½®è¡¨';

-- åˆå§‹åŒ–é…ç½®
INSERT INTO `t_system_config` VALUES
(1, 'vip.feature.enabled', 'false', 'ä¼šå‘˜åŠŸèƒ½å¼€å…³ï¼štrue-å¼€å¯ï¼Œfalse-å…³é—­ï¼ˆå‰æœŸå…³é—­ï¼Œå…¨åŠŸèƒ½å…è´¹ï¼‰'),
(2, 'vip.daily.free.match.count', '3', 'å…è´¹ç”¨æˆ·æ¯æ—¥åŒ¹é…æ¬¡æ•°'),
(3, 'vip.daily.free.super.like.count', '1', 'å…è´¹ç”¨æˆ·æ¯æ—¥è¶…çº§å–œæ¬¢æ¬¡æ•°');
```

#### 4.1.8 è®¤è¯ç›¸å…³è¡¨ï¼ˆå¾…åˆ›å»ºï¼Œä¸å«å­¦å†è®¤è¯ï¼‰
```sql
-- ç”¨æˆ·è®¤è¯è¡¨
CREATE TABLE `t_user_verification` (
  `id` BIGINT PRIMARY KEY AUTO_INCREMENT,
  `user_id` BIGINT NOT NULL COMMENT 'ç”¨æˆ·ID',
  `verify_type` TINYINT NOT NULL COMMENT 'è®¤è¯ç±»å‹ï¼š1-å®åè®¤è¯ï¼Œ2-æ‰‹æœºå·è®¤è¯',
  `phone` VARCHAR(20) COMMENT 'æ‰‹æœºå·',
  `real_name` VARCHAR(50) COMMENT 'çœŸå®å§“å',
  `id_card` VARCHAR(18) COMMENT 'èº«ä»½è¯å·ï¼ˆåŠ å¯†å­˜å‚¨ï¼‰',
  `verify_status` TINYINT DEFAULT 0 COMMENT 'è®¤è¯çŠ¶æ€ï¼š0-æœªæäº¤ï¼Œ1-å®¡æ ¸ä¸­ï¼Œ2-é€šè¿‡ï¼Œ3-æ‹’ç»',
  `verify_remark` VARCHAR(500) COMMENT 'å®¡æ ¸å¤‡æ³¨',
  `verified_at` DATETIME COMMENT 'è®¤è¯é€šè¿‡æ—¶é—´',
  `created_at` DATETIME DEFAULT CURRENT_TIMESTAMP,
  `updated_at` DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `deleted` TINYINT DEFAULT 0,
  KEY `idx_user_id` (`user_id`),
  KEY `idx_verify_type` (`verify_type`)
) COMMENT='ç”¨æˆ·è®¤è¯è¡¨';
```

### 4.2 ç´¢å¼•ä¼˜åŒ–å»ºè®®

#### 4.2.1 é«˜é¢‘æŸ¥è¯¢ç´¢å¼•
```sql
-- åŒ¹é…æ¨èæŸ¥è¯¢ï¼ˆè·ç¦»+æ¡ä»¶ï¼‰
ALTER TABLE t_user_profile 
ADD INDEX idx_match_condition (gender, age, deleted);

-- åŠ¨æ€åˆ—è¡¨æŸ¥è¯¢ï¼ˆè·ç¦»+æ—¶é—´ï¼‰
ALTER TABLE t_moment 
ADD INDEX idx_location_time (latitude, longitude, created_at, audit_status);

-- æ­å­æ´»åŠ¨æŸ¥è¯¢ï¼ˆç±»å‹+æ—¶é—´+çŠ¶æ€ï¼‰
ALTER TABLE t_buddy_activity 
ADD INDEX idx_type_time_status (type, activity_time, status, deleted);
```

#### 4.2.2 è”åˆç´¢å¼•è®¾è®¡åŸåˆ™
1. æœ€å·¦åŒ¹é…åŸåˆ™
2. åŒºåˆ†åº¦é«˜çš„åˆ—æ”¾å‰é¢
3. è¦†ç›–ç´¢å¼•ä¼˜åŒ–
4. é¿å…å†—ä½™ç´¢å¼•

---

## 5. æ¥å£è®¾è®¡

### 5.1 æ¥å£è§„èŒƒ

#### 5.1.1 ç»Ÿä¸€å“åº”æ ¼å¼
```java
@Data
public class Result<T> {
    private Integer code;      // çŠ¶æ€ç ï¼š200-æˆåŠŸï¼Œå…¶ä»–-å¤±è´¥
    private String message;    // æç¤ºä¿¡æ¯
    private T data;            // è¿”å›æ•°æ®
    private Long timestamp;    // æ—¶é—´æˆ³
    
    public static <T> Result<T> success(T data) {
        Result<T> result = new Result<>();
        result.setCode(200);
        result.setMessage("success");
        result.setData(data);
        result.setTimestamp(System.currentTimeMillis());
        return result;
    }
    
    public static <T> Result<T> error(Integer code, String message) {
        Result<T> result = new Result<>();
        result.setCode(code);
        result.setMessage(message);
        result.setTimestamp(System.currentTimeMillis());
        return result;
    }
}
```

#### 5.1.2 åˆ†é¡µå“åº”æ ¼å¼
```java
@Data
public class PageResult<T> {
    private List<T> records;     // æ•°æ®åˆ—è¡¨
    private Long total;          // æ€»è®°å½•æ•°
    private Integer current;     // å½“å‰é¡µ
    private Integer size;        // æ¯é¡µå¤§å°
    private Integer pages;       // æ€»é¡µæ•°
}
```

#### 5.1.3 é”™è¯¯ç è®¾è®¡
```java
public class ErrorCode {
    // ç³»ç»Ÿçº§é”™è¯¯ (1000-1999)
    public static final int SYSTEM_ERROR = 1000;
    public static final int PARAM_ERROR = 1001;
    public static final int AUTH_ERROR = 1002;
    
    // ä¸šåŠ¡çº§é”™è¯¯ (2000-2999)
    public static final int USER_NOT_FOUND = 2001;
    public static final int MATCH_LIMIT_EXCEEDED = 2002;
    public static final int ALREADY_LIKED = 2003;
    public static final int NOT_MATCHED = 2004;
    public static final int SEND_MESSAGE_FORBIDDEN = 2005;
    public static final int PUBLISH_LIMIT_EXCEEDED = 2006;
    public static final int ACTIVITY_FULL = 2007;
    public static final int ALREADY_REGISTERED = 2008;
    
    // VIPç›¸å…³é”™è¯¯ (3000-3999)
    public static final int VIP_REQUIRED = 3001;
    public static final int VIP_EXPIRED = 3002;
}
```

### 5.2 æ ¸å¿ƒæ¥å£åˆ—è¡¨

#### 5.2.1 ç”¨æˆ·è®¤è¯æ¨¡å—
```
POST   /api/auth/wx/login              å¾®ä¿¡ç™»å½•
GET    /api/auth/user/info             è·å–ç”¨æˆ·ä¿¡æ¯
POST   /api/auth/token/refresh         åˆ·æ–°Token
```

#### 5.2.2 ç”¨æˆ·èµ„æ–™æ¨¡å—
```
POST   /api/profile/complete           å®Œå–„èµ„æ–™
PUT    /api/profile/update             æ›´æ–°èµ„æ–™
GET    /api/profile/{userId}           æŸ¥çœ‹èµ„æ–™
POST   /api/profile/tags               ä¿å­˜æ ‡ç­¾
GET    /api/tags/library               è·å–æ ‡ç­¾åº“
POST   /api/profile/photos             ä¸Šä¼ ç…§ç‰‡
GET    /api/profile/preference         è·å–åŒ¹é…åå¥½
POST   /api/profile/preference         ä¿å­˜åŒ¹é…åå¥½
```

#### 5.2.3 åŒ¹é…ç³»ç»Ÿæ¨¡å—
```
GET    /api/matching/recommend         è·å–æ¨èç”¨æˆ·
POST   /api/matching/like              å–œæ¬¢æ“ä½œ
POST   /api/matching/super-like        è¶…çº§å–œæ¬¢
POST   /api/matching/pass              è·³è¿‡æ“ä½œ
GET    /api/matching/liked-me          æŸ¥çœ‹è°å–œæ¬¢æˆ‘
```

#### 5.2.4 èŠå¤©é€šè®¯æ¨¡å—
```
GET    /api/chat/sessions              è·å–èŠå¤©åˆ—è¡¨
GET    /api/chat/messages              è·å–èŠå¤©æ¶ˆæ¯
POST   /api/chat/send                  å‘é€æ¶ˆæ¯
POST   /api/chat/read                  æ ‡è®°å·²è¯»
GET    /api/chat/unread-count          æœªè¯»æ¶ˆæ¯æ•°
```

#### 5.2.5 åŠ¨æ€å¹¿åœºæ¨¡å—
```
GET    /api/moments/list               è·å–åŠ¨æ€åˆ—è¡¨
GET    /api/moments/{momentId}         è·å–åŠ¨æ€è¯¦æƒ…
POST   /api/moments/publish            å‘å¸ƒåŠ¨æ€
POST   /api/moments/like               ç‚¹èµåŠ¨æ€
DELETE /api/moments/unlike             å–æ¶ˆç‚¹èµ
POST   /api/moments/comment            è¯„è®ºåŠ¨æ€
GET    /api/moments/{id}/comments      è·å–è¯„è®º
GET    /api/moments/check-limit        æ£€æŸ¥å‘å¸ƒé™åˆ¶
```

#### 5.2.6 æ­å­å¹³å°æ¨¡å—
```
GET    /api/buddy/activities           è·å–æ´»åŠ¨åˆ—è¡¨
GET    /api/buddy/activities/{id}      è·å–æ´»åŠ¨è¯¦æƒ…
POST   /api/buddy/publish              å‘å¸ƒæ´»åŠ¨
POST   /api/buddy/register             æŠ¥åæ´»åŠ¨
POST   /api/buddy/cancel               å–æ¶ˆæŠ¥å
GET    /api/buddy/my-activities        æˆ‘å‘å¸ƒçš„æ´»åŠ¨
GET    /api/buddy/my-registrations     æˆ‘å‚ä¸çš„æ´»åŠ¨
```

#### 5.2.7 çº¿ä¸‹æ´»åŠ¨æ¨¡å—
```
GET    /api/activities/official        è·å–å®˜æ–¹æ´»åŠ¨
GET    /api/activities/{activityId}    è·å–æ´»åŠ¨è¯¦æƒ…
POST   /api/activities/register        æŠ¥åæ´»åŠ¨
GET    /api/activities/my-history      æˆ‘çš„æ´»åŠ¨è®°å½•
```

#### 5.2.8 ä¼šå‘˜ä¸æ”¯ä»˜æ¨¡å—
```
GET    /api/vip/info                   è·å–ä¼šå‘˜ä¿¡æ¯
POST   /api/vip/create-order           åˆ›å»ºVIPè®¢å•
POST   /api/payment/wx/prepay          å¾®ä¿¡æ”¯ä»˜é¢„ä¸‹å•
POST   /api/payment/wx/callback        å¾®ä¿¡æ”¯ä»˜å›è°ƒ
GET    /api/payment/order/{orderNo}    æŸ¥è¯¢è®¢å•çŠ¶æ€
```

#### 5.2.9 è®¤è¯æ¨¡å—ï¼ˆä¸å«å­¦å†ï¼‰
```
POST   /api/verification/phone/send-code    å‘é€éªŒè¯ç 
POST   /api/verification/phone/verify       éªŒè¯æ‰‹æœºå·
POST   /api/verification/idcard/submit      æäº¤å®åè®¤è¯
GET    /api/verification/face/params        è·å–äººè„¸è¯†åˆ«å‚æ•°
POST   /api/verification/face/submit        æäº¤äººè„¸è¯†åˆ«ç»“æœ
GET    /api/verification/status             è·å–è®¤è¯çŠ¶æ€
```

#### 5.2.10 ç³»ç»Ÿé…ç½®æ¨¡å—ï¼ˆç®¡ç†ç«¯ï¼‰
```
GET    /api/admin/config                   è·å–é…ç½®åˆ—è¡¨
PUT    /api/admin/config/{key}             æ›´æ–°é…ç½®
POST   /api/admin/config/vip/toggle        åˆ‡æ¢ä¼šå‘˜åŠŸèƒ½å¼€å…³
```

---

## 6. ä¼šå‘˜åŠŸèƒ½å¼€å…³è®¾è®¡

### 6.1 è®¾è®¡ç›®æ ‡
- **å‰æœŸ**ï¼šä¼šå‘˜åŠŸèƒ½å…³é—­ï¼Œæ‰€æœ‰ç”¨æˆ·äº«å—å…¨åŠŸèƒ½ï¼Œå¿«é€Ÿç§¯ç´¯ç”¨æˆ·
- **åæœŸ**ï¼šè¿è¥ç¨³å®šåå¼€å¯ä¼šå‘˜åŠŸèƒ½ï¼Œå®ç°å•†ä¸šå˜ç°
- **åˆ‡æ¢**ï¼šé€šè¿‡é…ç½®è¡¨ä¸€é”®åˆ‡æ¢ï¼Œæ— éœ€ä¿®æ”¹ä»£ç 

### 6.2 å®ç°æ–¹æ¡ˆ

#### 6.2.1 é…ç½®è¡¨è®¾è®¡
```sql
-- ç³»ç»Ÿé…ç½®è¡¨
CREATE TABLE `t_system_config` (
  `config_key` VARCHAR(100) PRIMARY KEY,
  `config_value` VARCHAR(500),
  `config_desc` VARCHAR(200)
);

-- å…³é”®é…ç½®é¡¹
INSERT INTO t_system_config VALUES
('vip.feature.enabled', 'false', 'ä¼šå‘˜åŠŸèƒ½æ€»å¼€å…³'),
('vip.daily.free.match.count', '3', 'å…è´¹ç”¨æˆ·æ¯æ—¥åŒ¹é…æ¬¡æ•°'),
('vip.daily.free.super.like.count', '1', 'å…è´¹ç”¨æˆ·æ¯æ—¥è¶…çº§å–œæ¬¢æ¬¡æ•°');
```

#### 6.2.2 é…ç½®æœåŠ¡
```java
@Service
public class SystemConfigService {
    
    @Autowired
    private SystemConfigMapper configMapper;
    
    @Autowired
    private RedisTemplate<String, String> redisTemplate;
    
    /**
     * è·å–ä¼šå‘˜åŠŸèƒ½å¼€å…³çŠ¶æ€
     * @return true-å¼€å¯ï¼Œfalse-å…³é—­
     */
    public boolean isVipFeatureEnabled() {
        return getBoolean("vip.feature.enabled", false);
    }
    
    /**
     * åˆ‡æ¢ä¼šå‘˜åŠŸèƒ½å¼€å…³
     * @param enabled æ˜¯å¦å¼€å¯
     */
    @Transactional
    public void toggleVipFeature(boolean enabled) {
        updateConfig("vip.feature.enabled", String.valueOf(enabled));
        
        // æ¸…é™¤ç›¸å…³ç¼“å­˜
        clearVipCache();
        
        // è®°å½•æ“ä½œæ—¥å¿—
        log.info("ä¼šå‘˜åŠŸèƒ½å¼€å…³å·²{}ï¼Œæ“ä½œæ—¶é—´ï¼š{}", 
                enabled ? "å¼€å¯" : "å…³é—­", LocalDateTime.now());
    }
    
    // è·å–é…ç½®å€¼ï¼ˆå¸¦ç¼“å­˜ï¼‰
    private Boolean getBoolean(String key, Boolean defaultValue) {
        String cacheKey = "config:" + key;
        String cached = redisTemplate.opsForValue().get(cacheKey);
        
        if (cached != null) {
            return Boolean.parseBoolean(cached);
        }
        
        SystemConfig config = configMapper.selectById(key);
        String value = config != null ? config.getConfigValue() 
                                      : String.valueOf(defaultValue);
        
        // ç¼“å­˜10åˆ†é’Ÿ
        redisTemplate.opsForValue().set(cacheKey, value, 10, TimeUnit.MINUTES);
        
        return Boolean.parseBoolean(value);
    }
}
```

#### 6.2.3 ä¸šåŠ¡é€»è¾‘ä¸­çš„åº”ç”¨

**åŒ¹é…é™åˆ¶æ£€æŸ¥**:
```java
@Service
public class MatchingService {
    
    @Autowired
    private SystemConfigService configService;
    
    public boolean checkMatchLimit(Long userId, int matchType) {
        // 1. æ£€æŸ¥ä¼šå‘˜åŠŸèƒ½å¼€å…³
        if (!configService.isVipFeatureEnabled()) {
            return true;  // ä¼šå‘˜åŠŸèƒ½å…³é—­ï¼Œä¸é™åˆ¶
        }
        
        // 2. ä¼šå‘˜åŠŸèƒ½å¼€å¯ï¼Œæ£€æŸ¥VIPçŠ¶æ€
        VipMember vip = vipService.getValidVip(userId);
        if (vip != null) {
            return true;  // VIPç”¨æˆ·ä¸é™åˆ¶
        }
        
        // 3. éVIPç”¨æˆ·ï¼Œæ£€æŸ¥æ¯æ—¥é™åˆ¶
        // ... æ£€æŸ¥æ¯æ—¥æ¬¡æ•°
    }
}
```

**æŸ¥çœ‹å–œæ¬¢æˆ‘çš„äºº**:
```java
@Service
public class MatchingService {
    
    public Page<UserCardDTO> getLikedMe(Long userId, int page, int size) {
        // 1. æ£€æŸ¥æƒé™
        if (configService.isVipFeatureEnabled()) {
            // ä¼šå‘˜åŠŸèƒ½å¼€å¯ï¼Œéœ€è¦VIPæƒé™
            VipMember vip = vipService.getValidVip(userId);
            if (vip == null) {
                throw new BusinessException(ErrorCode.VIP_REQUIRED, 
                    "è¯¥åŠŸèƒ½éœ€è¦å¼€é€šVIPä¼šå‘˜");
            }
        }
        
        // 2. æŸ¥è¯¢å–œæ¬¢æˆ‘çš„äºº
        // ...
    }
}
```

### 6.3 ç®¡ç†ç«¯æ¥å£

**åˆ‡æ¢ä¼šå‘˜åŠŸèƒ½å¼€å…³**:
```java
@RestController
@RequestMapping("/api/admin")
public class AdminConfigController {
    
    @Autowired
    private SystemConfigService configService;
    
    /**
     * åˆ‡æ¢ä¼šå‘˜åŠŸèƒ½å¼€å…³
     * @param enabled æ˜¯å¦å¼€å¯
     */
    @PostMapping("/config/vip/toggle")
    public Result<Void> toggleVipFeature(@RequestParam Boolean enabled) {
        // æƒé™æ ¡éªŒï¼ˆç®¡ç†å‘˜ï¼‰
        // ...
        
        configService.toggleVipFeature(enabled);
        
        return Result.success(null);
    }
    
    /**
     * è·å–ä¼šå‘˜åŠŸèƒ½çŠ¶æ€
     */
    @GetMapping("/config/vip/status")
    public Result<VipFeatureStatusDTO> getVipFeatureStatus() {
        boolean enabled = configService.isVipFeatureEnabled();
        
        VipFeatureStatusDTO status = new VipFeatureStatusDTO();
        status.setEnabled(enabled);
        status.setFreeMatchCount(configService.getInt("vip.daily.free.match.count", 3));
        status.setFreeSuperLikeCount(configService.getInt("vip.daily.free.super.like.count", 1));
        
        return Result.success(status);
    }
}
```

### 6.4 åˆ‡æ¢ç­–ç•¥

#### 6.4.1 å¼€å¯ä¼šå‘˜åŠŸèƒ½å‰çš„å‡†å¤‡
1. **æ•°æ®åˆ†æ**: åˆ†æç”¨æˆ·æ´»è·ƒåº¦ã€ç•™å­˜ç‡ã€ä»˜è´¹æ„æ„¿
2. **ç°åº¦æµ‹è¯•**: å…ˆå¯¹éƒ¨åˆ†ç”¨æˆ·å¼€å¯ï¼Œè§‚å¯Ÿåé¦ˆ
3. **é€šçŸ¥ç”¨æˆ·**: æå‰é€šçŸ¥ç”¨æˆ·ä¼šå‘˜åŠŸèƒ½å³å°†å¼€å¯
4. **ä¼˜æƒ æ´»åŠ¨**: é¦–æ‰¹ä¼šå‘˜ä¼˜æƒ ï¼Œå¸å¼•ç”¨æˆ·è´­ä¹°

#### 6.4.2 å¼€å¯åçš„ç›‘æ§
1. **è½¬åŒ–ç‡ç›‘æ§**: å…è´¹ç”¨æˆ·â†’ä»˜è´¹ç”¨æˆ·è½¬åŒ–ç‡
2. **æµå¤±ç‡ç›‘æ§**: å¼€å¯åçš„ç”¨æˆ·æµå¤±æƒ…å†µ
3. **æ”¶å…¥ç›‘æ§**: æ¯æ—¥ã€æ¯æœˆä¼šå‘˜æ”¶å…¥
4. **åé¦ˆæ”¶é›†**: ç”¨æˆ·å¯¹ä¼šå‘˜åŠŸèƒ½çš„åé¦ˆ

---

## 7. å…³é”®ä¸šåŠ¡æµç¨‹

### 7.1 ç”¨æˆ·é¦–æ¬¡ç™»å½•å®Œæ•´æµç¨‹
```
1. ç”¨æˆ·æ‰“å¼€å°ç¨‹åº
2. è°ƒç”¨wx.login()è·å–code
3. åç«¯é€šè¿‡codeè·å–openid
4. æŸ¥è¯¢æ•°æ®åº“ï¼Œåˆ¤æ–­æ˜¯å¦æ–°ç”¨æˆ·
5. å¦‚æœæ˜¯æ–°ç”¨æˆ·ï¼š
   - åˆ›å»ºç”¨æˆ·è®°å½•
   - ç”ŸæˆJWT token
   - è¿”å›isNewUser=true, profileComplete=false
6. å‰ç«¯è·³è½¬èµ„æ–™å®Œå–„é¡µ
7. ç”¨æˆ·å¡«å†™èµ„æ–™å¹¶ä¸Šä¼ ç…§ç‰‡
8. ç”¨æˆ·é€‰æ‹©å…´è¶£æ ‡ç­¾
9. ç”¨æˆ·è®¾ç½®åŒ¹é…åå¥½
10. æŸ¥çœ‹å¼•å¯¼é¡µ
11. è¿›å…¥ä¸»é¡µå¼€å§‹ä½¿ç”¨
```

### 7.2 åŒ¹é…æˆåŠŸåˆ°èŠå¤©æµç¨‹
```
1. ç”¨æˆ·Aå–œæ¬¢ç”¨æˆ·B
2. æ’å…¥åŒ¹é…è®°å½•ï¼šmatch_result = 1ï¼ˆå•å‘å–œæ¬¢ï¼‰
3. æ£€æŸ¥ç”¨æˆ·Bæ˜¯å¦ä¹Ÿå–œæ¬¢äº†ç”¨æˆ·A
4. å¦‚æœåŒå‘å–œæ¬¢ï¼š
   - æ›´æ–°ä¸¤æ¡è®°å½•ï¼šmatch_result = 2ï¼ˆåŒ¹é…æˆåŠŸï¼‰
   - æ¸…é™¤èŠå¤©é™åˆ¶è®°å½• t_chat_limitï¼ˆå¦‚æœ‰ï¼‰
   - å‘é€é€šçŸ¥ç»™åŒæ–¹ï¼š"åŒ¹é…æˆåŠŸï¼"
5. å‰ç«¯æ˜¾ç¤ºåŒ¹é…æˆåŠŸåŠ¨ç”»
6. ç”¨æˆ·å¯ä»¥é€‰æ‹©ç«‹å³èŠå¤©æˆ–ç»§ç»­åŒ¹é…
7. ç‚¹å‡»èŠå¤©åï¼Œä½¿ç”¨è…¾è®¯äº‘IM SDKè¿›å…¥èŠå¤©é¡µé¢
8. åŒæ–¹å¯ä»¥è‡ªç”±å‘é€æ¶ˆæ¯ï¼ˆæ— é™åˆ¶ï¼Œç”±IMç³»ç»Ÿå¤„ç†ï¼‰
```

### 7.3 å‘å¸ƒåŠ¨æ€å®Œæ•´æµç¨‹
```
1. ç”¨æˆ·ç‚¹å‡»"å‘å¸ƒåŠ¨æ€"
2. ç¼–è¾‘å†…å®¹ï¼ˆæ–‡å­—/å›¾ç‰‡ï¼‰
3. é€‰æ‹©ä½ç½®ï¼ˆå¯é€‰ï¼‰
4. ç‚¹å‡»"å‘å¸ƒ"
5. æ£€æŸ¥æ¯æ—¥å‘å¸ƒé™åˆ¶ï¼ˆ3æ¡ï¼‰
6. ä¸Šä¼ å›¾ç‰‡åˆ°OSS
7. è°ƒç”¨å†…å®¹å®¡æ ¸API
8. å¦‚æœå®¡æ ¸é€šè¿‡ï¼š
   - ä¿å­˜åŠ¨æ€åˆ°æ•°æ®åº“
   - ç«‹å³åœ¨åŠ¨æ€å¹¿åœºæ˜¾ç¤º
9. å¦‚æœéœ€è¦äººå·¥å®¡æ ¸ï¼š
   - ä¿å­˜åŠ¨æ€ï¼Œæ ‡è®°ä¸ºå¾…å®¡æ ¸
   - æç¤º"åŠ¨æ€å®¡æ ¸ä¸­"
10. å®¡æ ¸é€šè¿‡åå‘é€é€šçŸ¥
11. å…¶ä»–ç”¨æˆ·å¯ä»¥çœ‹åˆ°å¹¶äº’åŠ¨
```

### 7.4 æ­å­æ´»åŠ¨æŠ¥åæµç¨‹
```
1. ç”¨æˆ·æµè§ˆæ­å­æ´»åŠ¨åˆ—è¡¨
2. ç‚¹å‡»æ´»åŠ¨æŸ¥çœ‹è¯¦æƒ…
3. ç‚¹å‡»"ç«‹å³æŠ¥å"
4. æ£€æŸ¥æŠ¥åæ¡ä»¶ï¼š
   - æ˜¯å¦å·²æŠ¥å
   - æ˜¯å¦å·²æ»¡å‘˜
   - æ˜¯å¦å·²è¿‡æœŸ
5. æ’å…¥æŠ¥åè®°å½•
6. æ›´æ–°æ´»åŠ¨å‚ä¸äººæ•°
7. åˆ›å»ºä¸å‘èµ·äººçš„èŠå¤©ä¼šè¯
8. å‘é€é€šçŸ¥ç»™å‘èµ·äºº
9. å¦‚æœæ»¡å‘˜ï¼Œæ›´æ–°æ´»åŠ¨çŠ¶æ€ä¸º"å·²æ»¡å‘˜"
10. ç”¨æˆ·å¯ä»¥è”ç³»å‘èµ·äººæ²Ÿé€šè¯¦æƒ…
```

### 7.5 ä¼šå‘˜è´­ä¹°æ”¯ä»˜æµç¨‹
```
1. ç”¨æˆ·è¿›å…¥ä¼šå‘˜ä¸­å¿ƒ
2. é€‰æ‹©ä¼šå‘˜å¥—é¤ï¼ˆæœˆåº¦/å­£åº¦/å¹´åº¦ï¼‰
3. ç‚¹å‡»"è´­ä¹°"
4. åˆ›å»ºè®¢å•
5. è·³è½¬åˆ°æ”¯ä»˜é¡µé¢
6. è°ƒç”¨å¾®ä¿¡æ”¯ä»˜API
7. ç”¨æˆ·å®Œæˆæ”¯ä»˜
8. å¾®ä¿¡å›è°ƒåç«¯
9. éªŒè¯æ”¯ä»˜ç»“æœ
10. å¼€é€šä¼šå‘˜æƒç›Š
11. å‘é€é€šçŸ¥ï¼š"ä¼šå‘˜å¼€é€šæˆåŠŸ"
12. ç”¨æˆ·å¯ä»¥ä½¿ç”¨ä¼šå‘˜ç‰¹æƒ
```

---

## 8. æ•°æ®å­—å…¸

### 8.1 ç”¨æˆ·ç›¸å…³è¡¨

#### t_user (ç”¨æˆ·åŸºç¡€è¡¨)
| å­—æ®µå | ç±»å‹ | è¯´æ˜ | ç¤ºä¾‹ |
|--------|------|------|------|
| id | BIGINT | ä¸»é”® | 1 |
| openid | VARCHAR(100) | å¾®ä¿¡openid | oXxxx123 |
| nickname | VARCHAR(50) | æ˜µç§° | å°é›¨ |
| avatar | VARCHAR(500) | å¤´åƒURL | https://... |
| gender | TINYINT | æ€§åˆ« 1-ç”· 2-å¥³ | 2 |
| age | INT | å¹´é¾„ | 25 |
| phone | VARCHAR(20) | æ‰‹æœºå· | 138****8888 |
| profile_complete | TINYINT | èµ„æ–™æ˜¯å¦å®Œå–„ | 1 |
| online_status | TINYINT | åœ¨çº¿çŠ¶æ€ | 1 |
| last_login_time | DATETIME | æœ€åç™»å½•æ—¶é—´ | 2024-01-01 10:00:00 |
| created_at | DATETIME | åˆ›å»ºæ—¶é—´ | 2024-01-01 09:00:00 |
| updated_at | DATETIME | æ›´æ–°æ—¶é—´ | 2024-01-01 10:00:00 |
| deleted | TINYINT | é€»è¾‘åˆ é™¤ | 0 |

#### t_user_profile (ç”¨æˆ·è¯¦ç»†èµ„æ–™è¡¨)
| å­—æ®µå | ç±»å‹ | è¯´æ˜ | ç¤ºä¾‹ |
|--------|------|------|------|
| id | BIGINT | ä¸»é”® | 1 |
| user_id | BIGINT | ç”¨æˆ·ID | 1 |
| height | INT | èº«é«˜(cm) | 170 |
| weight | INT | ä½“é‡(kg) | 55 |
| education | VARCHAR(50) | å­¦å† | æœ¬ç§‘ |
| occupation | VARCHAR(100) | èŒä¸š | è®¾è®¡å¸ˆ |
| income | VARCHAR(50) | æ”¶å…¥ | 10-20ä¸‡ |
| hometown | VARCHAR(200) | å®¶ä¹¡ | åŒ—äº¬å¸‚æœé˜³åŒº |
| current_city | VARCHAR(200) | ç°å±…åœ° | åŒ—äº¬å¸‚æœé˜³åŒº |
| marital_status | VARCHAR(20) | å©šå§»çŠ¶å†µ | æœªå©š |
| bio | VARCHAR(500) | ä¸ªäººç®€ä»‹ | çƒ­çˆ±ç”Ÿæ´»... |
| is_verified | TINYINT | æ˜¯å¦å®åè®¤è¯ | 1 |
| verify_status | TINYINT | è®¤è¯çŠ¶æ€ | 2 |

### 8.2 åŒ¹é…ç›¸å…³è¡¨

#### t_matching_preference (åŒ¹é…åå¥½è¡¨)
| å­—æ®µå | ç±»å‹ | è¯´æ˜ | ç¤ºä¾‹ |
|--------|------|------|------|
| id | BIGINT | ä¸»é”® | 1 |
| user_id | BIGINT | ç”¨æˆ·ID | 1 |
| min_age | INT | æœ€å°å¹´é¾„ | 22 |
| max_age | INT | æœ€å¤§å¹´é¾„ | 30 |
| min_height | INT | æœ€å°èº«é«˜ | 165 |
| max_height | INT | æœ€å¤§èº«é«˜ | 185 |
| education | VARCHAR(100) | æœŸæœ›å­¦å† | æœ¬ç§‘,ç¡•å£« |
| income_range | VARCHAR(100) | æœŸæœ›æ”¶å…¥ | 10-20ä¸‡,20-50ä¸‡ |
| max_distance | INT | æœ€å¤§è·ç¦»(km) | 50 |
| location_latitude | DECIMAL(10,7) | ç”¨æˆ·çº¬åº¦ | 39.9042 |
| location_longitude | DECIMAL(10,7) | ç”¨æˆ·ç»åº¦ | 116.4074 |

#### t_match_record (åŒ¹é…è®°å½•è¡¨)
| å­—æ®µå | ç±»å‹ | è¯´æ˜ | ç¤ºä¾‹ |
|--------|------|------|------|
| id | BIGINT | ä¸»é”® | 1 |
| from_user_id | BIGINT | å‘èµ·ç”¨æˆ·ID | 1 |
| to_user_id | BIGINT | ç›®æ ‡ç”¨æˆ·ID | 2 |
| match_type | TINYINT | åŒ¹é…ç±»å‹ 1-å–œæ¬¢ 2-è¶…çº§å–œæ¬¢ | 1 |
| match_result | TINYINT | åŒ¹é…ç»“æœ 0-æœªåŒ¹é… 1-å•å‘ 2-åŒå‘ | 2 |
| matched_at | DATETIME | åŒ¹é…æˆåŠŸæ—¶é—´ | 2024-01-01 10:30:00 |

### 8.3 èŠå¤©ç›¸å…³è¡¨

#### t_chat_limit (èŠå¤©é™åˆ¶è¡¨)

**è¯´æ˜**ï¼šä½¿ç”¨è…¾è®¯äº‘IMåï¼Œåªéœ€æ­¤è¡¨è®°å½•é˜²éªšæ‰°é™åˆ¶ï¼Œæ¶ˆæ¯æ•°æ®ç”±IMç³»ç»Ÿç®¡ç†

| å­—æ®µå | ç±»å‹ | è¯´æ˜ | ç¤ºä¾‹ |
|--------|------|------|------|
| id | BIGINT | ä¸»é”® | 1 |
| sender_id | BIGINT | å‘é€è€…ID | 1 |
| receiver_id | BIGINT | æ¥æ”¶è€…ID | 2 |
| unreplied_count | INT | æœªå›å¤æ¶ˆæ¯æ•° | 1 |
| created_at | DATETIME | åˆ›å»ºæ—¶é—´ | 2024-01-01 10:00:00 |
| updated_at | DATETIME | æ›´æ–°æ—¶é—´ | 2024-01-01 10:30:00 |

### 8.4 åŠ¨æ€ç›¸å…³è¡¨

#### t_moment (åŠ¨æ€è¡¨)
| å­—æ®µå | ç±»å‹ | è¯´æ˜ | ç¤ºä¾‹ |
|--------|------|------|------|
| id | BIGINT | ä¸»é”® | 1 |
| user_id | BIGINT | å‘å¸ƒè€…ID | 1 |
| content | VARCHAR(1000) | åŠ¨æ€å†…å®¹ | ä»Šå¤©çš„å¤•é˜³... |
| location | VARCHAR(200) | ä½ç½® | æœé˜³å…¬å›­ |
| latitude | DECIMAL(10,7) | çº¬åº¦ | 39.9042 |
| longitude | DECIMAL(10,7) | ç»åº¦ | 116.4074 |
| like_count | INT | ç‚¹èµæ•° | 12 |
| comment_count | INT | è¯„è®ºæ•° | 3 |
| view_count | INT | æµè§ˆæ•° | 100 |
| is_top | TINYINT | æ˜¯å¦ç½®é¡¶ | 0 |
| top_expire_time | DATETIME | ç½®é¡¶è¿‡æœŸæ—¶é—´ | NULL |
| audit_status | TINYINT | å®¡æ ¸çŠ¶æ€ 0-å¾…å®¡æ ¸ 1-é€šè¿‡ 2-æ‹’ç» | 1 |

### 8.5 æ­å­æ´»åŠ¨ç›¸å…³è¡¨

#### t_buddy_activity (æ­å­æ´»åŠ¨è¡¨)
| å­—æ®µå | ç±»å‹ | è¯´æ˜ | ç¤ºä¾‹ |
|--------|------|------|------|
| id | BIGINT | ä¸»é”® | 1 |
| creator_id | BIGINT | å‘èµ·äººID | 1 |
| type | VARCHAR(50) | æ´»åŠ¨ç±»å‹ | sport |
| title | VARCHAR(100) | æ´»åŠ¨æ ‡é¢˜ | å‘¨æœ«ç¾½æ¯›çƒ |
| activity_time | DATETIME | æ´»åŠ¨æ—¶é—´ | 2024-01-20 14:00:00 |
| location | VARCHAR(200) | åœ°ç‚¹ | æœé˜³ä½“è‚²é¦† |
| latitude | DECIMAL(10,7) | çº¬åº¦ | 39.9042 |
| longitude | DECIMAL(10,7) | ç»åº¦ | 116.4074 |
| max_participants | INT | æœ€å¤§äººæ•° | 5 |
| current_participants | INT | å½“å‰äººæ•° | 3 |
| description | VARCHAR(1000) | æ´»åŠ¨è¯¦æƒ… | å‘¨æœ«æƒ³æ‰“... |
| status | TINYINT | çŠ¶æ€ 1-æ‹›å‹Ÿä¸­ 2-å·²æ»¡å‘˜ 3-å·²ç»“æŸ | 1 |

### 8.6 ä¼šå‘˜ç›¸å…³è¡¨

#### t_vip_member (ä¼šå‘˜ä¿¡æ¯è¡¨)
| å­—æ®µå | ç±»å‹ | è¯´æ˜ | ç¤ºä¾‹ |
|--------|------|------|------|
| id | BIGINT | ä¸»é”® | 1 |
| user_id | BIGINT | ç”¨æˆ·ID | 1 |
| vip_level | TINYINT | ä¼šå‘˜ç­‰çº§ 1-æœˆ 2-å­£ 3-å¹´ | 2 |
| start_time | DATETIME | å¼€å§‹æ—¶é—´ | 2024-01-01 10:00:00 |
| expire_time | DATETIME | åˆ°æœŸæ—¶é—´ | 2024-04-01 10:00:00 |
| auto_renew | TINYINT | è‡ªåŠ¨ç»­è´¹ | 0 |
| status | TINYINT | çŠ¶æ€ 0-è¿‡æœŸ 1-æœ‰æ•ˆ | 1 |

#### t_order (è®¢å•è¡¨)
| å­—æ®µå | ç±»å‹ | è¯´æ˜ | ç¤ºä¾‹ |
|--------|------|------|------|
| id | BIGINT | ä¸»é”® | 1 |
| order_no | VARCHAR(64) | è®¢å•å· | VIP202401... |
| user_id | BIGINT | ç”¨æˆ·ID | 1 |
| order_type | TINYINT | è®¢å•ç±»å‹ 1-æœˆåº¦ä¼šå‘˜... | 2 |
| amount | DECIMAL(10,2) | é‡‘é¢ | 79.90 |
| pay_status | TINYINT | æ”¯ä»˜çŠ¶æ€ 0-å¾…æ”¯ä»˜ 1-å·²æ”¯ä»˜ | 1 |
| pay_method | VARCHAR(20) | æ”¯ä»˜æ–¹å¼ | wxpay |
| transaction_id | VARCHAR(100) | äº¤æ˜“å· | 4200001234... |
| paid_at | DATETIME | æ”¯ä»˜æ—¶é—´ | 2024-01-01 10:05:00 |

---

## 9. æ€§èƒ½ä¼˜åŒ–æ–¹æ¡ˆ

### 9.1 æ•°æ®åº“ä¼˜åŒ–

#### 9.1.1 ç´¢å¼•ç­–ç•¥
```sql
-- åŒ¹é…è®°å½•è¡¨ç´¢å¼•
CREATE INDEX idx_from_user ON t_match_record(from_user_id, created_at);
CREATE INDEX idx_to_user ON t_match_record(to_user_id, match_result);
CREATE INDEX idx_match_result ON t_match_record(match_result, matched_at);

-- èŠå¤©é™åˆ¶è¡¨ç´¢å¼•ï¼ˆä½¿ç”¨ç¬¬ä¸‰æ–¹IMï¼Œæ— éœ€æ¶ˆæ¯è¡¨ç´¢å¼•ï¼‰
-- å·²åœ¨è¡¨å®šä¹‰ä¸­åˆ›å»º UNIQUE KEY uk_sender_receiver å’Œ KEY idx_receiver

-- åŠ¨æ€è¡¨ç´¢å¼•
CREATE INDEX idx_location ON t_moment(latitude, longitude, created_at);
CREATE INDEX idx_user_time ON t_moment(user_id, created_at);

-- æ­å­æ´»åŠ¨è¡¨ç´¢å¼•
CREATE INDEX idx_type_time ON t_buddy_activity(type, activity_time, status);
CREATE INDEX idx_location_time ON t_buddy_activity(latitude, longitude, activity_time);
```

#### 9.1.2 åˆ†åº“åˆ†è¡¨ç­–ç•¥
```
å½“æ•°æ®é‡è¾¾åˆ°ä¸€å®šè§„æ¨¡æ—¶ï¼š

æ°´å¹³åˆ†è¡¨ï¼š
- t_moment: æŒ‰user_idå–æ¨¡ï¼Œåˆ†8å¼ è¡¨ï¼ˆåŠ¨æ€å†…å®¹è¾ƒå¤šï¼‰
- t_match_record: æŒ‰from_user_idå–æ¨¡ï¼Œåˆ†8å¼ è¡¨ï¼ˆåŒ¹é…è®°å½•è¾ƒå¤šï¼‰
- t_buddy_activity: æŒ‰creator_idå–æ¨¡ï¼Œåˆ†4å¼ è¡¨ï¼ˆæ´»åŠ¨æ•°æ®ï¼‰

æ³¨ï¼šä½¿ç”¨è…¾è®¯äº‘IMåï¼Œæ— éœ€å¯¹èŠå¤©è¡¨åˆ†è¡¨

è¯»å†™åˆ†ç¦»ï¼š
- ä¸»åº“ï¼šå¤„ç†å†™æ“ä½œ
- ä»åº“ï¼šå¤„ç†è¯»æ“ä½œï¼ˆå¤šä¸ªï¼‰
- ä½¿ç”¨MyCatæˆ–ShardingSphereå®ç°
```

### 9.2 ç¼“å­˜ç­–ç•¥

#### 9.2.1 Redisç¼“å­˜è®¾è®¡
```java
/**
 * ç¼“å­˜Keyè®¾è®¡è§„èŒƒ
 */
public class CacheKeys {
    // ç”¨æˆ·ä¿¡æ¯ç¼“å­˜ï¼ˆ30åˆ†é’Ÿï¼‰
    public static final String USER_INFO = "user:info:%s";
    
    // ç”¨æˆ·åŒ¹é…åå¥½ï¼ˆ1å°æ—¶ï¼‰
    public static final String USER_PREFERENCE = "user:preference:%s";
    
    // æ¨èç”¨æˆ·åˆ—è¡¨ï¼ˆ10åˆ†é’Ÿï¼‰
    public static final String RECOMMEND_USERS = "recommend:users:%s:%s";
    
    // èŠå¤©ä¼šè¯åˆ—è¡¨ï¼ˆ5åˆ†é’Ÿï¼‰
    public static final String CHAT_SESSIONS = "chat:sessions:%s";
    
    // åŠ¨æ€åˆ—è¡¨ï¼ˆ3åˆ†é’Ÿï¼‰
    public static final String MOMENT_LIST = "moment:list:%s:%s";
    
    // ç³»ç»Ÿé…ç½®ï¼ˆæ°¸ä¹…ï¼Œæ‰‹åŠ¨åˆ·æ–°ï¼‰
    public static final String SYSTEM_CONFIG = "system:config:%s";
    
    // ä¼šå‘˜åŠŸèƒ½å¼€å…³ï¼ˆæ°¸ä¹…ï¼‰
    public static final String VIP_FEATURE_ENABLED = "vip:feature:enabled";
    
    // ç”¨æˆ·æ¯æ—¥åŒ¹é…æ¬¡æ•°ï¼ˆ24å°æ—¶ï¼‰
    public static final String USER_MATCH_COUNT = "user:match:count:%s:%s";
}

/**
 * ç¼“å­˜æ›´æ–°ç­–ç•¥
 */
@Service
public class CacheService {
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    /**
     * ç”¨æˆ·ä¿¡æ¯ç¼“å­˜ï¼šæ—è·¯ç¼“å­˜ï¼ˆCache Asideï¼‰
     */
    public UserDTO getUserInfo(Long userId) {
        String key = String.format(CacheKeys.USER_INFO, userId);
        
        // 1. å…ˆæŸ¥ç¼“å­˜
        UserDTO cached = (UserDTO) redisTemplate.opsForValue().get(key);
        if (cached != null) {
            return cached;
        }
        
        // 2. æŸ¥æ•°æ®åº“
        User user = userMapper.selectById(userId);
        UserDTO dto = convertToDTO(user);
        
        // 3. å†™å…¥ç¼“å­˜
        redisTemplate.opsForValue().set(key, dto, 30, TimeUnit.MINUTES);
        
        return dto;
    }
    
    /**
     * æ›´æ–°ç”¨æˆ·ä¿¡æ¯ï¼šå…ˆæ›´æ–°æ•°æ®åº“ï¼Œå†åˆ é™¤ç¼“å­˜
     */
    public void updateUserInfo(Long userId, UserDTO dto) {
        // 1. æ›´æ–°æ•°æ®åº“
        userMapper.updateById(convertToEntity(dto));
        
        // 2. åˆ é™¤ç¼“å­˜
        String key = String.format(CacheKeys.USER_INFO, userId);
        redisTemplate.delete(key);
    }
    
    /**
     * æ¨èç”¨æˆ·åˆ—è¡¨ï¼šé¢„çƒ­ç¼“å­˜
     */
    @Scheduled(cron = "0 */10 * * * ?")  // æ¯10åˆ†é’Ÿåˆ·æ–°
    public void refreshRecommendCache() {
        // ä¸ºæ´»è·ƒç”¨æˆ·é¢„çƒ­æ¨èåˆ—è¡¨
        List<Long> activeUserIds = getActiveUserIds();
        
        for (Long userId : activeUserIds) {
            List<UserCardDTO> recommendations = calculateRecommendations(userId);
            String key = String.format(CacheKeys.RECOMMEND_USERS, userId, 1);
            redisTemplate.opsForValue().set(key, recommendations, 10, TimeUnit.MINUTES);
        }
    }
}
```

#### 9.2.2 ç¼“å­˜ç©¿é€ã€å‡»ç©¿ã€é›ªå´©è§£å†³æ–¹æ¡ˆ
```java
/**
 * é˜²æ­¢ç¼“å­˜ç©¿é€ï¼šå¸ƒéš†è¿‡æ»¤å™¨
 */
@Component
public class BloomFilterService {
    
    private BloomFilter<Long> userIdBloomFilter;
    
    @PostConstruct
    public void init() {
        // åˆå§‹åŒ–å¸ƒéš†è¿‡æ»¤å™¨ï¼ˆé¢„è®¡100ä¸‡ç”¨æˆ·ï¼Œè¯¯åˆ¤ç‡0.01ï¼‰
        userIdBloomFilter = BloomFilter.create(
            Funnels.longFunnel(),
            1000000,
            0.01
        );
        
        // åŠ è½½æ‰€æœ‰ç”¨æˆ·ID
        List<Long> userIds = userMapper.selectAllUserIds();
        userIds.forEach(userIdBloomFilter::put);
    }
    
    public boolean userExists(Long userId) {
        return userIdBloomFilter.mightContain(userId);
    }
}

/**
 * é˜²æ­¢ç¼“å­˜å‡»ç©¿ï¼šåˆ†å¸ƒå¼é”
 */
@Service
public class MatchingService {
    
    @Autowired
    private RedissonClient redissonClient;
    
    public List<UserCardDTO> getRecommendUsers(Long userId) {
        String key = String.format(CacheKeys.RECOMMEND_USERS, userId, 1);
        
        // 1. æŸ¥ç¼“å­˜
        List<UserCardDTO> cached = (List<UserCardDTO>) redisTemplate.opsForValue().get(key);
        if (cached != null) {
            return cached;
        }
        
        // 2. è·å–åˆ†å¸ƒå¼é”
        String lockKey = "lock:recommend:" + userId;
        RLock lock = redissonClient.getLock(lockKey);
        
        try {
            // å°è¯•è·å–é”ï¼Œæœ€å¤šç­‰å¾…10ç§’ï¼Œé”30ç§’åè‡ªåŠ¨é‡Šæ”¾
            if (lock.tryLock(10, 30, TimeUnit.SECONDS)) {
                // 3. åŒé‡æ£€æŸ¥
                cached = (List<UserCardDTO>) redisTemplate.opsForValue().get(key);
                if (cached != null) {
                    return cached;
                }
                
                // 4. æŸ¥æ•°æ®åº“å¹¶è®¡ç®—
                List<UserCardDTO> result = calculateRecommendations(userId);
                
                // 5. å†™å…¥ç¼“å­˜
                redisTemplate.opsForValue().set(key, result, 10, TimeUnit.MINUTES);
                
                return result;
            }
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
        } finally {
            lock.unlock();
        }
        
        return Collections.emptyList();
    }
}

/**
 * é˜²æ­¢ç¼“å­˜é›ªå´©ï¼šç¼“å­˜è¿‡æœŸæ—¶é—´åŠ éšæœºå€¼
 */
public void setCacheWithRandomExpire(String key, Object value, long baseSeconds) {
    long randomSeconds = ThreadLocalRandom.current().nextLong(0, 300);  // 0-5åˆ†é’Ÿéšæœº
    long expireSeconds = baseSeconds + randomSeconds;
    
    redisTemplate.opsForValue().set(key, value, expireSeconds, TimeUnit.SECONDS);
}
```

### 9.3 æ¥å£ä¼˜åŒ–

#### 9.3.1 æ‰¹é‡æŸ¥è¯¢ä¼˜åŒ–
```java
/**
 * èŠå¤©åˆ—è¡¨æ‰¹é‡æŸ¥è¯¢ä¼˜åŒ–
 */
@Service
public class ChatService {
    
    public List<ChatSessionDTO> getChatSessions(Long userId) {
        // 1. æŸ¥è¯¢ä¼šè¯åˆ—è¡¨
        List<ChatSession> sessions = chatSessionMapper.selectByUserId(userId);
        
        // 2. æå–æ‰€æœ‰ç”¨æˆ·ID
        Set<Long> userIds = sessions.stream()
            .map(session -> session.getUser1Id().equals(userId) 
                ? session.getUser2Id() 
                : session.getUser1Id())
            .collect(Collectors.toSet());
        
        // 3. æ‰¹é‡æŸ¥è¯¢ç”¨æˆ·ä¿¡æ¯ï¼ˆä¸€æ¬¡æŸ¥è¯¢ï¼‰
        Map<Long, User> userMap = userMapper.selectBatchIds(userIds)
            .stream()
            .collect(Collectors.toMap(User::getId, u -> u));
        
        // 4. ç»„è£…DTO
        return sessions.stream()
            .map(session -> {
                Long otherUserId = session.getUser1Id().equals(userId) 
                    ? session.getUser2Id() 
                    : session.getUser1Id();
                User otherUser = userMap.get(otherUserId);
                
                ChatSessionDTO dto = new ChatSessionDTO();
                dto.setChatId(session.getId());
                dto.setNickname(otherUser.getNickname());
                dto.setAvatar(otherUser.getAvatar());
                // ... å…¶ä»–å­—æ®µ
                return dto;
            })
            .collect(Collectors.toList());
    }
}
```

#### 9.3.2 å¼‚æ­¥å¤„ç†
```java
/**
 * å¼‚æ­¥ä»»åŠ¡é…ç½®
 */
@Configuration
@EnableAsync
public class AsyncConfig {
    
    @Bean(name = "taskExecutor")
    public Executor taskExecutor() {
        ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();
        executor.setCorePoolSize(10);
        executor.setMaxPoolSize(20);
        executor.setQueueCapacity(200);
        executor.setThreadNamePrefix("async-");
        executor.initialize();
        return executor;
    }
}

/**
 * å¼‚æ­¥ä»»åŠ¡ç¤ºä¾‹
 */
@Service
public class NotificationService {
    
    /**
     * å¼‚æ­¥å‘é€é€šçŸ¥
     */
    @Async("taskExecutor")
    public void sendNotification(Long userId, String message) {
        // å‘é€å¾®ä¿¡æ¨¡æ¿æ¶ˆæ¯
        wxService.sendTemplateMessage(userId, message);
        
        // è®°å½•é€šçŸ¥æ—¥å¿—
        notificationLogMapper.insert(new NotificationLog(userId, message));
    }
    
    /**
     * å¼‚æ­¥å†…å®¹å®¡æ ¸
     */
    @Async("taskExecutor")
    public void auditContent(Long momentId, String content, List<String> images) {
        // è°ƒç”¨ç¬¬ä¸‰æ–¹å†…å®¹å®¡æ ¸API
        AuditResult result = contentAuditService.audit(content, images);
        
        // æ›´æ–°å®¡æ ¸çŠ¶æ€
        if (result.isPass()) {
            momentMapper.updateAuditStatus(momentId, 1);  // é€šè¿‡
        } else {
            momentMapper.updateAuditStatus(momentId, 2);  // æ‹’ç»
        }
    }
}
```

---

## 10. å®‰å…¨è®¾è®¡

### 10.1 æ¥å£å®‰å…¨

#### 10.1.1 JWTè®¤è¯
```java
/**
 * JWTå·¥å…·ç±»
 */
@Component
public class JwtUtil {
    
    @Value("${jwt.secret}")
    private String secret;
    
    @Value("${jwt.expiration}")
    private Long expiration;
    
    /**
     * ç”ŸæˆJWT Token
     */
    public String generateToken(Long userId, String openid) {
        Map<String, Object> claims = new HashMap<>();
        claims.put("userId", userId);
        claims.put("openid", openid);
        
        return Jwts.builder()
            .setClaims(claims)
            .setSubject(String.valueOf(userId))
            .setIssuedAt(new Date())
            .setExpiration(new Date(System.currentTimeMillis() + expiration))
            .signWith(SignatureAlgorithm.HS512, secret)
            .compact();
    }
    
    /**
     * è§£æJWT Token
     */
    public Claims parseToken(String token) {
        return Jwts.parser()
            .setSigningKey(secret)
            .parseClaimsJws(token)
            .getBody();
    }
    
    /**
     * éªŒè¯Tokenæ˜¯å¦æœ‰æ•ˆ
     */
    public boolean validateToken(String token) {
        try {
            Claims claims = parseToken(token);
            return !claims.getExpiration().before(new Date());
        } catch (Exception e) {
            return false;
        }
    }
}

/**
 * JWTæ‹¦æˆªå™¨
 */
@Component
public class JwtInterceptor implements HandlerInterceptor {
    
    @Autowired
    private JwtUtil jwtUtil;
    
    @Override
    public boolean preHandle(HttpServletRequest request, 
                           HttpServletResponse response, 
                           Object handler) throws Exception {
        
        // ä»Headerä¸­è·å–Token
        String token = request.getHeader("Authorization");
        if (token == null || !token.startsWith("Bearer ")) {
            response.setStatus(HttpServletResponse.SC_UNAUTHORIZED);
            return false;
        }
        
        token = token.substring(7);
        
        // éªŒè¯Token
        if (!jwtUtil.validateToken(token)) {
            response.setStatus(HttpServletResponse.SC_UNAUTHORIZED);
            return false;
        }
        
        // è§£æTokenï¼Œå°†ç”¨æˆ·IDæ”¾å…¥Request
        Claims claims = jwtUtil.parseToken(token);
        Long userId = claims.get("userId", Long.class);
        request.setAttribute("userId", userId);
        
        return true;
    }
}
```

#### 10.1.2 æ¥å£é™æµ
```java
/**
 * é™æµæ³¨è§£
 */
@Target(ElementType.METHOD)
@Retention(RetentionPolicy.RUNTIME)
public @interface RateLimit {
    int limit() default 10;  // é™åˆ¶æ¬¡æ•°
    int period() default 60;  // æ—¶é—´çª—å£ï¼ˆç§’ï¼‰
}

/**
 * é™æµAOP
 */
@Aspect
@Component
public class RateLimitAspect {
    
    @Autowired
    private RedisTemplate<String, Object> redisTemplate;
    
    @Around("@annotation(rateLimit)")
    public Object around(ProceedingJoinPoint joinPoint, RateLimit rateLimit) throws Throwable {
        // è·å–ç”¨æˆ·ID
        ServletRequestAttributes attributes = 
            (ServletRequestAttributes) RequestContextHolder.getRequestAttributes();
        HttpServletRequest request = attributes.getRequest();
        Long userId = (Long) request.getAttribute("userId");
        
        // é™æµKey
        String key = String.format("rate:limit:%s:%s", 
            joinPoint.getSignature().getName(), 
            userId);
        
        // è·å–å½“å‰è®¡æ•°
        Integer count = (Integer) redisTemplate.opsForValue().get(key);
        
        if (count == null) {
            // ç¬¬ä¸€æ¬¡è®¿é—®
            redisTemplate.opsForValue().set(key, 1, rateLimit.period(), TimeUnit.SECONDS);
        } else if (count < rateLimit.limit()) {
            // æœªè¶…é™ï¼Œè®¡æ•°+1
            redisTemplate.opsForValue().increment(key);
        } else {
            // è¶…é™ï¼Œæ‹’ç»è¯·æ±‚
            throw new BusinessException("è¯·æ±‚è¿‡äºé¢‘ç¹ï¼Œè¯·ç¨åå†è¯•");
        }
        
        return joinPoint.proceed();
    }
}

/**
 * ä½¿ç”¨ç¤ºä¾‹
 */
@RestController
@RequestMapping("/api/moments")
public class MomentController {
    
    @PostMapping("/publish")
    @RateLimit(limit = 3, period = 86400)  // æ¯å¤©æœ€å¤šå‘å¸ƒ3æ¡
    public Result<MomentDTO> publishMoment(@RequestBody MomentRequest request) {
        // ...
    }
    
    @PostMapping("/like")
    @RateLimit(limit = 100, period = 60)  // æ¯åˆ†é’Ÿæœ€å¤šç‚¹èµ100æ¬¡
    public Result<Void> likeMoment(@RequestBody LikeRequest request) {
        // ...
    }
}
```

### 10.2 æ•°æ®å®‰å…¨

#### 10.2.1 æ•æ„Ÿä¿¡æ¯åŠ å¯†
```java
/**
 * æ•°æ®è„±æ•å·¥å…·ç±»
 */
public class DesensitizationUtil {
    
    /**
     * æ‰‹æœºå·è„±æ•ï¼š138****8888
     */
    public static String desensitizePhone(String phone) {
        if (StringUtils.isEmpty(phone) || phone.length() != 11) {
            return phone;
        }
        return phone.substring(0, 3) + "****" + phone.substring(7);
    }
    
    /**
     * èº«ä»½è¯å·è„±æ•ï¼š110101********1234
     */
    public static String desensitizeIdCard(String idCard) {
        if (StringUtils.isEmpty(idCard) || idCard.length() != 18) {
            return idCard;
        }
        return idCard.substring(0, 6) + "********" + idCard.substring(14);
    }
    
    /**
     * çœŸå®å§“åè„±æ•ï¼šå¼ *
     */
    public static String desensitizeName(String name) {
        if (StringUtils.isEmpty(name) || name.length() < 2) {
            return name;
        }
        return name.substring(0, 1) + "*".repeat(name.length() - 1);
    }
}

/**
 * æ•æ„Ÿä¿¡æ¯åŠ å¯†å­˜å‚¨
 */
@Component
public class EncryptionService {
    
    @Value("${encryption.secret}")
    private String secret;
    
    /**
     * AESåŠ å¯†
     */
    public String encrypt(String plainText) {
        try {
            SecretKeySpec key = new SecretKeySpec(secret.getBytes(), "AES");
            Cipher cipher = Cipher.getInstance("AES/ECB/PKCS5Padding");
            cipher.init(Cipher.ENCRYPT_MODE, key);
            byte[] encrypted = cipher.doFinal(plainText.getBytes());
            return Base64.getEncoder().encodeToString(encrypted);
        } catch (Exception e) {
            throw new BusinessException("åŠ å¯†å¤±è´¥");
        }
    }
    
    /**
     * AESè§£å¯†
     */
    public String decrypt(String encryptedText) {
        try {
            SecretKeySpec key = new SecretKeySpec(secret.getBytes(), "AES");
            Cipher cipher = Cipher.getInstance("AES/ECB/PKCS5Padding");
            cipher.init(Cipher.DECRYPT_MODE, key);
            byte[] decrypted = cipher.doFinal(Base64.getDecoder().decode(encryptedText));
            return new String(decrypted);
        } catch (Exception e) {
            throw new BusinessException("è§£å¯†å¤±è´¥");
        }
    }
}
```

#### 10.2.2 SQLæ³¨å…¥é˜²æŠ¤
```java
/**
 * ä½¿ç”¨MyBatis-Plusé˜²æ­¢SQLæ³¨å…¥
 */
@Service
public class UserService {
    
    @Autowired
    private UserMapper userMapper;
    
    /**
     * æ­£ç¡®çš„åšæ³•ï¼šä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢
     */
    public List<User> searchUsers(String keyword) {
        LambdaQueryWrapper<User> wrapper = new LambdaQueryWrapper<>();
        wrapper.like(User::getNickname, keyword)
               .or()
               .like(User::getBio, keyword);
        
        return userMapper.selectList(wrapper);
    }
    
    /**
     * é”™è¯¯çš„åšæ³•ï¼šæ‹¼æ¥SQLï¼ˆæ°¸è¿œä¸è¦è¿™æ ·åšï¼‰
     */
    // public List<User> searchUsersUnsafe(String keyword) {
    //     String sql = "SELECT * FROM t_user WHERE nickname LIKE '%" + keyword + "%'";
    //     return userMapper.selectBySql(sql);  // å±é™©ï¼
    // }
}
```

### 10.3 å†…å®¹å®‰å…¨

#### 10.3.1 å†…å®¹å®¡æ ¸
```java
/**
 * å†…å®¹å®¡æ ¸æœåŠ¡
 */
@Service
public class ContentAuditService {
    
    /**
     * æ•æ„Ÿè¯è¿‡æ»¤
     */
    public boolean containsSensitiveWords(String content) {
        // åŠ è½½æ•æ„Ÿè¯åº“
        Set<String> sensitiveWords = loadSensitiveWords();
        
        // ä½¿ç”¨DFAç®—æ³•æ£€æµ‹æ•æ„Ÿè¯
        for (String word : sensitiveWords) {
            if (content.contains(word)) {
                return true;
            }
        }
        
        return false;
    }
    
    /**
     * è°ƒç”¨ç¬¬ä¸‰æ–¹å®¡æ ¸API
     */
    public AuditResult auditContent(String content, List<String> images) {
        // è°ƒç”¨è…¾è®¯äº‘å†…å®¹å®‰å…¨API
        JSONObject result = tencentCloudService.textModeration(content);
        
        if (result.getString("Suggestion").equals("Block")) {
            return AuditResult.rejected("åŒ…å«è¿è§„å†…å®¹");
        }
        
        // å›¾ç‰‡å®¡æ ¸
        for (String imageUrl : images) {
            JSONObject imageResult = tencentCloudService.imageModeration(imageUrl);
            if (imageResult.getString("Suggestion").equals("Block")) {
                return AuditResult.rejected("å›¾ç‰‡åŒ…å«è¿è§„å†…å®¹");
            }
        }
        
        return AuditResult.passed();
    }
}
```

---

## 11. éƒ¨ç½²æ–¹æ¡ˆ

### 11.1 å¼€å‘ç¯å¢ƒ
```yaml
# application-dev.yml
server:
  port: 8080

spring:
  datasource:
    url: jdbc:mysql://localhost:3306/pengpeng_dev
    username: root
    password: root
  
  redis:
    host: localhost
    port: 6379

# å¾®ä¿¡å°ç¨‹åºé…ç½®ï¼ˆæµ‹è¯•è´¦å·ï¼‰
wx:
  appid: wxtest123
  secret: test_secret

# ä¼šå‘˜åŠŸèƒ½å¼€å…³ï¼ˆå¼€å‘ç¯å¢ƒé»˜è®¤å…³é—­ï¼‰
vip:
  feature:
    enabled: false
```

### 11.2 ç”Ÿäº§ç¯å¢ƒ
```yaml
# application-prod.yml
server:
  port: 80

spring:
  datasource:
    url: jdbc:mysql://rm-xxx.mysql.rds.aliyuncs.com:3306/pengpeng_prod
    username: ${DB_USERNAME}
    password: ${DB_PASSWORD}
    hikari:
      maximum-pool-size: 20
      minimum-idle: 5
  
  redis:
    cluster:
      nodes:
        - redis-1:6379
        - redis-2:6379
        - redis-3:6379

# å¾®ä¿¡å°ç¨‹åºé…ç½®ï¼ˆæ­£å¼è´¦å·ï¼‰
wx:
  appid: ${WX_APPID}
  secret: ${WX_SECRET}

# ä¼šå‘˜åŠŸèƒ½å¼€å…³ï¼ˆç”Ÿäº§ç¯å¢ƒä»æ•°æ®åº“è¯»å–ï¼‰
vip:
  feature:
    enabled: ${VIP_FEATURE_ENABLED:false}
```

### 11.3 Dockeréƒ¨ç½²
```dockerfile
# Dockerfile
FROM openjdk:8-jre-alpine

WORKDIR /app

COPY target/pengpeng-0.0.1-SNAPSHOT.jar app.jar

EXPOSE 8080

ENTRYPOINT ["java", "-jar", "-Dspring.profiles.active=prod", "app.jar"]
```

```yaml
# docker-compose.yml
version: '3'

services:
  app:
    build: .
    ports:
      - "8080:8080"
    environment:
      - DB_USERNAME=root
      - DB_PASSWORD=password
      - WX_APPID=wxc5c00133500315e3
      - WX_SECRET=908f9750e78217b8083bda7c27ea58b2
    depends_on:
      - mysql
      - redis
  
  mysql:
    image: mysql:8.0
    environment:
      - MYSQL_ROOT_PASSWORD=password
      - MYSQL_DATABASE=pengpeng_prod
    volumes:
      - mysql_data:/var/lib/mysql
  
  redis:
    image: redis:6-alpine
    ports:
      - "6379:6379"

volumes:
  mysql_data:
```

---

## 12. ç›‘æ§ä¸è¿ç»´

### 12.1 æ—¥å¿—ç®¡ç†
```xml
<!-- logback-spring.xml -->
<?xml version="1.0" encoding="UTF-8"?>
<configuration>
    <!-- æ—¥å¿—è¾“å‡ºæ ¼å¼ -->
    <property name="LOG_PATTERN" 
              value="%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{50} - %msg%n"/>
    
    <!-- æ§åˆ¶å°è¾“å‡º -->
    <appender name="CONSOLE" class="ch.qos.logback.core.ConsoleAppender">
        <encoder>
            <pattern>${LOG_PATTERN}</pattern>
        </encoder>
    </appender>
    
    <!-- æ–‡ä»¶è¾“å‡º -->
    <appender name="FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <file>logs/pengpeng.log</file>
        <rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">
            <fileNamePattern>logs/pengpeng.%d{yyyy-MM-dd}.log</fileNamePattern>
            <maxHistory>30</maxHistory>
        </rollingPolicy>
        <encoder>
            <pattern>${LOG_PATTERN}</pattern>
        </encoder>
    </appender>
    
    <!-- é”™è¯¯æ—¥å¿—å•ç‹¬è¾“å‡º -->
    <appender name="ERROR_FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
        <file>logs/pengpeng-error.log</file>
        <filter class="ch.qos.logback.classic.filter.LevelFilter">
            <level>ERROR</level>
            <onMatch>ACCEPT</onMatch>
            <onMismatch>DENY</onMismatch>
        </filter>
        <rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">
            <fileNamePattern>logs/pengpeng-error.%d{yyyy-MM-dd}.log</fileNamePattern>
            <maxHistory>30</maxHistory>
        </rollingPolicy>
        <encoder>
            <pattern>${LOG_PATTERN}</pattern>
        </encoder>
    </appender>
    
    <root level="INFO">
        <appender-ref ref="CONSOLE"/>
        <appender-ref ref="FILE"/>
        <appender-ref ref="ERROR_FILE"/>
    </root>
</configuration>
```

### 12.2 ç›‘æ§æŒ‡æ ‡
```java
/**
 * ä¸šåŠ¡ç›‘æ§æŒ‡æ ‡
 */
@Component
public class MetricsService {
    
    @Autowired
    private MeterRegistry meterRegistry;
    
    /**
     * è®°å½•åŒ¹é…æ¬¡æ•°
     */
    public void recordMatchCount(String matchType) {
        Counter counter = meterRegistry.counter("match.count", "type", matchType);
        counter.increment();
    }
    
    /**
     * è®°å½•åŒ¹é…æˆåŠŸç‡
     */
    public void recordMatchSuccess() {
        Counter counter = meterRegistry.counter("match.success");
        counter.increment();
    }
    
    /**
     * è®°å½•æ¥å£å“åº”æ—¶é—´
     */
    public void recordApiDuration(String api, long duration) {
        Timer timer = meterRegistry.timer("api.duration", "api", api);
        timer.record(duration, TimeUnit.MILLISECONDS);
    }
}
```

---

## 13. é™„å½•

### 13.1 é”™è¯¯ç å®šä¹‰
```java
/**
 * ä¸šåŠ¡é”™è¯¯ç 
 */
public enum ErrorCode {
    
    // é€šç”¨é”™è¯¯ (1000-1999)
    SUCCESS(0, "æˆåŠŸ"),
    SYSTEM_ERROR(1000, "ç³»ç»Ÿé”™è¯¯"),
    PARAM_ERROR(1001, "å‚æ•°é”™è¯¯"),
    UNAUTHORIZED(1002, "æœªæˆæƒ"),
    FORBIDDEN(1003, "æ— æƒé™"),
    NOT_FOUND(1004, "èµ„æºä¸å­˜åœ¨"),
    
    // ç”¨æˆ·ç›¸å…³ (2000-2999)
    USER_NOT_FOUND(2000, "ç”¨æˆ·ä¸å­˜åœ¨"),
    USER_ALREADY_EXISTS(2001, "ç”¨æˆ·å·²å­˜åœ¨"),
    PROFILE_INCOMPLETE(2002, "èµ„æ–™æœªå®Œå–„"),
    NICKNAME_DUPLICATE(2003, "æ˜µç§°å·²è¢«ä½¿ç”¨"),
    
    // åŒ¹é…ç›¸å…³ (3000-3999)
    MATCH_LIMIT_EXCEEDED(3000, "ä»Šæ—¥åŒ¹é…æ¬¡æ•°å·²ç”¨å®Œ"),
    ALREADY_MATCHED(3001, "å·²ç»åŒ¹é…è¿‡äº†"),
    CANNOT_MATCH_SELF(3002, "ä¸èƒ½åŒ¹é…è‡ªå·±"),
    
    // èŠå¤©ç›¸å…³ (4000-4999)
    CHAT_NOT_FOUND(4000, "èŠå¤©ä¸å­˜åœ¨"),
    MESSAGE_LIMIT_EXCEEDED(4001, "å¯¹æ–¹æœªå›å¤ï¼Œæ— æ³•ç»§ç»­å‘é€"),
    BLOCKED_BY_USER(4002, "å·²è¢«å¯¹æ–¹æ‹‰é»‘"),
    
    // åŠ¨æ€ç›¸å…³ (5000-5999)
    MOMENT_PUBLISH_LIMIT(5000, "ä»Šæ—¥å‘å¸ƒæ¬¡æ•°å·²ç”¨å®Œ"),
    MOMENT_UNDER_REVIEW(5001, "åŠ¨æ€å®¡æ ¸ä¸­"),
    MOMENT_REJECTED(5002, "åŠ¨æ€å®¡æ ¸æœªé€šè¿‡"),
    SENSITIVE_CONTENT(5003, "å†…å®¹åŒ…å«æ•æ„Ÿä¿¡æ¯"),
    
    // ä¼šå‘˜ç›¸å…³ (6000-6999)
    NOT_VIP_MEMBER(6000, "éä¼šå‘˜ç”¨æˆ·"),
    VIP_EXPIRED(6001, "ä¼šå‘˜å·²è¿‡æœŸ"),
    PAYMENT_FAILED(6002, "æ”¯ä»˜å¤±è´¥"),
    ORDER_NOT_FOUND(6003, "è®¢å•ä¸å­˜åœ¨"),
    
    // æ´»åŠ¨ç›¸å…³ (7000-7999)
    ACTIVITY_FULL(7000, "æ´»åŠ¨å·²æ»¡å‘˜"),
    ALREADY_REGISTERED(7001, "å·²ç»æŠ¥åè¿‡äº†"),
    ACTIVITY_EXPIRED(7002, "æ´»åŠ¨å·²è¿‡æœŸ"),
    REGISTRATION_LIMIT(7003, "å‘å¸ƒæ´»åŠ¨æ¬¡æ•°å·²è¾¾ä¸Šé™");
    
    private final int code;
    private final String message;
    
    ErrorCode(int code, String message) {
        this.code = code;
        this.message = message;
    }
    
    // getters...
}
```

### 13.2 å¼€å‘è§„èŒƒ
```java
/**
 * Controllerå±‚è§„èŒƒ
 */
@RestController
@RequestMapping("/api/users")
@Api(tags = "ç”¨æˆ·ç®¡ç†")
@Slf4j
public class UserController {
    
    /**
     * 1. ä½¿ç”¨@ApiOperationæ³¨è§£è¯´æ˜æ¥å£ç”¨é€”
     * 2. ä½¿ç”¨@Validatedè¿›è¡Œå‚æ•°æ ¡éªŒ
     * 3. ç»Ÿä¸€ä½¿ç”¨ResultåŒ…è£…è¿”å›å€¼
     * 4. è®°å½•å…³é”®æ“ä½œæ—¥å¿—
     * 5. æ•è·å¹¶å¤„ç†å¼‚å¸¸
     */
    @PostMapping("/profile")
    @ApiOperation("æ›´æ–°ç”¨æˆ·èµ„æ–™")
    public Result<UserProfileDTO> updateProfile(
            @Validated @RequestBody UserProfileRequest request,
            HttpServletRequest httpRequest) {
        
        Long userId = (Long) httpRequest.getAttribute("userId");
        log.info("ç”¨æˆ·{}æ›´æ–°èµ„æ–™: {}", userId, request);
        
        try {
            UserProfileDTO profile = userService.updateProfile(userId, request);
            return Result.success(profile);
        } catch (BusinessException e) {
            log.error("æ›´æ–°èµ„æ–™å¤±è´¥", e);
            return Result.error(e.getCode(), e.getMessage());
        }
    }
}

/**
 * Serviceå±‚è§„èŒƒ
 */
@Service
@Slf4j
public class UserServiceImpl implements UserService {
    
    /**
     * 1. ä½¿ç”¨@Transactionalç®¡ç†äº‹åŠ¡
     * 2. å‚æ•°æ ¡éªŒ
     * 3. ä¸šåŠ¡é€»è¾‘æ¸…æ™°
     * 4. å¼‚å¸¸ç»Ÿä¸€æŠ›å‡ºBusinessException
     */
    @Override
    @Transactional(rollbackFor = Exception.class)
    public UserProfileDTO updateProfile(Long userId, UserProfileRequest request) {
        // 1. å‚æ•°æ ¡éªŒ
        if (userId == null) {
            throw new BusinessException(ErrorCode.PARAM_ERROR);
        }
        
        // 2. æŸ¥è¯¢ç”¨æˆ·
        User user = userMapper.selectById(userId);
        if (user == null) {
            throw new BusinessException(ErrorCode.USER_NOT_FOUND);
        }
        
        // 3. æ›´æ–°èµ„æ–™
        UserProfile profile = new UserProfile();
        BeanUtils.copyProperties(request, profile);
        profile.setUserId(userId);
        userProfileMapper.updateById(profile);
        
        // 4. åˆ é™¤ç¼“å­˜
        cacheService.deleteUserCache(userId);
        
        // 5. è¿”å›ç»“æœ
        return convertToDTO(profile);
    }
}
```

---

## 14. æ€»ç»“

æœ¬ç³»ç»Ÿåˆ†ææ–‡æ¡£è¯¦ç»†æè¿°äº†"ç¢°ç¢°"äº¤å‹ç¤¾äº¤å°ç¨‹åºçš„å®Œæ•´æŠ€æœ¯å®ç°æ–¹æ¡ˆï¼ŒåŒ…æ‹¬ï¼š

### 14.1 æ ¸å¿ƒç‰¹æ€§
1. **åŒæ¨¡å¼è¿è¥** - æ‹çˆ±äº¤å‹ + æ­å­å¹³å°
2. **æ™ºèƒ½åŒ¹é…ç®—æ³•** - å¤šç»´åº¦æƒé‡è®¡ç®—
3. **ä¼šå‘˜åŠŸèƒ½å¼€å…³** - å‰æœŸå…è´¹ï¼ŒåæœŸä»˜è´¹
4. **é˜²éªšæ‰°æœºåˆ¶** - ä¿æŠ¤ç”¨æˆ·ä½“éªŒ
5. **å†…å®¹å®¡æ ¸æœºåˆ¶** - ä¿è¯å¹³å°å®‰å…¨

### 14.2 æŠ€æœ¯äº®ç‚¹
1. **ç¬¬ä¸‰æ–¹IMé›†æˆ** - ä½¿ç”¨è…¾è®¯äº‘IMï¼Œç®€åŒ–èŠå¤©ç³»ç»Ÿï¼Œæå‡ç¨³å®šæ€§
2. **ç¼“å­˜ç­–ç•¥** - Rediså¤šçº§ç¼“å­˜ï¼Œæå‡æ€§èƒ½
3. **å¼‚æ­¥å¤„ç†** - æ¶ˆæ¯é€šçŸ¥ã€å†…å®¹å®¡æ ¸å¼‚æ­¥åŒ–
4. **åˆ†å¸ƒå¼é”** - é˜²æ­¢ç¼“å­˜å‡»ç©¿
5. **æ¥å£é™æµ** - é˜²æ­¢æ¶æ„è¯·æ±‚
6. **æ•°æ®è„±æ•** - ä¿æŠ¤ç”¨æˆ·éšç§

### 14.3 ä¸‹ä¸€æ­¥å·¥ä½œ
1. **ä»£ç å®ç°** - æŒ‰ç…§æœ¬æ–‡æ¡£è¿›è¡Œå¼€å‘
2. **å•å…ƒæµ‹è¯•** - ä¿è¯ä»£ç è´¨é‡
3. **å‹åŠ›æµ‹è¯•** - éªŒè¯ç³»ç»Ÿæ€§èƒ½
4. **ç°åº¦å‘å¸ƒ** - é€æ­¥ä¸Šçº¿æ–°åŠŸèƒ½
5. **æ•°æ®åˆ†æ** - ç›‘æ§å…³é”®æŒ‡æ ‡ï¼Œä¼˜åŒ–äº§å“

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.1ï¼ˆèŠå¤©æ¨¡å—æ”¹ç”¨ç¬¬ä¸‰æ–¹IMï¼‰  
**ç¼–å†™æ—¥æœŸ**: 2025-01-01  
**æ›´æ–°æ—¥æœŸ**: 2025-11-01  
**é€‚ç”¨ç‰ˆæœ¬**: wxmini-friends 1.0+  
**ä½œè€…**: AI Assistant (Claude Sonnet 4.5)

---

ğŸ“Œ **æ³¨æ„äº‹é¡¹**ï¼š
- æœ¬æ–‡æ¡£å·²ç§»é™¤å­¦å†è®¤è¯ç›¸å…³åŠŸèƒ½
- ä¼šå‘˜åŠŸèƒ½é»˜è®¤å…³é—­ï¼Œé€šè¿‡é…ç½®å¼€å…³æ§åˆ¶
- **èŠå¤©åŠŸèƒ½ä½¿ç”¨è…¾è®¯äº‘IM**ï¼Œéœ€è¦åœ¨è…¾è®¯äº‘æ§åˆ¶å°ç”³è¯·SDKAPPIDå’Œå¯†é’¥
- å‰æœŸå…è´¹é¢åº¦è¶³å¤Ÿä½¿ç”¨ï¼ˆ100ä¸‡DAUä»¥ä¸‹ï¼‰
- æ‰€æœ‰æ¥å£éœ€è¦JWTè®¤è¯ï¼ˆé™¤ç™»å½•æ¥å£ï¼‰
- æ•æ„Ÿä¿¡æ¯éœ€åŠ å¯†å­˜å‚¨
- å®šæœŸå¤‡ä»½æ•°æ®åº“
- åŠæ—¶æ›´æ–°ä¾èµ–ç‰ˆæœ¬ï¼Œä¿®å¤å®‰å…¨æ¼æ´

ğŸ’¡ **å¼€å‘å»ºè®®**ï¼š
- ä¼˜å…ˆå®ç°MVPæ ¸å¿ƒåŠŸèƒ½ï¼ˆåŒ¹é…ã€åŠ¨æ€ã€æ­å­ï¼‰
- èŠå¤©åŠŸèƒ½é›†æˆè…¾è®¯äº‘IM SDKï¼ˆ2-3å¤©å®Œæˆï¼‰
- é…ç½®IMå›è°ƒåœ°å€ç”¨äºé˜²éªšæ‰°æœºåˆ¶
- ä½¿ç”¨Gitè¿›è¡Œç‰ˆæœ¬æ§åˆ¶
- ä»£ç reviewä¿è¯è´¨é‡
- ç¼–å†™è¯¦ç»†çš„æ¥å£æ–‡æ¡£ï¼ˆSwaggerï¼‰
- åšå¥½å¼‚å¸¸å¤„ç†å’Œæ—¥å¿—è®°å½•
- å‰åç«¯è”è°ƒæ—¶ä½¿ç”¨Mockæ•°æ®

ğŸ¯ **èŠå¤©æ¨¡å—å®æ–½æ­¥éª¤**ï¼š
1. åœ¨è…¾è®¯äº‘æ§åˆ¶å°åˆ›å»ºIMåº”ç”¨ï¼Œè·å–SDKAPPIDå’Œå¯†é’¥
2. åç«¯é›†æˆSDKï¼Œå®ç°UserSigç”Ÿæˆå’Œæƒé™æ£€æŸ¥æ¥å£
3. å°ç¨‹åºç«¯é›†æˆtim-wx-sdk
4. é…ç½®IMå›è°ƒåœ°å€ï¼Œå®ç°é˜²éªšæ‰°è®¡æ•°
5. æµ‹è¯•å•èŠã€æ¶ˆæ¯æ¨é€ã€ç¦»çº¿æ¶ˆæ¯ç­‰åŠŸèƒ½

ğŸ¯ **æˆåŠŸæ ‡å‡†**ï¼š
- åŒ¹é…æˆåŠŸç‡ > 30%
- æ—¥æ´»è·ƒç”¨æˆ· > 1000äºº
- ç”¨æˆ·ç•™å­˜ç‡ï¼ˆ7æ—¥ï¼‰ > 40%
- å¹³å‡å“åº”æ—¶é—´ < 500ms
- ç³»ç»Ÿå¯ç”¨æ€§ > 99.9%

---

**æ–‡æ¡£ç»“æŸ**